# --- Base Stage ---
FROM --platform=$BUILDPLATFORM node:18-slim AS base
WORKDIR /app
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN npm install -g pnpm

# --- Dependencies Stage ---
FROM base AS deps
COPY package.json pnpm-lock.yaml* ./
# Gunakan cache terpisah untuk instalasi dependensi
RUN --mount=type=cache,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile --prod=false --ignore-scripts \
    --prefer-offline \
    --fetch-retries=5 \
    --fetch-retry-factor=2 \
    --fetch-retry-mintimeout=10000 \
    --fetch-retry-maxtimeout=120000

# --- Development Stage ---
# Stage ini hanya digunakan untuk pengembangan lokal, tidak akan menjadi image produksi
FROM base AS development
COPY --from=deps /app/node_modules /app/node_modules
COPY . .
RUN npx nuxt prepare && pnpm run build:icons
EXPOSE 3010
CMD ["pnpm", "run", "dev"]

# --- Builder Stage ---
FROM base AS builder
COPY --from=deps /app/node_modules /app/node_modules
COPY . .
ARG NODE_OPTIONS=--max-old-space-size=3072
ARG NUXT_PUBLIC_APP_BASE_URL=https://lpsaring.babahdigital.net
ARG NUXT_PUBLIC_API_BASE_URL=/api
ENV NODE_OPTIONS=${NODE_OPTIONS}
ENV NUXT_PUBLIC_APP_BASE_URL=${NUXT_PUBLIC_APP_BASE_URL}
ENV NUXT_PUBLIC_API_BASE_URL=${NUXT_PUBLIC_API_BASE_URL}
# Gunakan cache untuk build Nuxt/Vite
RUN --mount=type=cache,target=/app/.nuxt \
    --mount=type=cache,target=/app/node_modules/.vite \
    npx nuxt prepare && \
    pnpm run build

# --- Runtime Stage ---
# Tahap final untuk menjalankan aplikasi produksi
FROM gcr.io/distroless/nodejs18-debian12 AS runtime
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/.output ./.output
COPY --from=builder /app/public ./public
EXPOSE 3010
HEALTHCHECK --interval=30s --timeout=5s --start-period=40s --retries=3 CMD ["node", "-e", "fetch('http://127.0.0.1:3010/login').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
CMD [".output/server/index.mjs"]