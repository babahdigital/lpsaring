# ===================================================================
#  Konfigurasi Nginx Final untuk DEVELOPMENT dengan HTTPS
#  - Diverifikasi dan disempurnakan
# ===================================================================

# Mendefinisikan upstream untuk layanan backend dan frontend
# Ini adalah praktik yang baik untuk keterbacaan dan fleksibilitas.
upstream backend_service {
    server backend:5010;
}

upstream frontend_service {
    server frontend:3000;
}

# Server block untuk redirect HTTP (port 80) ke HTTPS (port 443)
# Ini penting untuk keamanan dan SEO.
server {
    listen 80;
    server_name dev.sobigidul.com;

    access_log /var/log/nginx/http-redirect.log;

    # Mengarahkan semua lalu lintas HTTP ke versi HTTPS yang aman
    return 301 https://$host$request_uri;
}

# Server block utama yang melayani aplikasi melalui HTTPS
server {
    listen 443 ssl http2;
    server_name dev.sobigidul.com;

    # Konfigurasi Path Sertifikat SSL
    ssl_certificate /etc/nginx/ssl/sobigidul.fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/sobigidul.key;

    # Protokol SSL/TLS modern yang direkomendasikan
    ssl_protocols TLSv1.2 TLSv1.3;

    # Lokasi file log
    access_log /var/log/nginx/app-access.log;
    error_log /var/log/nginx/app-error.log;

    # Pengaturan umum untuk optimalisasi koneksi
    client_max_body_size 16M;
    keepalive_timeout 65;

    # === LOKASI UNTUK API BACKEND ===
    location /api/ {
        proxy_pass http://backend_service;

        # ---- [ENHANCED IP FORWARDING UNTUK CAPTIVE PORTAL] ----
        # Konfigurasi ini memastikan informasi klien asli diteruskan ke backend.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Additional headers untuk captive portal detection
    proxy_set_header X-Client-IP $remote_addr;
        proxy_set_header X-Original-URI $request_uri;
        
        # Preserve client MAC if sent by captive portal
        proxy_set_header X-Client-MAC $http_x_client_mac;
        
        # Important for real IP detection
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Request-Start $msec;
    }

    # === WebSocket Upgrade Handling for /api/ws ===
    location /api/ws/ {
        proxy_pass http://backend_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Client-IP $remote_addr;
        # Allow larger frames if needed
        proxy_read_timeout 600s;
    }

    # === LOKASI UNTUK APLIKASI FRONTEND ===
    location / {
        proxy_pass http://frontend_service;

        # Konfigurasi ini penting untuk mendukung koneksi WebSocket (digunakan oleh Nuxt HMR)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Teruskan juga header informasi klien ke frontend (berguna untuk SSR)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    }
}