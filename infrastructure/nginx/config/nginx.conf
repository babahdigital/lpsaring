# ===================================================================
# NGINX DISEMPURNAKAN UNTUK PORTAL HOTSPOT LOKAL
# KONFIGURASI FINAL YANG DIOPTIMALKAN - SESUAI STRUKTUR WINDOWS DEV
# ===================================================================

pid             "C:/nginx/logs/nginx.pid";
worker_processes auto;

events {
    worker_connections  1024;
    multi_accept        on;
}

http {
    include       "C:/nginx/conf/mime.types";
    default_type  application/octet-stream;

    # Definisi variabel khusus untuk WebSocket
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    
    # Definisi variabel untuk client IP/MAC dari query args
    map $args $client_ip_from_args {
        "~(?:^|&)ip=([^&]+)" $1;
        default "";
    }
    
    map $args $client_mac_from_args {
        "~(?:^|&)mac=([^&]+)" $1;
        default "";
    }

    # Pengaturan Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" '
                      'client_ip="$client_ip_from_args" client_mac="$client_mac_from_args"';
    access_log "C:/nginx/logs/access.log" main;
    error_log  "C:/nginx/logs/error.log" warn;

    # Pengaturan Kinerja & Keamanan
    sendfile           on;
    tcp_nopush         on;
    tcp_nodelay        on;
    keepalive_timeout  65;
    server_tokens      off;

    # Pengaturan Gzip
    gzip on;
    gzip_comp_level  5;
    gzip_min_length  1024;
    gzip_vary        on;
    gzip_proxied     any;
    gzip_types       text/plain text/css application/json application/javascript text/xml application/xml+rss image/svg+xml;

    # ===================================================================
    # BLOK SERVER
    # ===================================================================

    # Server HTTP: Hanya untuk redirect ke HTTPS dan health check
    server {
        listen       80;
        listen       [::]:80;
        server_name  dev.sobigidul.com localhost;

        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Redirect semua traffic lain ke HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Server HTTPS: Konfigurasi utama aplikasi
    server {
        listen       443 ssl;
        listen       [::]:443 ssl;
        http2        on;
        server_name  dev.sobigidul.com;

        # Konfigurasi SSL
        ssl_certificate     "C:/nginx/ssl/sobigidul.fullchain.pem";
        ssl_certificate_key "C:/nginx/ssl/sobigidul.key";
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 1d;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # Lokasi untuk WebSocket Backend
        location /api/ws/ {
            proxy_pass http://127.0.0.1:5010;
            include    "C:/nginx/conf/proxy_params.conf";
            include    "C:/nginx/conf/proxy_params_ws.conf";
        }
        
        # Lokasi untuk Server-Sent Events (SSE)
        location /api/ws/sse/ {
            proxy_pass    http://127.0.0.1:5010;
            include       "C:/nginx/conf/proxy_params.conf";
            proxy_buffering off;
            add_header    X-Accel-Buffering no;
        }

        # Lokasi untuk semua endpoint API lainnya
        location /api/ {
            proxy_pass http://127.0.0.1:5010;
            include    "C:/nginx/conf/proxy_params.conf";
            # Mencegah caching respons API
            expires -1;
            add_header Cache-Control "no-store, no-cache";
        }

        # Lokasi untuk aset statis dengan caching
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://127.0.0.1:3000;
            include    "C:/nginx/conf/proxy_params.conf";
            proxy_cache_bypass $http_pragma;
            proxy_cache_revalidate on;
            expires 7d;
            add_header Cache-Control "public, max-age=604800, immutable";
            add_header X-Asset-Cache "HIT";
        }
        
        # Lokasi untuk Frontend (Nuxt), termasuk dukungan WS untuk Vite HMR
        location / {
            proxy_pass http://127.0.0.1:3000;
            include    "C:/nginx/conf/proxy_params.conf";
            include    "C:/nginx/conf/proxy_params_ws.conf"; # Diperlukan untuk HMR
            
            # Pengaturan buffer untuk upload file
            client_max_body_size 10M;
            client_body_buffer_size 128k;
            proxy_connect_timeout 90;
            proxy_send_timeout 90;
            proxy_read_timeout 90;
        }
    }
}