# PostgreSQL Configuration optimized untuk Raspberry Pi 4 (4GB RAM)
# Created for hotspot-portal project

# CONNECTIONS AND AUTHENTICATION
max_connections = 100                   # Optimal untuk Raspberry Pi 4
superuser_reserved_connections = 3

# MEMORY SETTINGS
shared_buffers = 256MB                  # 25% dari 1GB allocated to PostgreSQL
work_mem = 4MB                          # Per-operation working memory
maintenance_work_mem = 64MB             # Memory for maintenance operations
effective_cache_size = 1GB              # OS cache estimate

# CHECKPOINTS
checkpoint_completion_target = 0.9      # Spread checkpoint I/O
wal_buffers = 16MB                      # WAL buffer size

# QUERY PLANNING
effective_io_concurrency = 200          # For SSD (if using SSD)
random_page_cost = 1.1                  # Adjust for SSD
default_statistics_target = 100         # Statistics collection

# LOGGING
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_min_duration_statement = 1000       # Log slow queries (>1s)
log_temp_files = 10MB                   # Log temp file usage

# AUTOVACUUM
autovacuum = on
autovacuum_max_workers = 2              # Reduced for Raspberry Pi
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50

# CONNECTION POOLING COMPATIBILITY
listen_addresses = '*'
port = 5432

# LOCALE AND FORMATTING
timezone = 'Asia/Jakarta'
lc_messages = 'en_US.utf8'
lc_monetary = 'id_ID.utf8'
lc_numeric = 'id_ID.utf8'
lc_time = 'id_ID.utf8'

# SECURITY
ssl = off                               # Disable SSL for local development
password_encryption = scram-sha-256

# PERFORMANCE TWEAKS FOR RASPBERRY PI 4
fsync = on                              # Keep on for data safety
synchronous_commit = on                 # Keep on for data safety
temp_buffers = 8MB                      # Temporary buffer size
max_prepared_transactions = 0           # Disable if not using 2PC

# RASPBERRY PI SPECIFIC OPTIMIZATIONS
# Reduce checkpoint frequency to reduce I/O spikes
checkpoint_timeout = 15min              # Longer checkpoint intervals
checkpoint_warning = 30s

# WAL settings for Raspberry Pi SD card/SSD
wal_level = replica                     # Minimal WAL for replication support
max_wal_size = 1GB                      # Reduced from default
min_wal_size = 80MB

# Background writer (reduce I/O spikes)
bgwriter_delay = 200ms                  # Default
bgwriter_lru_maxpages = 100            # Default
bgwriter_lru_multiplier = 2.0          # Default

# Log settings for debugging (development only)
log_destination = 'stderr'
logging_collector = off
log_min_messages = warning
log_min_error_statement = error

# RASPBERRY PI ARM64 OPTIMIZATIONS
shared_preload_libraries = ''           # No extensions by default
dynamic_shared_memory_type = posix

# STATEMENT TIMEOUT (prevent runaway queries)
statement_timeout = 30000               # 30 seconds max per statement
lock_timeout = 10000                    # 10 seconds max for locks
idle_in_transaction_session_timeout = 300000  # 5 minutes

# HOTSPOT PORTAL SPECIFIC
# Optimize for read-heavy workload with occasional writes
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Enable query planner to use more memory for sorting
work_mem = 4MB                          # Repeated for emphasis

# Optimize for small to medium databases
default_statistics_target = 100

# Application-specific settings
application_name = 'hotspot-portal'

# RECOMMENDED EXTENSIONS (uncomment if needed)
# shared_preload_libraries = 'pg_stat_statements'
