## **Dokumentasi Final: Sistem Manajemen Hotspot Proaktif**

Versi: 3.0 (Integrasi Penuh & Logika Lanjutan)  
Tanggal: 2 Juli 2025

Lampiran wajib:
- [.github/copilot-instructions.md](../.github/copilot-instructions.md)

### **1\. Ringkasan Eksekutif**

Dokumentasi ini merincikan arsitektur, konfigurasi, dan logika operasional dari Sistem Manajemen Hotspot Proaktif yang telah kita bangun. Sistem ini mentransformasi portal hotspot tradisional menjadi platform manajemen pelanggan yang cerdas, otomatis, dan aman.

Tujuannya adalah untuk memaksimalkan pengalaman pengguna dan efisiensi operasional dengan mengotomatiskan seluruh siklus hidup pengguna, mulai dari pendaftaran, login, penegakan kebijakan, hingga pembersihan data saat pengguna tidak lagi aktif.

**Fitur Utama yang Telah Diimplementasikan:**

* **Arsitektur Berbasis Kontainer:** Seluruh tumpukan teknologi (Backend, Frontend, Database, Cache, Worker) diatur menggunakan Docker dan Docker Compose untuk portabilitas dan konsistensi lingkungan.  
* **Login & IP Binding Dinamis:** Sistem secara otomatis mengikat sesi login pengguna ke perangkat mereka melalui MAC Address dan IP Address lokal, memungkinkan koneksi ulang tanpa login (bypass). Logika ini telah disempurnakan untuk menangani MAC Address yang dinamis/acak dengan menjadikan nomor telepon pengguna sebagai kunci utama.  
* **"Mesin Penentu Status" Proaktif:** Jantung dari sistem ini adalah sebuah tugas terjadwal (Celery) yang berjalan setiap 5 menit untuk secara otomatis menyinkronkan status setiap pengguna dari database ke profil di MikroTik.  
* **Manajemen Status Komprehensif:** Setiap kondisi pengguna—**aktif, kuota habis, FUP, tidak aktif, dan diblokir**—secara otomatis tercermin pada profil MikroTik mereka, yang secara dinamis mengontrol kecepatan dan akses internet.  
* **Pengalihan (Redirect) Otomatis:** Pengguna yang aksesnya terbatas (misalnya, kuota habis atau diblokir) secara otomatis diarahkan ke halaman informasi yang relevan di portal saat mereka mencoba mengakses internet.  
* **Invalidasi Sesi Real-time:** Keamanan sesi pengguna dijamin dengan pemeriksaan status is\_active dan is\_blocked pada setiap permintaan API, yang secara paksa akan mengeluarkan (logout) pengguna yang sesinya tidak lagi valid.  
* **Siklus Hidup Pengguna yang Bersih:** Logika untuk menonaktifkan dan menghapus pengguna telah disempurnakan untuk memastikan konsistensi dan kebersihan data, baik di database maupun di perangkat MikroTik.

---

### **2\. Arsitektur Sistem & Alur Kerja**

#### **2.1. Komponen Teknologi**

| Kategori | Teknologi | Peran Utama |
| :---- | :---- | :---- |
| **Gateway Jaringan** | MikroTik RouterOS v7+ | Penegak kebijakan jaringan, server Hotspot, IP Binding, Redirect. |
| **Backend** | Python, Flask, SQLAlchemy | Otak sistem, menyediakan API untuk semua logika bisnis. |
| **Pekerja Asinkron** | Celery | Menjalankan tugas latar belakang (sinkronisasi status, notifikasi). |
| **Frontend** | Nuxt.js (Vue.js) | Antarmuka Pengguna (Portal Login, Dashboard, dll.). |
| **Database** | PostgreSQL | Penyimpanan data persisten (pengguna, transaksi, paket). |
| **Cache & Broker** | Redis | Menyimpan OTP dan sebagai perantara pesan untuk Celery. |
| **Infrastruktur** | Docker & Docker Compose | Kontainerisasi seluruh aplikasi untuk isolasi & portabilitas. |
| **Reverse Proxy** | Nginx | Menerima lalu lintas & meneruskannya ke layanan Frontend/Backend. |

#### **2.2. Alur Kerja Inti**

* **Alur Login & IP Binding (Sempurna):**  
  1. Pengguna login dengan OTP melalui portal.  
  2. Backend menerima permintaan dan mendeteksi **IP Lokal Hotspot** pengguna (misalnya 192.168.200.x) dari header X-Forwarded-For.  
  3. Backend menggunakan IP ini untuk menanyakan ke MikroTik (/ip/hotspot/host) dan mendapatkan **MAC Address** perangkat.  
  4. Backend memanggil fungsi create\_or\_update\_ip\_binding dengan **nomor telepon pengguna sebagai comment**.  
  5. Fungsi ini mencari IP Binding yang ada berdasarkan comment.  
     * Jika **ditemukan**, entri tersebut akan **diperbarui** dengan MAC dan IP Address yang baru (solusi untuk MAC acak).  
     * Jika **tidak ditemukan**, entri baru akan **dibuat**.  
  6. Pengguna berhasil login dan perangkatnya kini terikat ke akunnya.  
* **Alur Blokir Pengguna (Sempurna):**  
  1. Admin menekan tombol "Blokir" pada seorang pengguna di panel admin.  
  2. Logika di backend akan mengubah status user.is\_blocked \= True di database.  
  3. "Mesin Penentu Status" (sync\_single\_user\_status) berjalan.  
  4. Ia mendeteksi is\_blocked \= True.  
  5. Tugas ini langsung melakukan dua hal di MikroTik:  
     * Mengubah profil pengguna menjadi **profile-blokir**.  
     * **Menghapus** IP Binding yang terkait dengan pengguna tersebut (berdasarkan comment) untuk memastikan akses bypass dicabut sepenuhnya.  
  6. Di sisi aplikasi, decorator @token\_required pada setiap permintaan API akan memeriksa is\_blocked \= True dan secara otomatis **mengembalikan error 401 Unauthorized**. Frontend akan menangkap error ini dan **memaksa pengguna logout**.  
* **Alur Hapus Pengguna (Sempurna):**  
  1. Super Admin menekan tombol "Hapus" pada seorang pengguna.  
  2. Backend memanggil fungsi purge\_user\_from\_hotspot.  
  3. Fungsi ini akan **membersihkan semua jejak** pengguna di MikroTik secara berurutan:  
     * Menghapus sesi dari /ip/hotspot/active.  
     * Menghapus entri dari /ip/hotspot/host.  
     * Menghapus entri dari /ip/hotspot/ip-binding.  
     * Menghapus entri dari /ip/hotspot/user.  
  4. Setelah pembersihan di MikroTik berhasil, pengguna akan dihapus dari database PostgreSQL.

---

### **3\. Konfigurasi Kunci**

#### **3.1. Konfigurasi MikroTik**

* **Hotspot User Profiles:** Pastikan profil berikut ada di /ip hotspot user profile:  
  * profile-aktif: Untuk pengguna normal.  
  * profile-fup: Untuk pengguna yang terkena FUP.  
  * profile-habis: Untuk pengguna kehabisan kuota. Berisi skrip On Login untuk redirect ke /kuota-habis.  
  * profile-blokir: Untuk pengguna yang diblokir. Berisi skrip On Login untuk redirect ke /akun-diblokir.  
  * profile-unlimited: Pembeda logis untuk paket unlimited.  
  * inactive: (Opsional, karena sudah dinormalisasi) Profil untuk pengguna yang dinonaktifkan.

#### **3.2. Konfigurasi Aplikasi Backend (.env)**

File .env adalah pusat konfigurasi. Pastikan variabel berikut diatur dengan benar:

* PROXYFIX\_X\_FOR=2: Nilai ini **sudah benar** untuk arsitektur Anda yang menggunakan Nginx di dalam Docker dan kemungkinan ngrok di luarnya. Ini memastikan Flask dapat melihat IP Address asli pengguna.  
* MIKROTIK\_PROFILE\_BLOKIR=profile-blokir: Mendefinisikan nama profil yang akan digunakan oleh "Mesin Penentu Status" saat memblokir pengguna.  
* MIKROTIK\_PROFILE\_...: Semua nama profil lain yang digunakan oleh sistem.  
* SYNC\_TEST\_MODE\_ENABLED: Atur ke True untuk pengujian pada nomor spesifik, atau False untuk memberlakukan sinkronisasi ke semua pengguna aktif.

---

### **4\. Implementasi Logika Kunci (Ringkasan Perbaikan)**

* **File:** backend/app/infrastructure/http/decorators.py  
  * **Logika:** Fungsi decorator @token\_required telah disempurnakan.  
  * **Implementasi:** Setelah memvalidasi token JWT, decorator ini sekarang melakukan query ke database untuk mengambil data pengguna terbaru dan secara eksplisit memeriksa if not user.is\_active or user.is\_blocked. Jika kondisi ini terpenuhi, decorator akan mengembalikan error 401 Unauthorized yang memicu logout paksa di frontend.  
* **File:** backend/app/infrastructure/gateways/mikrotik\_client.py  
  * **Logika:** Fungsi create\_or\_update\_ip\_binding telah diubah untuk menggunakan comment (nomor telepon) sebagai kunci pencarian, bukan mac-address, untuk menangani MAC acak.  
  * **Logika Baru:** Dua fungsi baru ditambahkan:  
    1. delete\_ip\_binding\_by\_comment: Untuk menghapus IP Binding saat pengguna diblokir.  
    2. purge\_user\_from\_hotspot: Untuk membersihkan semua jejak pengguna saat dihapus permanen.  
  * **Optimalisasi:** Sebuah fungsi helper \_get\_item\_id ditambahkan untuk mengambil ID item secara andal, mengatasi bug KeyError: '.id'.  
* **File:** backend/app/tasks.py  
  * **Logika:** "Mesin Penentu Status" (sync\_single\_user\_status) telah diperbarui.  
  * **Implementasi:** Kini, jika user.is\_blocked adalah True, fungsi ini akan memanggil delete\_ip\_binding\_by\_comment dari mikrotik\_client.py.  
* **File:** backend/app/services/user\_management/user\_deletion.py  
  * **Logika:** Alur penghapusan oleh Super Admin telah disempurnakan.  
  * **Implementasi:** Sekarang memanggil fungsi baru purge\_user\_from\_hotspot untuk memastikan tidak ada data pengguna yang tersisa di MikroTik.  
* **File:** backend/app/services/user\_management/user\_profile.py  
  * **Logika:** Logika deaktivasi pengguna (ketika admin menekan "nonaktifkan") telah dinormalisasi.  
  * **Implementasi:** Fungsi ini tidak lagi mengatur profil ke inactive secara langsung. Sebaliknya, ia mengatur is\_active \= False dan is\_blocked \= True di database, lalu membiarkan "Mesin Penentu Status" yang menangani sisanya secara konsisten.

### **5\. Kesimpulan**

Sistem Anda kini telah mencapai tingkat kematangan yang tinggi. Alur kerja utama telah terdefinisi dengan jelas, divalidasi, dan diimplementasikan dengan logika yang kuat dan konsisten. Dokumentasi ini merangkum keadaan final dari sistem yang telah kita sempurnakan bersama.
