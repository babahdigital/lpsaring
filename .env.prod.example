# ===============================================================
# ===        TEMPLATE KONFIGURASI PRODUKSI PORTAL HOTSPOT      ===
# ===        (GANTI SEMUA <PLACEHOLDER> SEBELUM DEPLOY)        ===
# ===============================================================

# --- PostgreSQL (WAJIB untuk docker-compose.prod.yml) ---
# docker-compose.prod.yml memakai ${POSTGRES_DB}/${POSTGRES_USER}/${POSTGRES_PASSWORD}
POSTGRES_DB=hotspot_db
POSTGRES_USER=hotspot_user
POSTGRES_PASSWORD=<POSTGRES_PASSWORD>

# --- Database URL (WAJIB untuk backend/migrate/celery di produksi) ---
# Isi dengan nilai eksplisit (dotenv tidak melakukan ekspansi variabel otomatis).
DATABASE_URL=postgresql+psycopg2://hotspot_user:<POSTGRES_PASSWORD>@db:5432/hotspot_db

# --- Flask config class selector ---
# Jika kosong, backend akan memilih berdasarkan FLASK_ENV.
# Disarankan tetap eksplisit untuk menghindari salah konfigurasi.
FLASK_CONFIG=production

# --- Fitur Aplikasi ---
ENABLE_ADMIN_ROUTES=True

# --- Konfigurasi Flask ---
FLASK_APP=run.py
FLASK_ENV=production
FLASK_DEBUG=False
LOG_LEVEL=INFO
LOG_TO_FILE=True
LOG_DIR=logs
LOG_FILENAME=hotspot_portal.log
LOG_MAX_BYTES=10485760
LOG_BACKUP_COUNT=5
LOG_FILE_LEVEL=INFO
LOG_FORMAT_JSON=True

# --- Kunci Keamanan ---
SECRET_KEY=<YOUR_SECRET_KEY_64_HEX>
JWT_SECRET_KEY=<YOUR_JWT_SECRET_KEY>
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRES_MINUTES=30

# --- URL Publik Aplikasi (wajib valid) ---
APP_PUBLIC_BASE_URL=https://lpsaring.babahdigital.net

# --- Redis: OTP ---
REDIS_HOST_OTP=redis
REDIS_PORT_OTP=6379
REDIS_DB_OTP=0
REDIS_PASSWORD_OTP=null
OTP_EXPIRE_SECONDS=300
OTP_REQUEST_COOLDOWN_SECONDS=60
OTP_VERIFY_MAX_ATTEMPTS=5
OTP_VERIFY_WINDOW_SECONDS=300
OTP_FINGERPRINT_ENABLED=True
SESSION_TOKEN_EXPIRE_SECONDS=120

# OTP sukses = device yang sedang dipakai ikut diotorisasi (agar tidak masuk pending-auth saat MAC berubah)
# - True  : user punya kontrol (OTP = self-auth) untuk device/MAC saat login
# - False : kembali ke mode lama (device baru bisa pending-auth sesuai REQUIRE_EXPLICIT_DEVICE_AUTH)
OTP_AUTO_AUTHORIZE_DEVICE=True

# --- Redis: Celery (broker & backend) ---
REDIS_HOST_CELERY_BROKER=redis
REDIS_PORT_CELERY_BROKER=6379
REDIS_DB_CELERY_BROKER=1
REDIS_PASSWORD_CELERY_BROKER=null
REDIS_HOST_CELERY_BACKEND=redis
REDIS_PORT_CELERY_BACKEND=6379
REDIS_DB_CELERY_BACKEND=2
REDIS_PASSWORD_CELERY_BACKEND=null

# --- Redis: Rate-Limiter ---
RATELIMIT_STORAGE_URI=redis://redis:6379/3
RATELIMIT_STRATEGY=fixed-window
RATELIMIT_ENABLED=True
PING_RATE_LIMIT=10 per minute

# --- Anti-spam transaksi (opsional, disarankan) ---
# Batasi endpoint POST /api/transactions/initiate agar tidak membuat banyak order akibat klik/refresh berulang.
INITIATE_TRANSACTION_RATE_LIMIT=3 per minute

# --- Link status pembayaran shareable (public, token `t`) ---
# TTL token untuk link shareable (default aplikasi 7 hari; clamp min 5 menit, max 30 hari)
TRANSACTION_STATUS_TOKEN_MAX_AGE_SECONDS=604800

# Rate limit endpoint public transaksi (pakai token `t`)
PUBLIC_TRANSACTION_STATUS_RATE_LIMIT=60 per minute
PUBLIC_TRANSACTION_QR_RATE_LIMIT=30 per minute
PUBLIC_TRANSACTION_CANCEL_RATE_LIMIT=20 per minute

# --- Midtrans ---
MIDTRANS_SERVER_KEY=<MIDTRANS_SERVER_KEY>
MIDTRANS_CLIENT_KEY=<MIDTRANS_CLIENT_KEY>
MIDTRANS_IS_PRODUCTION=True   # False untuk sandbox
MIDTRANS_HTTP_TIMEOUT_SECONDS=15
MIDTRANS_WEBHOOK_IDEMPOTENCY_TTL_SECONDS=86400

# Prefix order_id (invoice) untuk transaksi user (beli paket).
# Contoh: BD-LPSR -> BD-LPSR-1A2B3C4D5E6F
MIDTRANS_ORDER_ID_PREFIX=BD-LPSR

# Prefix order_id untuk tagihan yang dibuat dari Admin → Users → Buat Tagihan.
# Contoh: BD-LPSR -> BD-LPSR-1A2B3C4D5E6F
ADMIN_BILL_ORDER_ID_PREFIX=BD-LPSR

# Expiry default untuk transaksi baru (menit). Default aplikasi: 15.
MIDTRANS_DEFAULT_EXPIRY_MINUTES=15

# --- WhatsApp Fonnte ---
WHATSAPP_API_URL=https://api.fonnte.com/send
WHATSAPP_VALIDATE_URL=https://api.fonnte.com/validate
WHATSAPP_API_KEY=<WHATSAPP_API_KEY>
ENABLE_WHATSAPP_NOTIFICATIONS=True
WHATSAPP_HTTP_TIMEOUT_SECONDS=15
WHATSAPP_PDF_DOWNLOAD_TIMEOUT_SECONDS=20

# --- MikroTik ---
# Toggle MikroTik operations.
# - True  : backend akan melakukan operasi via API MikroTik (ip-binding, address-list, dll)
# - False : mode "OTP only" (tanpa operasi MikroTik). HATI-HATI: bisa membuat captive portal tidak mengaktifkan akses internet.
ENABLE_MIKROTIK_OPERATIONS=True
MIKROTIK_HOST=<IP-Public/IP-Local>
MIKROTIK_USERNAME=<MIKROTIK_USERNAME>
MIKROTIK_PASSWORD=<MIKROTIK_PASSWORD>
MIKROTIK_PORT=8728
MIKROTIK_DEFAULT_PROFILE=default
MIKROTIK_USE_SSL=False
MIKROTIK_SSL_VERIFY=False
MIKROTIK_PLAIN_TEXT_LOGIN=True
MIKROTIK_SEND_LIMIT_BYTES_TOTAL=True
MIKROTIK_SEND_SESSION_TIMEOUT=True
MIKROTIK_ACTIVE_PROFILE=profile-aktif
MIKROTIK_FUP_PROFILE=profile-fup
MIKROTIK_HABIS_PROFILE=profile-habis
MIKROTIK_UNLIMITED_PROFILE=profile-unlimited
MIKROTIK_EXPIRED_PROFILE=profile-expired
MIKROTIK_BLOCKED_PROFILE=profile-blokir
MIKROTIK_DEFAULT_SERVER_USER=srv-user
MIKROTIK_DEFAULT_SERVER_KOMANDAN=srv-komandan
MIKROTIK_KOMANDAN_PROFILE=profile-aktif
MIKROTIK_ADDRESS_LIST_ACTIVE=klient_aktif
MIKROTIK_ADDRESS_LIST_FUP=klient_fup
MIKROTIK_ADDRESS_LIST_INACTIVE=klient_inactive
MIKROTIK_ADDRESS_LIST_EXPIRED=klient_expired
MIKROTIK_ADDRESS_LIST_HABIS=klient_habis
MIKROTIK_ADDRESS_LIST_BLOCKED=klient_blocked
MIKROTIK_UNAUTHORIZED_CIDRS=['172.16.2.0/23']
MIKROTIK_UNAUTHORIZED_EXEMPT_IPS=['172.16.2.3-7']
IP_BINDING_ENABLED=True
IP_BINDING_TYPE_ALLOWED=bypassed
IP_BINDING_TYPE_BLOCKED=blocked
IP_BINDING_FAIL_OPEN=False
MAX_DEVICES_PER_USER=3
REQUIRE_EXPLICIT_DEVICE_AUTH=True
DEVICE_STALE_DAYS=30
WALLED_GARDEN_ENABLED=True
WALLED_GARDEN_ALLOWED_HOSTS=["<your-portal-domain>","<your-api-domain>"]
WALLED_GARDEN_ALLOWED_IPS=[]
WALLED_GARDEN_MANAGED_COMMENT_PREFIX=lpsaring
WALLED_GARDEN_SYNC_INTERVAL_MINUTES=30

# Sinkronisasi Kuota & Notifikasi
QUOTA_SYNC_INTERVAL_SECONDS=300
# Auto-heal ip-binding type saat sync periodik (disarankan aktif)
# Mencegah mismatch berulang antara expected app policy vs actual ip-binding router.
ENABLE_POLICY_BINDING_SELF_HEAL=True
# Jika auto debt (used - purchased - auto_debt_offset) >= limit ini (MB):
# - app status blocked,
# - profile dipaksa ke MIKROTIK_BLOCKED_PROFILE,
# - address-list dipaksa ke MIKROTIK_ADDRESS_LIST_BLOCKED,
# - ip-binding tetap non-blocked (regular) untuk flow auto debt.
# Set 0 untuk mematikan fitur.
QUOTA_DEBT_LIMIT_MB=500
QUOTA_FUP_THRESHOLD_MB=3072
QUOTA_NOTIFY_REMAINING_MB=[500]
QUOTA_EXPIRY_NOTIFY_DAYS=[7,3,1]
INACTIVE_DEACTIVATE_DAYS=45
INACTIVE_DELETE_DAYS=90
AUTO_ENROLL_DEVICES_FROM_IP_BINDING=True
AUTO_ENROLL_DEBUG_LOG=False

# Audit rekonsiliasi MikroTik harian (disarankan aktif di produksi)
ENABLE_MIKROTIK_AUDIT_RECONCILIATION=True
MIKROTIK_AUDIT_CRON_HOUR=4
MIKROTIK_AUDIT_CRON_MINUTE=15
MIKROTIK_AUDIT_AUTO_CLEANUP_STALE_BLOCKED=False

# OTP bypass (disarankan False di produksi)
OTP_ALLOW_BYPASS=False
OTP_BYPASS_CODE=000000

# Demo mode (opsional, ON/OFF tanpa deploy ulang image)
# Keamanan: bypass hanya untuk nomor whitelist saat DEMO_MODE_ENABLED=True
DEMO_MODE_ENABLED=False
DEMO_ALLOWED_PHONES=[]
DEMO_BYPASS_OTP_CODE=000000
DEMO_SHOW_TEST_PACKAGE=False
DEMO_PACKAGE_IDS=[]

SYNC_ADDRESS_LIST_ON_LOGIN=False

# Dev bypass untuk endpoint /api/users/me/* (production biasanya False)
DEV_BYPASS_USER_ENDPOINTS=False
DEV_BYPASS_USER_PHONE=
DEV_BYPASS_USER_ID=
DEV_BYPASS_TOKEN=

# Proxy & trusted headers
PROXYFIX_X_FOR=1
PROXYFIX_X_PROTO=1
PROXYFIX_X_HOST=0
PROXYFIX_X_PORT=0
PROXYFIX_X_PREFIX=0
TRUST_CF_CONNECTING_IP=False
TRUSTED_PROXY_CIDRS=['127.0.0.1/32','10.0.0.0/8','172.16.0.0/12','192.168.0.0/16']

# Konfigurasi CORS
CORS_ADDITIONAL_ORIGINS=["https://lpsaring.babahdigital.net"]

# --- Link Navigasi Aplikasi (frontend & admin) ---
FRONTEND_URL=https://lpsaring.babahdigital.net
APP_LINK_USER=https://lpsaring.babahdigital.net/login
APP_LINK_ADMIN=https://lpsaring.babahdigital.net/admin
APP_LINK_ADMIN_CHANGE_PASSWORD=https://lpsaring.babahdigital.net/akun

# Auth cookie (HttpOnly)
AUTH_COOKIE_NAME=auth_token
AUTH_COOKIE_HTTPONLY=True
AUTH_COOKIE_SECURE=True
AUTH_COOKIE_SAMESITE=Lax
AUTH_COOKIE_PATH=/
AUTH_COOKIE_DOMAIN=
AUTH_COOKIE_MAX_AGE_SECONDS=1800

# Refresh token (rotating)
REFRESH_TOKEN_EXPIRES_DAYS=30
REFRESH_COOKIE_NAME=refresh_token
REFRESH_COOKIE_HTTPONLY=True
REFRESH_COOKIE_SECURE=True
REFRESH_COOKIE_SAMESITE=Lax
REFRESH_COOKIE_PATH=/
REFRESH_COOKIE_DOMAIN=
REFRESH_COOKIE_MAX_AGE_SECONDS=2592000
REFRESH_TOKEN_RATE_LIMIT=60 per minute

# Rate limit detail
API_RATE_LIMIT=100 per minute
OTP_REQUEST_RATE_LIMIT=5 per minute;20 per hour
OTP_VERIFY_RATE_LIMIT=10 per minute;60 per hour
ADMIN_LOGIN_RATE_LIMIT=10 per minute;60 per hour
REGISTER_RATE_LIMIT=5 per minute;20 per hour
SESSION_CONSUME_RATE_LIMIT=30 per minute
AUTO_LOGIN_RATE_LIMIT=60 per minute

# Cache & circuit breaker
PUBLIC_SETTINGS_CACHE_TTL_SECONDS=300
METRICS_TTL_SECONDS=86400
TASK_DLQ_REDIS_KEY=celery:dlq
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_RESET_SECONDS=60
CIRCUIT_BREAKER_HALF_OPEN_SUCCESS=2

# Zona waktu aplikasi
APP_TIMEZONE=Asia/Makassar
