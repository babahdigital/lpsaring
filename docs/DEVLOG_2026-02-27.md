# Devlog 2026-02-27 (Audit Ulang Git History + Sentralisasi Route Policy/Captive + Sinkronisasi Dokumentasi)

Dokumen ini merangkum audit ulang perubahan terbaru berdasarkan histori Git dan kondisi working tree, serta sinkronisasi dokumentasi setelah refactor route policy/captive.

## 1) Ringkasan Eksekutif

Fokus utama sesi ini:
- Audit ulang histori commit terbaru (`main`) dan seluruh perubahan lokal yang belum di-commit.
- Menyelesaikan sentralisasi route status ke `/policy/*`.
- Menghapus duplikasi halaman status legacy (`/login/*`, `/captive/*`) dari folder `pages`.
- Menyederhanakan flow captive:
  - `captive/terhubung` menjadi aksi tunggal,
  - menutup akses route terbatas saat konteks captive aktif,
  - memusatkan pembelian captive ke `/beli`.
- Menambahkan akses root legal docs (`/privacy`, `/terms`) sebagai alias publik.
- Sinkronisasi dokumentasi teknis agar sesuai implementasi terbaru.

## 2) Audit Histori Git (Commit Terkait)

Commit terbaru yang diaudit:
- `982fc120` — `refactor(frontend): centralize status pages into responsive /policy routes`
- `040e46f6` — `fix(auth): enforce self-authorize on valid OTP and trusted auto-login`
- `8dac127a` — `hardening(device): default disable global MAC claim transfer`
- `f4f15925` — `refactor(sync,debt): add degraded lock fallback and transaction-safe debt settlement`
- `2c071a34` — `fix(auth,contract): harden device takeover flow and align access status parity`

Kesimpulan audit histori:
- Arah perubahan konsisten: hardening policy/auth + parity contract + sentralisasi UX status.
- Refactor frontend terbaru mengikuti baseline ini dengan mengurangi route ganda dan mengunci guard behavior di satu sumber route policy.

## 3) Audit Working Tree (Perubahan Aktif)

Perubahan lokal yang terdeteksi saat audit:
- Middleware/guard:
  - `frontend/middleware/auth.global.ts`
  - `frontend/middleware/status-guard.global.ts`
  - `frontend/utils/authRoutePolicy.ts`
  - `frontend/utils/captiveContext.ts` (baru)
- Route/paging:
  - penghapusan halaman status legacy di:
    - `frontend/pages/login/{blocked,inactive,expired,habis,fup}.vue`
    - `frontend/pages/captive/{blokir,inactive,expired,habis,fup}.vue`
  - `frontend/pages/captive/beli.vue` dihapus (sentralisasi ke `/beli`)
  - `frontend/pages/captive/terhubung.vue` disederhanakan
  - `frontend/pages/privacy.vue` (baru)
  - `frontend/pages/terms.vue` (baru)
- Konfigurasi route:
  - `frontend/nuxt.config.ts` (`routeRules` redirect kompatibilitas)
- Policy/legal/supporting:
  - `frontend/components/policy/PolicyStatusView.vue`
  - `frontend/pages/merchant-center/privacy.vue`
  - `frontend/pages/merchant-center/terms.vue`
  - `frontend/store/auth.ts`
- Tests:
  - `frontend/tests/auth-middleware.runtime.test.ts`
  - `frontend/tests/status-guard.runtime.test.ts`

## 4) Keputusan Arsitektur yang Ditetapkan

### A. Sumber route status tunggal
- Canonical status route: `/policy/*`.
- Route status legacy tidak lagi disimpan sebagai page file, tetapi tetap kompatibel lewat redirect Nuxt (`routeRules`).

### B. Captive context hardening
- Saat user masuk flow captive, sistem menandai `captive_context_active` di `sessionStorage`.
- Dalam context ini, user non-admin dibatasi dari route terbatas (`/dashboard`, `/beli`, `/requests`, `/akun`) dan diarahkan kembali ke flow captive/status sesuai akses.

### C. Pembelian captive dipusatkan
- `captive/beli` tidak lagi memiliki implementasi page sendiri.
- Akses lama ke `/captive/beli` diarahkan ke `/beli` untuk menghindari drift logic.

### D. Legal docs sebagai public root
- `'/privacy'` dan `'/terms'` ditambahkan sebagai alias publik ke legal page utama merchant center.
- Tujuan: URL legal lebih netral dan reusable lintas konteks, bukan hanya merchant-center entrypoint.

## 5) Validasi Teknis

Validasi yang dijalankan saat sesi:
- Fokus test middleware runtime:
  - `tests/auth-middleware.runtime.test.ts`
  - `tests/status-guard.runtime.test.ts`
- Hasil: lulus (`10/10` test).
- Pemeriksaan diagnostics/editor errors pada file yang diubah: tidak ditemukan error.

## 6) Update Dokumentasi yang Dilakukan

Dokumen yang diselaraskan:
- `CHANGELOG.md`
  - Tambah ringkasan perubahan 2026-02-27 (routing policy/captive/legal).
- `docs/ACCESS_STATUS_MATRIX.md`
  - Route mapping diperbarui ke canonical `/policy/*` + catatan legacy redirect.
- `docs/TROUBLESHOOTING_HYDRATION.md`
  - Referensi `captive/beli` diperbarui menjadi konteks historis, fokus aktif ke `/beli`.
- `docs/DEVLOG_2026-02-27.md`
  - Dokumen ini (audit + keputusan + status validasi).

## 7) Catatan Operasional

- Untuk local Docker, variabel frontend dibaca dari root `.env.public` (`docker-compose.yml` service frontend `env_file: ./.env.public`), bukan dari `frontend/.env.public`.
- Jika mengubah `NUXT_PUBLIC_*`, frontend container perlu recreate agar nilai env efektif ter-update.

## 8) Penutup

Status audit ulang:
- Histori commit dan working tree sudah diaudit.
- Refactor route/middleware sudah konsisten dengan arah sentralisasi.
- Dokumentasi utama telah diperbarui agar sinkron dengan implementasi terbaru.
