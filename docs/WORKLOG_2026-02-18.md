# Work Log — 2026-02-18

Dokumen ini melanjutkan work log sebelumnya dan merangkum pekerjaan end-to-end pada proyek **lpsaring** sampai **2026-02-18**: masalah/insiden, akar penyebab, solusi, perubahan yang dilakukan (Git), perubahan operasional (deploy), serta cara verifikasi.

Work log sebelumnya:
- [WORKLOG_2026-02-16.md](WORKLOG_2026-02-16.md)
- [WORKLOG_2026-02-17.md](WORKLOG_2026-02-17.md)

## Ringkas

**Tema utama sesi 2026-02-18**
- UI captive portal diselaraskan dengan halaman login (mobile-friendly, tab Masuk/Daftar).
- Penambahan opsi **“Tamping kunci”** di pendaftaran dan admin edit/add user.
- Hotfix backend untuk mencegah **500** saat admin menyimpan user tamping.
- Deploy produksi “fresh + clean” **tanpa menghapus database volume**.
- Perbaikan ops supaya deploy tidak memicu **build** ulang (khusus cloudflared).
- Perbaikan endpoint **Backup/Restore** yang error 500 karena permission `/app/backups`.

## 1) UI Captive Portal (Mobile) — selaras dengan /login

### Masalah
- Tampilan `/captive` (yang diakses dari redirect MikroTik) tidak konsisten dengan `/login`.
- Di HP, notifikasi/snackbar mengganggu (overlay bertumpuk).
- Pada beberapa device, background “shape” auth tidak rapi di `/captive`.

### Solusi
- Refactor `/captive` agar mengikuti pola `/login`:
  - Tab **Masuk** / **Daftar**.
  - Form daftar yang menampung role (User/Tamping/Komandan) seperti kebutuhan portal.
- Penyederhanaan notifikasi global agar tidak menumpuk dan tidak menutup form.
- Import styling auth yang sama (`page-auth.scss`) supaya layout background shape konsisten.

### Perubahan Git (UI)
- Seri perubahan besar pada [frontend/pages/captive/index.vue](../frontend/pages/captive/index.vue)
  - `424e660b` (refactor besar; insertions/deletions signifikan)
  - `96304c6b` (penyempurnaan UI)
  - `070c93ec` (tambahan kecil untuk merapikan layout; termasuk styling auth)
- Notifikasi global dibersihkan:
  - [frontend/components/layout/SnackbarWrapper.vue](../frontend/components/layout/SnackbarWrapper.vue)
  - [frontend/pages/dashboard/index.vue](../frontend/pages/dashboard/index.vue)
  - commit `1601c339`.

### Verifikasi
- Akses dari MikroTik redirect ke `/captive` pada HP:
  - Tab Masuk/Daftar tampil normal.
  - Form tidak tertutup snackbar.
  - Background shape rapi (konsisten dengan `/login`).

## 2) “Tamping kunci” — konsisten di Login/Captive/Admin

### Masalah
- `/login` dan `/captive` sudah menampilkan “Tamping kunci”, namun admin **Tambah User** & **Edit User** masih pakai daftar statis lama → opsi tidak muncul.
- Setelah admin menyimpan user dengan nilai baru “Tamping kunci”, backend sempat mengembalikan 500 (lihat bagian #3).

### Solusi (Frontend)
- Daftar jenis tamping dipusatkan di satu konstanta agar tidak perlu edit banyak file jika ada perubahan.

File kunci:
- [frontend/utils/constants.ts](../frontend/utils/constants.ts)
  - `TAMPING_TYPES`
  - `TAMPING_OPTION_ITEMS`

Pemakaian terpusat:
- `/login`: [frontend/pages/login/index.vue](../frontend/pages/login/index.vue)
- `/captive`: [frontend/pages/captive/index.vue](../frontend/pages/captive/index.vue)
- Admin add/edit:
  - [frontend/components/admin/users/UserAddDialog.vue](../frontend/components/admin/users/UserAddDialog.vue)
  - [frontend/components/admin/users/UserEditDialog.vue](../frontend/components/admin/users/UserEditDialog.vue)

Commit utama:
- `dc201dcc` (sentralisasi daftar jenis tamping dan sinkronisasi pemakaian di 4 tempat).

### Solusi (Backend validator)
- Backend `TAMPING_TYPES` (auth schema) ditambah “Tamping kunci” agar request tidak ditolak validator.
- Commit: `a714048e`.

### Verifikasi
- Admin panel:
  - Edit user tamping → dropdown “Jenis Tamping” berisi “Tamping kunci”.
  - Add user tamping → dropdown sama.
- Login/captive:
  - Form Daftar role Tamping → dropdown berisi “Tamping kunci”.

## 3) Insiden 500 saat Admin simpan user tamping

### Gejala
Console browser:
- `PUT /api/admin/users/<uuid>` → 500.

### Akar penyebab (dari log backend)
Update DB sukses (COMMIT), namun response gagal dibentuk karena:
- `UserResponseSchema.from_orm(updated_user)` memvalidasi `tamping_type` memakai daftar lama (tidak mengandung “Tamping kunci”).
- Pydantic melempar `ValidationError` → route menangkap sebagai Exception generik → 500.

### Solusi
Perbaikan dilakukan dengan 2 prinsip:
1) **Schema response tidak boleh memicu 500** hanya karena ada nilai string baru/legacy di DB.
2) **Validasi ketat dilakukan pada schema request**, bukan response.

Perubahan utama:
- Response: `tamping_type` di `UserBaseSchema` dibuat tolerant (trim string; tidak memaksa harus ada dalam allowlist).
- Request: allowlist `tamping_type` dipusatkan dari `TAMPING_TYPES` (auth schema), sehingga konsisten.

Commit:
- `44bdebb5` — fix utama admin edit user & hindari 500.
- `fb71166f` — perapihan schema agar Pylance tidak error (Pydantic v2: `example=` → `examples=[...]`).

### Verifikasi
- Admin edit user tamping:
  - Set `tamping_type = "Tamping kunci"` → response 200.
  - Reload list user/admin detail tidak error.

## 4) Deploy produksi “fresh + clean” tanpa hapus DB

### Tujuan
- “Fresh” = semua container direcreate dari image terbaru.
- “Clean” = bersihkan images/containers/cache yang tidak dipakai.
- **Database tidak boleh hilang**.

### Prinsip aman
- Jangan pakai `docker compose down -v`.
- Jangan pakai `docker volume prune`.

### Checklist verifikasi setelah deploy
- `docker compose ... ps` semua service up.
- Healthcheck internal:
  - dari container nginx: `wget -qO- http://127.0.0.1/api/ping` harus balas `pong`.
- Volume tetap ada:
  - `hotspot-portal-prod_postgres_prod_data`
  - `hotspot-portal-prod_redis_prod_data`

## 5) Deploy tanpa build ulang (cloudflared)

### Masalah
Walau backend/frontend sudah pakai `image: ...:latest`, service `cloudflared` sebelumnya masih `build:` sehingga pada deploy fresh+clean bisa terjadi build ulang.

### Solusi
- Produksi compose diubah agar `cloudflared` memakai image resmi multi-arch:
  - `image: cloudflare/cloudflared:latest`

Commit:
- `52a13ab8`.

### Catatan operasional
Di server produksi, folder `/home/abdullah/sobigidul` bukan repository git (tidak ada `.git`), sehingga perubahan compose tidak bisa `git pull`.
- Untuk memastikan runtime sesuai perubahan Git, compose di server perlu disinkronkan lewat mekanisme deploy (tar/rsync) atau menjadikan folder produksi sebagai clone git.

## 6) Insiden Backup/Restore 500 (Permission denied)

### Gejala
Admin backup page:
- `POST /api/admin/backups` → 500.

### Akar penyebab (dari log backend)
`pg_dump` gagal menulis output file:
- `could not open output file "/app/backups/backup_*.dump": Permission denied`

Temuan runtime:
- Host bind-mount `./backend/backups:/app/backups` ber-owner `root:root` dan mode tidak writable.
- Container backend berjalan sebagai user non-root `appuser` (uid 999) → tidak bisa menulis.

### Solusi cepat (di server)
- Perbaiki ownership/permission directory backups sehingga uid 999 bisa write.
- Setelah itu `pg_dump` manual test berhasil.

### Solusi permanen (di compose prod)
- Tambahkan service init `backups_init` yang:
  - berjalan sebagai root,
  - memastikan `/app/backups` dibuat dan di-`chown/chmod` ke `999:999`.
- Backend dibuat depend on `backups_init` selesai sukses.

Commit:
- `3e4152ba`.

### Verifikasi
- Dalam container backend:
  - `touch /app/backups/.perm_test` sukses.
  - `pg_dump ... -f /app/backups/xxx.dump` sukses.
- Dari UI Admin:
  - Tombol “Backup” sukses membuat file dan muncul di daftar backup.

---

## Appendix A — Commit penting (2026-02-13 s.d. 2026-02-18)

Berikut commit yang paling relevan untuk perubahan 2026-02-18 (urut terbaru → lama):

- `3e4152ba` fix(prod): init backups dir permissions for pg_dump
- `52a13ab8` chore(prod): use official cloudflared image to avoid builds
- `fb71166f` chore(schemas): use Field examples for pydantic v2
- `44bdebb5` fix(admin): allow tamping kunci and avoid 500 on user response schema
- `dc201dcc` (frontend) sentralisasi jenis tamping (login/captive/admin add+edit)
- `070c93ec` (frontend captive) penyempurnaan layout (minor)
- `a714048e` add “Tamping kunci” ke backend validator + login/captive
- `96304c6b` (frontend captive) penyempurnaan UI
- `424e660b` (frontend captive) refactor besar: selaraskan captive vs login

Daftar commit lengkap periode ini bisa dilihat dengan:
```bash
git log --since="2026-02-13" --oneline --decorate
```
