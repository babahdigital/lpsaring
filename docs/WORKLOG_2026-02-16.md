# Work Log — 2026-02-16

Dokumen ini merangkum pekerjaan end-to-end yang sudah dilakukan pada proyek **lpsaring** (hotspot portal) beserta masalah/insiden yang ditemui dan perbaikannya.

> Catatan: File ini fokus pada perubahan teknis dan operasional. Detail incident publish frontend sudah ada di docs/CI_INCIDENT_2026-02-14_FRONTEND_PUBLISH.md.

## Ringkas

**Target utama yang dikerjakan**
- Stabilisasi deploy produksi di Raspberry Pi (docker compose) + publish image multi-arch.
- Perbaikan flow OTP + device authorization agar user tidak “keblokir” setelah OTP sukses.
- Konsistensi & sinkronisasi komentar MikroTik (ip-binding & firewall address-list) agar searchable pakai nomor telepon.
- Mengatasi insiden Cloudflare 502 (tunnel/origin unreachable).
- Perbaikan endpoint admin yang memicu 500 (`itemsPerPage=-1`).
- Menambahkan tooling (CLI) untuk recovery/sync MikroTik pada kasus-kasus data legacy.
- Merapikan standar env (template public/local) + menambah rate limit WhatsApp berbasis Redis.

## Perubahan Fungsional (Backend)

### 1) OTP login + binding perangkat
**Masalah**
- OTP sukses tetapi internet belum terbuka: biasanya karena sinkronisasi MikroTik (ip-binding/address-list) tidak kena ke IP lokal yang benar, atau device masih status pending.

**Perbaikan yang dilakukan**
- OTP sukses bisa melewati explicit device authorization (best-effort), sehingga tidak terjebak pada status pending-auth untuk jalur OTP.
- Jalur ADMIN/SUPER_ADMIN ikut jalur binding agar akses tidak terputus.
- Saat login, backend melakukan sync address-list untuk user dengan IP yang berhasil di-resolve.

**Catatan penting jaringan**
- Akses halaman `/login` lewat domain publik (Cloudflare) wajar hanya melihat IP publik/proxy. IP lokal 172.16.x.x harus didapat via:
  1) parameter captive portal (client_ip/client_mac), atau
  2) lookup ke MikroTik menggunakan data device (MAC) / hotspot session.

### 2) Admin endpoint `/api/admin/users` (UI 500)
**Masalah**
- Admin UI memanggil `/api/admin/users?itemsPerPage=-1` sehingga backend error 500.

**Perbaikan**
- `itemsPerPage=-1` diperlakukan sebagai non-paginated (ambil semua) atau minimal tidak error.

### 3) Blocking / inactive / expired / habis → address-list harus terbentuk
**Masalah**
- Untuk beberapa user, perubahan status (inactive/blocked/expired/habis) tidak menghasilkan entry address-list karena sinkronisasi terlalu bergantung pada IP sesi aktif.

**Perbaikan**
- Ditambahkan fallback: jika IP tidak ditemukan, coba ambil dari map ip-binding MikroTik (berdasarkan uid/user_id yang ada di comment), lalu upsert address-list dan bersihkan list lain.

### 4) Standarisasi comment MikroTik (searchable by phone)
**Tujuan**
- Komentar ip-binding & address-list harus bisa dicari cepat via nomor telepon format lokal `08...`.

**Kebijakan format**
- ip-binding: `authorized|user=<08..>|uid=<uuid>|role=...|date=...|time=...`
- address-list: `lpsaring|status=<active|fup|habis|expired|blocked|inactive|unlimited>|user=<08..>|role=...|ip=...|date=...|time=...`

**Tooling**
- CLI `sync-mikrotik-comments` untuk migrasi massal comment.
- CLI memperbaiki legacy comment yang masih mengandung `user_id=...|phone=...` dengan cara parse comment + coercion UUID + phone variations.

### 5) Recovery tooling: `sync-mikrotik-access`
**Masalah**
- Kasus user sudah OTP tetapi akses belum kebuka untuk IP tertentu (mis. IP lokal diketahui admin, tetapi tidak otomatis tersync).

**Solusi**
- Ditambahkan CLI `sync-mikrotik-access` untuk paksa sync berdasarkan IP lokal.
- Mendukung `--phone` override supaya bisa force sync ke user tertentu meskipun device lookup DB belum lengkap.

### 6) Admin/SuperAdmin update nomor telepon user
**Masalah**
- Dibutuhkan fitur admin untuk mengganti nomor telepon user.

**Solusi**
- Admin/SuperAdmin bisa update `phone_number` dengan validasi:
  - normalisasi nomor,
  - harus unik,
  - best-effort sync MikroTik (update username baru, delete username lama).

### 7) Akurasi audit login history IP
**Masalah**
- Riwayat login sering tercatat IP publik/proxy (misleading untuk audit hotspot).

**Solusi**
- Login history sekarang menyimpan `resolved_ip` (prioritas IP lokal dari captive/MikroTik) jika ada.
- Jika yang terlihat hanya IP publik/proxy dan tidak bisa resolve IP lokal, login history menyimpan `None` (lebih baik kosong daripada salah).

## Perubahan Operasional (Deploy / Cloudflare)

### 1) Insiden Cloudflare 502 (Host Error)
**Gejala**
- Cloudflare 502: tunnel tidak bisa reach origin.

**Akar masalah**
- `cloudflared` tidak bisa resolve hostname origin (alias network service nginx belum ada).
- Token tunnel kosong karena compose interpolation tidak membaca dari `env_file`.

**Perbaikan**
- Tambah alias network untuk nginx (origin dapat di-resolve dari cloudflared).
- Pastikan `CLOUDFLARED_TUNNEL_TOKEN` di-inject via environment compose yang benar.

### 2) Perapihan warning `.env tidak ditemukan` di container
- Di production compose, `.env.prod` dimount ke `/app/.env` (read-only) agar loader dotenv tidak mengeluarkan warning.

## WhatsApp (Fonnte)

### Kondisi awal
- Ada random delay pengiriman + circuit breaker.
- Rate limit endpoint HTTP (OTP request/verify) sudah ada via Flask-Limiter + Redis.

### Perbaikan
- Ditambahkan rate limit WhatsApp berbasis Redis (global + per-target/nomor) untuk mengurangi risiko spam saat ada event/loop.

Config baru (default)
- `WHATSAPP_RATE_LIMIT_ENABLED=True`
- `WHATSAPP_RATE_LIMIT_WINDOW_SECONDS=60`
- `WHATSAPP_RATE_LIMIT_PER_TARGET=3`
- `WHATSAPP_RATE_LIMIT_GLOBAL=120`

## Standarisasi env (public vs local)

### Temuan
- `backend/.env.local` dan `backend/.env.public` sebelumnya berisi set key yang sama (redundant) dan `.env.public` mengandung secret (misleading).

### Perbaikan
- Ditambahkan template:
  - `backend/.env.local.example` (secret)
  - `backend/.env.public.example` (non-secret)
  - `frontend/.env.local.example` (local)
  - `frontend/.env.public.example` (public)

- `backend/.env.public` di-sanitize agar hanya berisi non-secret knobs.
- `.env.prod` dibersihkan dari key redundant (`DB_ENGINE/DB_DRIVER/REDIS_HOST/REDIS_PORT/REDIS_PASSWORD`) dan ditambah knob rate limit WhatsApp.

## Daftar commit terbaru (ringkas)
- Add frontend env templates (public vs local)
- Add backend env templates (public vs local)
- WhatsApp: add Redis rate limiting to prevent spam
- Prod compose: mount .env.prod as /app/.env
- Auth: record resolved hotspot IP in login history
- Admin can update user phone number (with MikroTik sync)
- sync-mikrotik-access: allow --phone override
- Fix captive client identity parsing + add MikroTik access sync CLI

## Open items / catatan lanjut
- Deploy/push ke GitHub Actions membutuhkan konektivitas ke GitHub dari workstation yang digunakan untuk push.
- Setelah image terbaru terdeploy di Pi, jalankan recovery `sync-mikrotik-access` untuk IP yang bermasalah.
- Jika perlu audit lebih dalam: tarik log `Verify-OTP binding context` (aktifkan `LOG_BINDING_DEBUG=True`) dan korelasikan dengan entri MikroTik `/ip/hotspot/host` dan `/ip/hotspot/ip-binding`.
