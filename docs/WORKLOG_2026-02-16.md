# Work Log — 2026-02-16

Dokumen ini merangkum pekerjaan end-to-end yang sudah dilakukan pada proyek **lpsaring** (hotspot portal) beserta masalah/insiden yang ditemui dan perbaikannya.

Lampiran wajib:
- [.github/copilot-instructions.md](../.github/copilot-instructions.md)

> Catatan: File ini fokus pada perubahan teknis dan operasional. Detail incident publish frontend sudah ada di docs/CI_INCIDENT_2026-02-14_FRONTEND_PUBLISH.md.

## Ringkas

**Target utama yang dikerjakan**
- Stabilisasi deploy produksi di Raspberry Pi (docker compose) + publish image multi-arch.
- Perbaikan flow OTP + device authorization agar user tidak “keblokir” setelah OTP sukses.
- Konsistensi & sinkronisasi komentar MikroTik (ip-binding & firewall address-list) agar searchable pakai nomor telepon.
- Mengatasi insiden Cloudflare 502 (tunnel/origin unreachable).
- Perbaikan endpoint admin yang memicu 500 (`itemsPerPage=-1`).
- Menambahkan tooling (CLI) untuk recovery/sync MikroTik pada kasus-kasus data legacy.
- Merapikan standar env (template public/local) + menambah rate limit WhatsApp berbasis Redis.

## Perubahan Fungsional (Backend)

### 1) OTP login + binding perangkat
**Masalah**
- OTP sukses tetapi internet belum terbuka: biasanya karena sinkronisasi MikroTik (ip-binding/address-list) tidak kena ke IP lokal yang benar, atau device masih status pending.

**Perbaikan yang dilakukan**
- OTP sukses bisa melewati explicit device authorization (best-effort), sehingga tidak terjebak pada status pending-auth untuk jalur OTP.
- Jalur ADMIN/SUPER_ADMIN ikut jalur binding agar akses tidak terputus.
- Saat login, backend melakukan sync address-list untuk user dengan IP yang berhasil di-resolve.

**Catatan penting jaringan**
- Akses halaman `/login` lewat domain publik (Cloudflare) wajar hanya melihat IP publik/proxy. IP lokal 172.16.x.x harus didapat via:
  1) parameter captive portal (client_ip/client_mac), atau
  2) lookup ke MikroTik menggunakan data device (MAC) / hotspot session.

### 2) Admin endpoint `/api/admin/users` (UI 500)
**Masalah**
- Admin UI memanggil `/api/admin/users?itemsPerPage=-1` sehingga backend error 500.

**Perbaikan**
- `itemsPerPage=-1` diperlakukan sebagai non-paginated (ambil semua) atau minimal tidak error.

### 3) Blocking / inactive / expired / habis → address-list harus terbentuk
**Masalah**
- Untuk beberapa user, perubahan status (inactive/blocked/expired/habis) tidak menghasilkan entry address-list karena sinkronisasi terlalu bergantung pada IP sesi aktif.

**Perbaikan**
- Ditambahkan fallback: jika IP tidak ditemukan, coba ambil dari map ip-binding MikroTik (berdasarkan uid/user_id yang ada di comment), lalu upsert address-list dan bersihkan list lain.

### 4) Standarisasi comment MikroTik (searchable by phone)
**Tujuan**
- Komentar ip-binding & address-list harus bisa dicari cepat via nomor telepon format lokal `08...`.

**Kebijakan format**
- ip-binding: `authorized|user=<08..>|uid=<uuid>|role=...|date=...|time=...`
- address-list: `lpsaring|status=<active|fup|habis|expired|blocked|inactive|unlimited>|user=<08..>|role=...|ip=...|date=...|time=...`

**Tooling**
- CLI `sync-mikrotik-comments` untuk migrasi massal comment.
- CLI memperbaiki legacy comment yang masih mengandung `user_id=...|phone=...` dengan cara parse comment + coercion UUID + phone variations.

### 5) Recovery tooling: `sync-mikrotik-access`
**Masalah**
- Kasus user sudah OTP tetapi akses belum kebuka untuk IP tertentu (mis. IP lokal diketahui admin, tetapi tidak otomatis tersync).

**Solusi**
- Ditambahkan CLI `sync-mikrotik-access` untuk paksa sync berdasarkan IP lokal.
- Mendukung `--phone` override supaya bisa force sync ke user tertentu meskipun device lookup DB belum lengkap.

### 6) Admin/SuperAdmin update nomor telepon user
**Masalah**
- Dibutuhkan fitur admin untuk mengganti nomor telepon user.

**Solusi**
- Admin/SuperAdmin bisa update `phone_number` dengan validasi:
  - normalisasi nomor,
  - harus unik,
  - best-effort sync MikroTik (update username baru, delete username lama).

### 7) Akurasi audit login history IP
**Masalah**
- Riwayat login sering tercatat IP publik/proxy (misleading untuk audit hotspot).

**Solusi**
- Login history sekarang menyimpan `resolved_ip` (prioritas IP lokal dari captive/MikroTik) jika ada.
- Jika yang terlihat hanya IP publik/proxy dan tidak bisa resolve IP lokal, login history menyimpan `None` (lebih baik kosong daripada salah).

## Perubahan Operasional (Deploy / Cloudflare)

### 1) Insiden Cloudflare 502 (Host Error)
**Gejala**
- Cloudflare 502: tunnel tidak bisa reach origin.

**Akar masalah**
- `cloudflared` tidak bisa resolve hostname origin (alias network service nginx belum ada).
- Token tunnel kosong karena compose interpolation tidak membaca dari `env_file`.

**Perbaikan**
- Tambah alias network untuk nginx (origin dapat di-resolve dari cloudflared).
- Pastikan `CLOUDFLARED_TUNNEL_TOKEN` di-inject via environment compose yang benar.

### 2) Perapihan warning `.env tidak ditemukan` di container
- Di production compose, `.env.prod` dimount ke `/app/.env` (read-only) agar loader dotenv tidak mengeluarkan warning.

## WhatsApp (Fonnte)

### Kondisi awal
- Ada random delay pengiriman + circuit breaker.
- Rate limit endpoint HTTP (OTP request/verify) sudah ada via Flask-Limiter + Redis.

### Perbaikan
- Ditambahkan rate limit WhatsApp berbasis Redis (global + per-target/nomor) untuk mengurangi risiko spam saat ada event/loop.

Config baru (default)
- `WHATSAPP_RATE_LIMIT_ENABLED=True`
- `WHATSAPP_RATE_LIMIT_WINDOW_SECONDS=60`
- `WHATSAPP_RATE_LIMIT_PER_TARGET=3`
- `WHATSAPP_RATE_LIMIT_GLOBAL=120`

---

## Addendum — Session Persisten (Refresh Token) + E2E Lokal (tanpa ganggu dev)

Bagian ini merangkum pekerjaan sesi ini dari awal sampai akhir untuk target utama:
- User tidak perlu OTP ulang setelah browser ditutup selama refresh cookie masih valid.
- E2E dijalankan lokal dengan port berbeda (tidak bentrok dev).

### Keputusan desain
- Pola **access token pendek + refresh token panjang (rotating)**.
- Access token disimpan di cookie `auth_token` (HttpOnly).
- Refresh token disimpan di cookie `refresh_token` (HttpOnly) dan di-rotate (single-use) via tabel DB `refresh_tokens`.

### Error yang ditemui & cara menyelesaikannya

1) **Port bentrok saat E2E**
- Akar: E2E awal sempat digabung (merge) dengan `docker-compose.yml` sehingga port dev ikut terbuka.
- Solusi: `docker-compose.e2e.yml` dibuat **standalone** dengan port non-bentrok:
  - Nginx: `8089`
  - Backend: `5011`
  - Frontend: `3011`

2) **DB credential E2E tidak konsisten**
- Akar: env host bisa meng-override `POSTGRES_*` lewat interpolation compose.
- Solusi: di `docker-compose.e2e.yml`, `POSTGRES_DB/USER/PASSWORD` dibuat deterministik untuk E2E.

3) **Volume cache font menyebabkan container gagal start**
- Gejala: error docker `file exists` pada folder cache.
- Solusi: mount volume cache font di E2E dihapus (tidak wajib untuk validasi flow auth).

4) **SQLAlchemy mapper gagal: `UserDevice(user_devices) has no property 'user'`**
- Akar: field relationship `user` dan `deauthorized_at` salah tempat (nyangkut di model lain), menyebabkan registry mapper gagal.
- Solusi: perbaiki `backend/app/infrastructure/db/models.py`:
  - `UserDevice.user` kembali ada dan `back_populates="devices"` sinkron dengan `User.devices`.
  - `deauthorized_at` berada di `UserDevice` (sesuai migration `20260209_add_user_devices`).

5) **PowerShell `Invoke-WebRequest` prompt (UseBasicParsing) + cookie tidak terbaca**
- Akar: `Invoke-WebRequest` bisa memunculkan prompt interaktif dan sesi cookie tidak stabil untuk uji refresh-token.
- Solusi: pakai `-UseBasicParsing` + `WebSession` untuk menangkap `Set-Cookie`.

6) **Validasi refresh-token sempat gagal (refresh-only session 401)**
- Akar: test client membuat cookie dengan attribute `domain=localhost` sehingga tidak terkirim.
- Solusi: gunakan host-only cookie (tanpa domain attribute) untuk simulasi "browser ditutup".

### Validasi akhir
- E2E lokal berhasil sampai selesai (seed DB, create admin, register/approve user, status pages, mock Midtrans webhook).
- Cookie `refresh_token` terbit dari `/api/auth/verify-otp`.
- Refresh-only session (hanya bawa `refresh_token`) bisa akses endpoint protected dan server mengeluarkan `Set-Cookie auth_token` baru.

Lihat panduan: `docs/E2E_LOCAL_SIMULATION.md`.

## Standarisasi env (public vs local)

### Temuan
- `backend/.env.local` dan `backend/.env.public` sebelumnya berisi set key yang sama (redundant) dan `.env.public` mengandung secret (misleading).

### Perbaikan
- Ditambahkan template:
  - `backend/.env.local.example` (secret)
  - `backend/.env.public.example` (non-secret)
  - `frontend/.env.local.example` (local)
  - `frontend/.env.public.example` (public)

- `backend/.env.public` di-sanitize agar hanya berisi non-secret knobs.
- `.env.prod` dibersihkan dari key redundant (`DB_ENGINE/DB_DRIVER/REDIS_HOST/REDIS_PORT/REDIS_PASSWORD`) dan ditambah knob rate limit WhatsApp.

## Daftar commit terbaru (ringkas)
- Add frontend env templates (public vs local)
- Add backend env templates (public vs local)
- WhatsApp: add Redis rate limiting to prevent spam
- Prod compose: mount .env.prod as /app/.env
- Auth: record resolved hotspot IP in login history
- Admin can update user phone number (with MikroTik sync)
- sync-mikrotik-access: allow --phone override
- Fix captive client identity parsing + add MikroTik access sync CLI

## Open items / catatan lanjut
- Deploy/push ke GitHub Actions membutuhkan konektivitas ke GitHub dari workstation yang digunakan untuk push.
- Setelah image terbaru terdeploy di Pi, jalankan recovery `sync-mikrotik-access` untuk IP yang bermasalah.
- Jika perlu audit lebih dalam: tarik log `Verify-OTP binding context` (aktifkan `LOG_BINDING_DEBUG=True`) dan korelasikan dengan entri MikroTik `/ip/hotspot/host` dan `/ip/hotspot/ip-binding`.

---

## Addendum — OTP-only E2E simulation + phone normalization + dev compose (sesi ini)

Bagian ini adalah ringkasan lengkap dari pekerjaan pada sesi ini (percakapan Copilot) yang fokus pada:
- E2E simulation berbasis **OTP-only** (tanpa kirim OTP nyata/WA dan tanpa baca OTP dari Redis).
- Tetap bisa mensimulasikan alur captive (IP/MAC), termasuk opsi memakai MikroTik API untuk resolve MAC→IP dan apply kuota/profile.
- Perbaikan mismatch environment MikroTik (env ada di file tapi tidak terbaca di container).
- Normalisasi nomor telepon konsisten (Indonesia + internasional E.164) + kompatibilitas payload frontend.
- Membuat mode dev yang mendukung **mount source backend** (tanpa rebuild image setiap perubahan).

### Target & definisi (yang dipakai saat implementasi)
- **OTP-only** = verifikasi OTP lewat endpoint `verify-otp` dengan bypass code (dev), tanpa:
  - `/api/auth/request-otp` (tidak generate & tidak kirim)
  - baca OTP dari Redis
  - ketergantungan WhatsApp gateway
- **Tanpa login hotspot user MikroTik** = tidak pernah membutuhkan username/password hotspot untuk “login internet”; tetapi:
  - operasi MikroTik API boleh dipakai untuk binding/resolve MAC↔IP dan apply policy, jika `ENABLE_MIKROTIK_OPERATIONS=True`.

### Error/masalah yang ditemui dan penyelesaiannya

1) **“MikroTik config missing” padahal `backend/.env.local` berisi `MIKROTIK_*`**
- Gejala: backend di container menganggap `MIKROTIK_HOST/USER/PASSWORD/...` tidak ada.
- Akar masalah: `docker-compose.yml` dev awalnya hanya memuat `.env.public` (root) sehingga `backend/.env.local` tidak ikut masuk ke environment container.
- Solusi:
  - Update `env_file` pada service `backend`, `migrate`, `celery_worker`, `celery_beat` agar memuat `./backend/.env.local`.
  - Hasil: variabel MikroTik tersedia saat runtime di container.

2) **Pylance error: “No parameter named admin_id/target_user_id/action_type/details”**
- Gejala: Pylance `reportCallIssue` saat membuat instance model SQLAlchemy declarative dengan keyword args.
- Solusi: ganti pola pembuatan model menjadi:
  - `log = AdminActionLog(); log.admin_id = ...; ...` (set attribute satu per satu)
  - Ini menjaga runtime tetap sama, tapi menghilangkan false-positive type checker.

3) **E2E script: false negative check karena base URL frontend vs backend**
- Gejala: script menunggu readiness frontend dengan route yang sebenarnya tidak ada di upstream yang dicek.
- Solusi: perbaiki logika deteksi/wait base URL agar mengecek endpoint yang benar via Nginx.

4) **E2E script rerun issues (state leftover)**
- Gejala: user menjadi inactive/blocked dari run sebelumnya, atau request Komandan sudah ada.
- Solusi:
  - Tambahkan “force activation” via DB (idempotent) untuk memastikan rerun tidak buntu.
  - Toleransi “request already exists” untuk flow Komandan.

5) **Nomor telepon: input 08… tidak ketemu user yang tersimpan +62…**
- Gejala: beberapa endpoint memakai `filter_by(phone_number=phone_number)` sehingga input format berbeda tidak match.
- Solusi:
  - Pakai `get_phone_number_variations()` pada lookup.
  - Tambah mapping payload `phoneNumber` → `phone_number` untuk kompatibilitas frontend.

6) **Frontend unit test gagal: Vitest/jsdom require ESM**
- Gejala (container frontend):
  - `Error: require() of ES Module ... not supported` saat Vitest environment `jsdom` startup.
- Solusi:
  - Karena test yang ada hanya test util non-DOM (formatters), ubah default environment Vitest ke `node`.
  - Setelah itu `pnpm test` kembali hijau.

### Validasi (tests yang dijalankan)
- Backend: `docker compose exec -T backend pytest -q` → **pass**.
- Frontend: `docker compose exec -T frontend pnpm -s test` → **pass** (setelah environment Vitest diganti ke `node`).

### File yang diubah (ringkas) dan tujuannya

#### E2E simulation (OTP-only + captive context)
- `scripts/simulate_end_to_end.ps1`
  - Mengubah E2E flow agar OTP bypass-only (tanpa request OTP / Redis OTP) + optional MikroTik ops.
  - Menambahkan normalisasi nomor telepon di script agar request konsisten (08 → +62).
  - Menambah guard untuk rerun (idempotency) dan step debug binding.

#### Docker Compose dev: env + MikroTik + mount
- `docker-compose.yml`
  - Memastikan service backend/celery memuat `./backend/.env.local` (secrets/override) selain `.env.public`.
- `docker-compose.dev.yml`
  - Override dev untuk mount `./backend:/app` + gunicorn reload polling (Windows friendly).

#### Backend: phone normalization & lookup compatibility
- `backend/app/utils/formatters.py`
  - Normalisasi E.164 mendukung internasional + prefix `00` + batas maksimal E.164 (15 digit).
- `backend/app/infrastructure/http/public_user_routes.py`
  - `check-or-register`: map `phoneNumber` → `phone_number`, lookup pakai variations.
- `backend/app/services/user_management/user_profile.py`
  - Cegah duplikasi user akibat beda format nomor (cek existing pakai variations).
- `backend/migrations/versions/20260216_normalize_user_phone_numbers_e164.py`
  - Data migration idempotent: normalisasi `users.phone_number` ke E.164 jika memungkinkan.

#### Backend: MikroTik ops gating (OTP-only tetap bisa jalan)
- `backend/app/services/device_management_service.py`
  - Semua operasi MikroTik (ip-binding/address-list/resolve) menghormati setting `ENABLE_MIKROTIK_OPERATIONS`.
- `backend/app/infrastructure/http/admin/request_management_routes.py`
- `backend/app/services/user_management/helpers.py`
  - Gating MikroTik ops berbasis setting dan perbaikan Pylance untuk `AdminActionLog`.

#### Frontend: validator nomor telepon konsisten dengan backend
- `frontend/utils/formatters.ts`
  - Menyamakan logika normalisasi E.164 (termasuk internasional dan 15 digit max).
- `frontend/components/admin/users/UserAddDialog.vue`
- `frontend/pages/akun/index.vue`
- `frontend/pages/beli/index.vue`
- `frontend/pages/admin/whatsapp.vue`
  - Validasi/normalisasi nomor pakai helper terpusat.

#### Testing config
- `frontend/vitest.config.ts`
  - Ubah environment default ke `node` agar unit test util tidak tergantung jsdom.
- `backend/tests/test_formatters.py`
- `frontend/tests/formatters.test.ts`
  - Tambah coverage untuk nomor internasional (termasuk contoh 15 digit max E.164).

### Catatan operasional: rebuild vs mount
- Default `docker-compose.yml` dev (tanpa mount backend) membutuhkan `docker compose up -d --build backend` setelah ubah kode backend.
- Jika ingin tanpa rebuild: jalankan dengan override `docker-compose.dev.yml`.

---

## Addendum — Docker build, migrate, dan Cloudflare Tunnel (sesi ini)

Bagian ini merangkum pekerjaan operasional yang terjadi pada sesi ini (percakapan Copilot) terkait:
- error build Docker backend (`apt-get ... exit code 100`),
- error `migrate` yang membuat `docker compose up` gagal,
- Cloudflare Tunnel terlihat “down” walau container lain “up”,
- memastikan produksi **wajib** diakses lewat tunnel (tanpa membuka port langsung).

> Catatan penting: detail token/secrets tidak ditulis di sini. Pastikan nilai token/secret hanya ada di file env yang di-ignore git.

### 1) Docker build backend gagal di `apt-get` (exit code 100)
**Gejala**
- `docker compose build` gagal pada langkah `apt-get update/install` (exit code `100`).

**Akar masalah yang terlihat saat investigasi**
- Koneksi dari build environment ke repo Debian (`deb.debian.org`) tidak stabil / ditolak, sehingga `apt-get update` tidak bisa mengambil index.
- Tag base image `python:3.11-slim` bisa berubah OS-nya (pernah terlihat Debian codename lebih baru), sehingga paket APT yang tersedia juga bisa berubah.

**Langkah mitigasi yang sempat dicoba**
- Mencoba membuat Dockerfile lebih stabil dengan:
  - mem-pin base image ke varian Bookworm,
  - menambah konfigurasi APT (retries/timeout/ForceIPv4),
  - menyesuaikan nama paket dependensi WeasyPrint ke paket Debian yang umum.

**Status akhir**
- Perubahan Dockerfile yang bersifat mitigasi build kemudian **dikembalikan** (restore) sesuai permintaan, setelah build berhasil di sisi pengguna.

### 2) `docker compose up` gagal karena service `migrate` exit 1
**Gejala**
- `docker compose up -d --force-recreate` berhenti dengan:
  - `service "migrate" didn't complete successfully: exit 1`

**Akar masalah**
- Backend melempar `ValueError: Konfigurasi database (DATABASE_URL atau DB_USER/PASS/HOST/NAME) tidak ditemukan.`
- Saat dicek dari dalam container one-off, `DATABASE_URL` dan `DB_*` memang kosong.
- Penyebabnya: file `backend/.env.public` yang dipakai `env_file` tidak berisi konfigurasi DB, dan compose saat itu belum meng-inject `DATABASE_URL`.

**Perbaikan**
- Update `docker-compose.yml` untuk menambahkan `environment:` berisi:
  - `DB_HOST=db`, `DB_PORT=5432`, `DB_NAME/DB_USER/DB_PASSWORD` (diambil dari root `.env`),
  - `DATABASE_URL=postgresql+psycopg2://...@db:5432/...`
  - diterapkan ke service: `backend`, `migrate`, `celery_worker`, `celery_beat`.

**Validasi**
- `migrate` selesai dengan exit code `0`.
- `backend` bisa boot normal tanpa error konfigurasi DB.

### 3) Cloudflare Tunnel terlihat “down” karena service tidak jalan
**Gejala**
- Semua container utama `Up`, tapi status tunnel di Cloudflare dashboard “down”.

**Akar masalah**
- Di `docker-compose.yml`, service `cloudflared` berada dalam `profiles: [tunnel]`.
- Jika menjalankan `docker compose up -d` tanpa `--profile tunnel`, service `cloudflared` **tidak ikut dijalankan**.

**Perbaikan**
- Aktifkan profile tunnel secara default lewat root `.env`:
  - `COMPOSE_PROFILES=tunnel`
- Update juga template `.env.example` agar perilaku ini terdokumentasi.

**Validasi**
- `docker compose up -d cloudflared` membuat container tunnel berjalan.
- Log `cloudflared` menunjukkan koneksi tunnel terdaftar dan menerima konfigurasi ingress.

### 4) Produksi: wajib lewat tunnel (tanpa buka port langsung)
**Tujuan**
- Menghindari akses langsung ke origin dari jaringan publik.
- Satu-satunya entrypoint dari luar adalah `cloudflared -> nginx`.

**Perbaikan**
- Update `docker-compose.prod.yml`:
  - hapus publikasi port host `80:80` pada `nginx`,
  - hapus publikasi port host `5010:5010` pada `backend`.

**Catatan**
- Komunikasi internal antar-container tetap berjalan melalui network Docker.
- Akses administratif dilakukan via `docker compose exec ...` / log container, bukan lewat port host.
