# PR Draft — Finalisasi Hardening + Kompatibilitas FE/BE + Dekomposisi Payment Finish

## Suggested PR Title
Hardening lanjutan: standardisasi error envelope, modularisasi transaksi, request-id observability, dan dekomposisi payment finish

## Ringkasan
PR ini menutup batch final P0/P1/P2 dengan fokus pada stabilitas flow transaksi, konsistensi kontrak backend-frontend, observability request correlation, serta maintainability UI payment status.

## Latar Belakang
- Masih ada gap konsistensi format error antar endpoint auth/transaction.
- Route transaksi terlalu monolitik dan sulit dipelihara.
- Frontend belum konsisten mempropagasi request id lintas SSR/client.
- Halaman payment finish masih memiliki template besar yang sulit dirawat.

## Perubahan Utama

### Backend
- Standardisasi error envelope:
  - Tambah helper terpusat di backend/app/infrastructure/http/error_envelope.py.
  - Migrasi jalur auth guard di backend/app/infrastructure/http/decorators.py ke helper envelope.
- Modularisasi route transaksi:
  - Ekstraksi logic transaksi ke modul terpisah di backend/app/infrastructure/http/transactions/:
    - initiation_routes.py
    - authenticated_routes.py
    - public_routes.py
    - webhook_routes.py
    - invoice_routes.py
    - helpers.py
    - payment_policy.py
    - idempotency.py
    - events.py
  - transactions_routes.py menjadi orchestration layer yang lebih tipis.
- Dependency deterministik:
  - requirements.txt dipin versi.
  - Tambah requirements.lock.txt.
  - Tambah script sinkronisasi lockfile:
    - backend/scripts/check_requirements_lock_sync.py
    - backend/scripts/refresh_lock_and_validate.py

### Frontend
- Observability request id:
  - frontend/plugins/api.ts menambahkan propagasi/generasi header X-Request-ID untuk SSR dan client.
- Kontrak tipe API terpusat:
  - Tambah frontend/types/api/contracts.ts.
  - Sinkronisasi pemakaian tipe di store/composables/pages terkait.
- Dekomposisi payment finish:
  - Tambah komponen:
    - frontend/components/payment/StatusHeader.vue
    - frontend/components/payment/StatusActionButtons.vue
  - Refactor frontend/pages/payment/finish.vue untuk memakai komponen baru.

### Kontrak API
- Tambah source of truth kontrak OpenAPI:
  - contracts/openapi/openapi.v1.yaml

### Dokumentasi
- Update devlog finalisasi batch:
  - docs/DEVLOG_2026-02-25.md

## Dampak
- Error response lebih konsisten dan lebih mudah di-handle frontend.
- Kode transaksi backend lebih modular dan lebih mudah dites/dirawat.
- Korelasi log lintas request meningkat via request-id.
- Halaman payment finish lebih maintainable dengan pemisahan komponen.

## Validasi yang Sudah Dijalankan
- Frontend:
  - pnpm lint → pass
  - pnpm typecheck → pass
- Backend targeted regression:
  - pytest tests/test_auth_verify_otp_auto_authorize.py tests/test_transactions_lifecycle.py tests/test_transaction_public_status.py -q
  - Hasil: 22 passed
- Isolated E2E simulation:
  - scripts/simulate_end_to_end.ps1 -ComposeFile docker-compose.e2e.yml -ProjectName lpsaring-e2e -SkipBuild
  - Hasil: mencapai tahap akhir [17/17] dan selesai dengan status Done

### Validasi Tambahan (Update Terbaru)
- Backend targeted debt test:
  - pytest backend/tests/test_user_debt_settle_single_item.py -q
  - Hasil: 2 passed
- VS Code workspace problems scan:
  - Hasil akhir: no errors found
- Catatan:
  - backend/tests/test_mikrotik_connection.py adalah script koneksi manual (bukan pytest unit test), sudah dirapikan agar tidak memunculkan error analisis statik.

## Risiko
- Risiko regressi pada route transaksi karena refactor modular.
- Risiko mismatch kecil pada expected error payload di endpoint legacy tertentu.
- Risiko behavior berbeda pada jalur payment method edge-case (Core API vs Snap).

## Mitigasi
- Sudah dijalankan regression test targeted transaksi/auth.
- Sudah dijalankan lint/typecheck frontend.
- Sudah dijalankan isolated E2E end-to-end flow.

## Rollback Plan
1. Revert commit PR ini.
2. Deploy ulang image stabil sebelumnya.
3. Jalankan smoke check:
   - API ping
   - request otp + verify otp (demo bypass jika aktif)
   - initiate transaction + cek status

## Checklist Reviewer
- Verifikasi konsistensi response error pada endpoint auth/transaction.
- Verifikasi flow initiation (Snap/Core API) termasuk debt settlement.
- Verifikasi halaman payment finish untuk status utama: PENDING, SUCCESS, CANCELLED, FAILED/EXPIRED.
- Verifikasi request-id muncul konsisten pada request frontend ke backend.
- Verifikasi E2E dan regression report sesuai hasil.

## Catatan Merge
Disarankan merge saat traffic rendah agar monitoring pasca-merge (auth error rate dan payment flow) lebih mudah diamati selama 24 jam pertama.

---

## Copy-ready GitHub PR Body (Ringkas)

### Ringkasan
PR ini menutup finalisasi hardening P0/P1/P2 dengan fokus pada:
- standardisasi error envelope backend,
- modularisasi route transaksi,
- propagasi `X-Request-ID` frontend (SSR + client),
- dekomposisi halaman payment finish agar lebih maintainable.

### Perubahan Utama
- Backend:
  - Tambah helper error terstandar + migrasi auth guard.
  - Pecah logic transaksi ke modul `transactions/*` (initiation, authenticated, public, webhook, invoice, helper/policy/idempotency/events).
  - Stabilkan dependency via `requirements.txt` pinned + `requirements.lock.txt` + script sinkronisasi lockfile.
- Frontend:
  - Tambah kontrak API terpusat (`frontend/types/api/contracts.ts`) dan sinkronisasi pemakaian tipenya.
  - Tambah komponen `StatusHeader` + `StatusActionButtons` dan refactor `payment/finish.vue`.
  - Tambah propagasi/generasi `X-Request-ID` di plugin API.
- Docs/Contract:
  - Update devlog finalisasi.
  - Tambah OpenAPI source of truth untuk domain prioritas.

### Validasi
- Frontend lint: pass
- Frontend typecheck: pass
- Backend regression (3 file): 22 passed
- Backend debt targeted test: 2 passed
- Isolated E2E simulation: selesai sampai tahap akhir (`[17/17]`, `Done`)
- VS Code workspace problems: no errors found

### Risiko & Mitigasi
- Risiko utama: regressi flow transaksi pasca modularisasi.
- Mitigasi: regresi targeted + E2E isolated + konsolidasi contract/type frontend-backend.

### Checklist Reviewer
- Verifikasi response error auth/transaction tetap konsisten.
- Verifikasi flow pembayaran Snap/Core API (termasuk debt settlement).
- Verifikasi halaman payment finish untuk status utama.
- Verifikasi request-id terlihat konsisten pada request frontend ke backend.

## Copy-ready GitHub PR Body (Super Singkat)

Finalisasi hardening P0/P1/P2:
- standardisasi error envelope backend,
- modularisasi flow transaksi,
- propagasi `X-Request-ID` (SSR + client),
- dekomposisi `payment/finish.vue`.

Validasi:
- frontend lint + typecheck pass,
- backend regression 3 file: 22 passed,
- debt targeted test: 2 passed,
- isolated E2E selesai sampai `[17/17]` (Done),
- VS Code problems: no errors found.

---

## Update Tambahan 2026-02-26 (Batch Lanjutan)

Tambahan yang sudah masuk setelah draft awal:

- Modularisasi `admin_routes.py` ke `admin_contexts` (backups/notifications/transactions/billing/reports) dan cleanup helper monolit.
- CI frontend focused tests diperluas dari auth-only menjadi auth + payment composables/polling.
- CI menampilkan manifest focused test ke `GITHUB_STEP_SUMMARY` via `FOCUSED_FRONTEND_TESTS`.
- Tambah test frontend:
  - `tests/payment-composables.test.ts`
  - `tests/payment-status-polling.test.ts`
- Tambah/aktifkan smoke kontrak backend:
  - `backend/tests/test_openapi_contract_smoke.py`

Validasi update tambahan:
- Focused frontend tests: pass.
- Targeted backend tests (admin/transaksi/openapi smoke): pass.

---

## Update Final 2026-02-26 (Eksekusi P0-P2 + Hardening Regression)

Tambahan final yang sudah masuk setelah update di atas:

- Backend transaksi:
  - Duplikasi reconcile pada auth/public detail route dihapus dan dipusatkan ke:
    - `backend/app/infrastructure/http/transactions/reconcile_service.py`
  - Route yang sudah menggunakan service terpusat:
    - `backend/app/infrastructure/http/transactions/authenticated_routes.py`
    - `backend/app/infrastructure/http/transactions/public_routes.py`

- Frontend guard policy:
  - Policy route auth/maintenance dipusatkan ke:
    - `frontend/utils/authRoutePolicy.ts`
  - Decision helper guard murni ditambah untuk testability:
    - `frontend/utils/authGuardDecisions.ts`
  - Middleware/store yang sudah consume policy/helper terpusat:
    - `frontend/middleware/auth.global.ts`
    - `frontend/middleware/maintenance.global.ts`
    - `frontend/store/auth.ts`

- Frontend payment page decomposition:
  - Ekstraksi instruksi pending payment ke komponen:
    - `frontend/components/payment/PendingPaymentInstructions.vue`
  - Integrasi di:
    - `frontend/pages/payment/finish.vue`

- Contract & regression tests:
  - OpenAPI payload-shape + runtime envelope test:
    - `backend/tests/test_openapi_contract_payload_shapes.py`
  - Konsistensi auth/public transaction detail + reconcile transition/failure-path tests:
    - `backend/tests/test_transactions_detail_consistency.py`
  - Frontend guard decision tests:
    - `frontend/tests/auth-guard-decisions.test.ts`
  - Frontend auth middleware runtime tests (mocked Nuxt/app-store):
    - `frontend/tests/auth-middleware.runtime.test.ts`

### Validasi Final (Latest Baseline)

- Frontend focused regression baseline:
  - `pnpm vitest run tests/auth-access.test.ts tests/auth-guards.test.ts tests/auth-guard-decisions.test.ts tests/auth-middleware.runtime.test.ts tests/payment-composables.test.ts tests/payment-status-polling.test.ts`
  - Hasil: **6 files, 38 tests passed**.

- Backend focused regression baseline:
  - `pytest tests/test_transactions_detail_consistency.py tests/test_transaction_public_status.py tests/test_transactions_lifecycle.py tests/test_openapi_contract_smoke.py tests/test_openapi_contract_payload_shapes.py`
  - Hasil: **30 passed**.

- Backend targeted reconcile failure-path re-check:
  - `pytest tests/test_transactions_detail_consistency.py tests/test_transaction_public_status.py tests/test_openapi_contract_payload_shapes.py`
  - Hasil: **14 passed**.

### Catatan Reviewer (Tambahan)

- Periksa bahwa response detail transaksi auth/public tetap konsisten untuk field bersama, dan masking data sensitif di public tidak regress.
- Periksa bahwa user status `expired/habis` tetap diizinkan ke halaman payment status/finish sesuai policy baru.
- Periksa jalur failure reconcile (`should_allow_call=False` dan Midtrans API error) tidak memaksa status berubah dan tetap mencatat metric failure.

---

## Update Penutup 2026-02-26 (Auth Bounded-Context Finalisasi)

Tambahan final setelah baseline di atas:

- `auth_routes.py` dipersempit lagi dengan delegasi endpoint `verify_otp` ke handler konteks baru:
  - `backend/app/infrastructure/http/auth_contexts/verify_otp_handlers.py`
- Route wrapper dan URL contract tidak berubah; perubahan hanya internal refactor untuk maintainability dan isolasi concern.

Validasi setelah delegasi `verify_otp`:

- Diagnostics (VS Code problems scan) pada file refactor:
  - `backend/app/infrastructure/http/auth_routes.py`
  - `backend/app/infrastructure/http/auth_contexts/verify_otp_handlers.py`
  - Hasil: no errors found.
- Backend focused tests:
  - `pytest -q tests/test_transactions_detail_consistency.py tests/test_openapi_contract_payload_shapes.py`
  - Hasil: **9 passed**.
- Backend verify-otp targeted tests:
  - `pytest -q tests/test_auth_verify_otp_auto_authorize.py`
  - Hasil: **2 passed**.

---

## Update Penutup Akhir 2026-02-26 (Sempurnakan Lanjutan)

Tambahan hardening final yang sudah diterapkan:

- Transaction structured logging:
  - Perbaikan pengambilan `request_id` pada reconcile flow agar menggunakan request context (`X-Request-ID` / `FLASK_REQUEST_ID`) secara aman.
  - Warning/error log reconcile kini ikut membawa `request_id` konsisten.
  - File: `backend/app/infrastructure/http/transactions/reconcile_service.py`.

- Perampingan `transactions_routes.py`:
  - Helper debt dipisah ke modul baru:
    - `backend/app/infrastructure/http/transactions/debt_helpers.py`
  - Fungsi yang diekstrak:
    - estimate debt user
    - estimate debt by MB
    - apply debt settlement on success
  - Penghapusan skema Pydantic lokal yang tidak digunakan dari façade route.
  - Dampak: `transactions_routes.py` turun dari **679** baris menjadi **481** baris.

- Isolasi artifact frontend untuk review/search hygiene:
  - Update workspace settings:
    - `.vscode/settings.json`
  - Tambah exclude untuk `node_modules` dan `.pnpm-store` pada `files.exclude`, `search.exclude`, `files.watcherExclude`.

Validasi final setelah perubahan di atas:

- Diagnostics:
  - `reconcile_service.py`, `debt_helpers.py`, `transactions_routes.py`, `.vscode/settings.json`
  - Hasil: no errors found.
- Backend focused regression:
  - `pytest -q tests/test_openapi_contract_payload_shapes.py tests/test_transactions_detail_consistency.py tests/test_auth_verify_otp_auto_authorize.py tests/test_user_debt_settle_single_item.py`
  - Hasil: **13 passed**.
- Frontend focused regression:
  - `pnpm vitest run tests/auth-access.test.ts tests/auth-guards.test.ts tests/payment-composables.test.ts tests/payment-status-polling.test.ts`
  - Hasil: **4 files, 22 tests passed**.

---

## Update Tambahan Akhir 2026-02-26 (Facade Readability Refinement)

Refinement lanjutan untuk menjaga maintainability jangka panjang pada route transaksi:

- `transactions_routes.py` kini memakai pola dependency-builder per endpoint group
  (initiate, debt-initiate, notification, auth/public detail, cancel, QR, invoice).
- Tujuan perubahan ini: menurunkan cognitive load saat membaca wrapper route dan
  mempermudah review dependency wiring tanpa mengubah URL/contract/behavior.

Catatan ukuran file:

- Refactor ini mengorbankan jumlah baris untuk struktur yang lebih eksplisit.
- `transactions_routes.py` berubah dari **481** menjadi **545** baris,
  tetapi setiap endpoint wrapper kini jauh lebih ringkas dan konsisten.

Validasi setelah refinement:

- Backend focused regression:
  - `pytest -q tests/test_transactions_detail_consistency.py tests/test_openapi_contract_payload_shapes.py tests/test_auth_verify_otp_auto_authorize.py tests/test_user_debt_settle_single_item.py`
  - Hasil: **13 passed**.
- Frontend focused regression:
  - `pnpm vitest run tests/auth-access.test.ts tests/auth-guards.test.ts tests/payment-composables.test.ts tests/payment-status-polling.test.ts`
  - Hasil: **4 files, 22 tests passed**.

---

## Closure Update 2026-02-26 (Final Optional Hardening)

Penyempurnaan optional yang sudah dieksekusi:

- Ekstraksi helper umum Midtrans/date/QR dari façade transaksi ke modul baru:
  - `backend/app/infrastructure/http/transactions/midtrans_helpers.py`
  - Helper yang dipindah: Midtrans client factory, datetime parser Midtrans, extractor VA/QR/action URL, checker QR payment type.
- `transactions_routes.py` sekarang hanya consume helper dari modul tersebut (wrapper tetap non-breaking).

Dampak ukuran façade transaksi:

- `transactions_routes.py`: **545 → 455** baris.

Status penutupan temuan yang sebelumnya "kuning":

- Structured log transaksi (`request_id`) ➜ **closed** (di `reconcile_service.py` memakai request context aman).
- Isolasi artifact FE workspace search/review ➜ **closed** (`.vscode/settings.json` sudah exclude `.nuxt/.output/.nitro/node_modules/.pnpm-store`).
- Facade transaksi masih besar ➜ **improved signifikan** (679 → 455, tetap ada ruang optional lanjutan jika ingin split lebih granular).

Validasi baseline terbaru setelah update final:

- Backend focused regression (broader):
  - `pytest -q tests/test_transactions_detail_consistency.py tests/test_transactions_lifecycle.py tests/test_transaction_public_status.py tests/test_openapi_contract_payload_shapes.py tests/test_auth_verify_otp_auto_authorize.py tests/test_user_debt_settle_single_item.py`
  - Hasil: **33 passed**.
- Frontend focused regression (expanded):
  - `pnpm vitest run tests/auth-access.test.ts tests/auth-guards.test.ts tests/auth-guard-decisions.test.ts tests/auth-middleware.runtime.test.ts tests/payment-composables.test.ts tests/payment-status-polling.test.ts`
  - Hasil: **6 files, 38 tests passed**.

---

## E2E Final Sign-off 2026-02-26 (Pre-Publish)

Eksekusi E2E full simulation sudah dijalankan menggunakan script existing (tanpa patch script):

- Command:
  - `APP_ENV=e2e powershell.exe -NoProfile -ExecutionPolicy Bypass -File scripts/simulate_end_to_end.ps1 -UseIsolatedCompose 1 -ComposeProjectName hotspot-portal-e2e -IsolatedNginxPort 8089 -BaseUrl http://localhost:8089 -FreshStart 1 -Build 0 -UseOtpBypassOnly 1 -EnableMikrotikOps 0 -ApplyMikrotikOnQuotaSimulation 0 -CleanupAddressList 0`
- Hasil akhir: mencapai tahap **[17/17]** dan selesai dengan status **Done**.
- Milestone akhir yang tervalidasi:
  - simulasi status blocked/inactive via admin,
  - status akhir user + redirect expectation,
  - verify OTP (OTP-only),
  - mock Midtrans webhook smoke accepted.

Kesimpulan publish readiness:

- Focused regression backend: pass.
- Focused regression frontend: pass.
- E2E full simulation: pass.
- Batch perubahan dinyatakan siap publish dengan monitoring pasca-rilis standar.
