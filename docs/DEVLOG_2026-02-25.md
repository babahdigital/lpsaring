# Devlog 2026-02-25 (Stabilisasi Produksi + UX Dialog + Admin Users/Pagination)

Dokumen ini merangkum pekerjaan berdasarkan **commit history**, feedback produksi, dan langkah troubleshooting: masalah yang muncul, akar masalah, solusi, dan cara verifikasi.

> Catatan keamanan: tidak ada token/secret ditulis di dokumen ini.

## 1) Ringkasan

Fokus hari ini:
- Stabilisasi UX produksi setelah rilis fitur debt + Komandan.
- Perbaikan beberapa error produksi:
  - Admin edit user: saat `Unlimited Time` ON, field tambah masa aktif seharusnya tidak muncul.
  - Dashboard Komandan: chart mingguan/bulanan stuck loading.
  - Browser console spam: `Content-Security-Policy-Report-Only` (script-src 'none').
  - Background request: `POST /api/users/me/devices/bind-current` sering 403.
- Penyempurnaan UI dialog agar **fullscreen + responsif** (mobile & desktop) dan tombol close selalu di atas.
- Deploy ke Raspberry Pi dengan `--prune` dan verifikasi migrate benar-benar sukses.
- Perbaikan UI Admin Users (iteratif berdasarkan feedback):
  - Default `Tanggal Tunggakan` otomatis terisi hari ini saat toggle tunggakan diaktifkan.
  - Tambah kolom `PROFILE` (Aktif/Blocked/FUP/Habis/Expired/Unlimited) + badge Debt.
  - Penyempurnaan layout mobile/responsif (toolbar, search+button, nama panjang vs badge).
- Perbaikan bug pagination server-side: klik nomor halaman tidak jalan karena watcher mereset page.
- Penyempurnaan datepicker (Flatpickr) di dialog: posisi popup dan konsistensi ukuran.
- Housekeeping GitHub Actions: hapus cache dan sisakan 2 workflow runs terbaru.

## 2) Timeline (Commit penting)

- `2298dfe3`
  - Admin edit user: hide `Tambah Masa Aktif (Hari)` saat `Unlimited Time` aktif.
  - Dashboard: chart tidak ikut loading global yang tidak relevan.
  - Endpoint `bind-current`: tambah mode `best_effort` agar tidak 403 untuk background.
  - Nginx: hide header CSP dari upstream untuk mengurangi konflik/report-only spam.

- `c13dd4ff`
  - Dashboard user: card tunggakan hanya muncul jika ada tunggakan.
  - Dashboard user: dialog Kelola Perangkat dibuat fullscreen + toolbar close.
  - Admin: dialog edit user fullscreen + scroll-friendly (desktop & mobile).
  - Admin: dialog detail user dinamis (section tunggakan/histori tampil bila relevan).
  - Komandan: dialog request header pakai toolbar (X selalu di kanan atas).

- `bb796bd1`
  - Dokumentasi: devlog 2026-02-25 + update ops/error reference.

- `d508191a`
  - Admin Users: tambah kolom `PROFILE` + default `debt_date` saat tunggakan kuota diaktifkan.

- `fc633cbd`
  - Fix pagination: watcher tidak lagi memaksa `page=1` saat user klik nomor halaman.

- `bebf9e55`
  - Selaraskan pola fetch pagination lintas halaman admin (packages, whatsapp, profile manager).

- `d76146d4`
  - UI polish: datepicker popup (posisi/ukuran), hint switch dipendekkan, spacing tabel riwayat tunggakan manual.

- `2e09754f`
  - Admin Users: penyempurnaan layout mobile (toolbar/search/button/preview cleanup) + handling nama panjang vs badge.

## 3) Masalah Produksi & Penyelesaian

### 3.1 Admin edit user: `Unlimited Time` tapi masih ada field tambah masa aktif
**Gejala**:
- Saat admin ON `Unlimited Time`, field `Tambah Masa Aktif (Hari)` masih terlihat.

**Solusi**:
- Sembunyikan input `add_days` jika `formData.unlimited_time === true`.

**Verifikasi**:
- Buka Admin → Edit User → aktifkan `Unlimited Time` → field `Tambah Masa Aktif (Hari)` tidak terlihat.

### 3.2 Dashboard Komandan: chart stuck loading
**Gejala**:
- Loading chart mingguan/bulanan tidak selesai (terutama Komandan).

**Akar masalah**:
- Parent chart memakai `isFetching` global yang juga menghitung pending request lain (mis. weekly spending) yang tidak dipakai Komandan.

**Solusi**:
- `isFetching/hasError` mengecualikan weekly spending saat role Komandan.
- Prop `parent-loading` untuk chart dibuat spesifik per request (quota/weekly/monthly), bukan global.

**Verifikasi**:
- Login sebagai Komandan → dashboard chart tampil/keluar dari skeleton setelah request selesai.

### 3.3 CSP report-only spam `script-src 'none'`
**Gejala**:
- Console spam CSP report-only (sering terlihat di mobile).

**Akar masalah (paling umum)**:
- Ada **lebih dari satu layer** yang menyuntikkan CSP (mis. upstream/frontend/backend/edge), sehingga browser menerima CSP yang saling bertabrakan.

**Solusi di stack ini**:
- Di Nginx, hide header CSP yang datang dari upstream:
  - `proxy_hide_header Content-Security-Policy;`
  - `proxy_hide_header Content-Security-Policy-Report-Only;`

**Catatan**:
- Jika masih terjadi, sumbernya bisa dari Cloudflare/edge (di luar container nginx).

### 3.4 `POST /users/me/devices/bind-current` 403 (noise)
**Gejala**:
- Request bind-current sering 403 (terutama saat background attempt di dashboard).

**Akar masalah**:
- Binding device bisa gagal karena konteks IP/MAC tidak resolvable atau policy binding.

**Solusi**:
- Backend: dukung query `?best_effort=1` untuk mode best-effort.
  - Jika gagal binding → tetap `200` dengan `{success:false, bound:false}` (tanpa 403).
  - 403 tetap dipakai untuk kasus akun nonaktif/blocked.
- Frontend dashboard: panggil endpoint dengan `?best_effort=1`.

**Verifikasi**:
- Buka dashboard user → cek Network: bind-current tidak lagi menghasilkan 403 saat gagal binding.

## 4) Penyempurnaan UX Dialog (Fullscreen + Responsif)

Target UX:
- Mobile: dialog fullscreen, konten scroll, tombol close jelas di toolbar (kanan atas), action button lebar (`block`).
- Desktop: tetap lega (fullscreen untuk admin edit, detail), tidak ada konten terpotong.

Perubahan utama:
- Komandan RequestFormDialog: header jadi `VToolbar` agar tombol X tidak “turun” ke bawah.
- Dashboard user: DeviceManager fullscreen + toolbar.
- Admin:
  - UserEditDialog fullscreen + body scroll + actions stack di mobile.
  - UserDetailDialog fullscreen di mobile + section tunggakan/histori tampil hanya bila relevan.

## 5) Deploy Produksi (Pi) + Prune + Migrate

Deploy dilakukan via script:
- `bash ./deploy_pi.sh --host 10.10.83.2 --user abdullah --port 1983 --remote-dir /home/abdullah/sobigidul --prune`

Poin penting:
- `--prune` melakukan safe prune (container/image/network/builder) dan **tidak menghapus volumes**.
- `migrate` berjalan via service `migrate` di `docker-compose.prod.yml` (`flask db upgrade`).

Verifikasi migrate sukses:
- `MIGRATE_EXIT=0` dan `MIGRATE_STATUS=exited` untuk container `hotspot_prod_flask_migrate`.

Verifikasi health:
- Healthcheck dari dalam container nginx: `wget -qO- http://127.0.0.1/api/ping`.

## 6) Checklist (Quick)

Frontend:
- `pnpm run lint`
- `pnpm run typecheck`

Backend:
- `python -m ruff check .`
- `python -m ruff format --check .`
- `python -m pytest -q`

Produksi:
- `docker compose ps` menunjukkan backend/frontend/nginx/cloudflared running.
- `docker inspect` migrate exit code 0.
- `/api/ping` OK.

## 7) Admin Users: PROFILE + Debt + Default Tanggal Tunggakan

### 7.1 Kolom `PROFILE` + badge Debt
Tujuan:
- Di tabel Admin Users, admin bisa cepat melihat status “profil” hotspot (Aktif/Blocked/FUP/Habis/Expired/Unlimited) dan indikator hutang (Debt).

Implementasi (ringkas):
- Tambah kolom `PROFILE` di halaman Admin Users.
- `PROFILE` dihitung dari data user (mis. `mikrotik_profile_name`, kondisi kuota/expiry) dan ditampilkan sebagai chip/badge.
- Jika user punya hutang (manual/auto), tampilkan badge Debt dengan ukuran kuota (MB/GB) + tooltip nilai mentah.

Verifikasi:
- Admin → Users → tabel menampilkan kolom `PROFILE`.
- User yang blocked/unlimited/expired terlihat dari chip profile.
- User yang punya hutang menampilkan badge Debt.

### 7.2 Default `Tanggal Tunggakan` otomatis hari ini
Tujuan:
- Menghindari field tanggal kosong saat admin mengaktifkan `Tunggakan Kuota`.

Solusi:
- Saat toggle tunggakan ON dan tanggal belum diisi, set `debt_date` ke tanggal hari ini (format `YYYY-MM-DD`).

Verifikasi:
- Admin → Edit User → aktifkan toggle tunggakan → `Tanggal Tunggakan` otomatis terisi.

## 8) Fix Pagination Server-side (klik nomor halaman tidak jalan)

**Gejala**:
- Admin klik nomor halaman di pagination, tapi tabel selalu balik ke halaman 1 / tidak berubah.

**Akar masalah**:
- Watcher `options` (datatable options) sebelumnya selalu memaksa `options.page = 1` saat `options` berubah.
- Saat user klik pagination, perubahan `page` juga dianggap “options berubah”, lalu di-reset lagi.

**Solusi**:
- Pisahkan watcher:
  - `watch(options, fetch..., { deep: true })` untuk fetch saat page/itemsPerPage/sort berubah.
  - Watch search/filter saja yang mereset `page=1` lalu fetch.

**Area terdampak**:
- Admin users, whatsapp, packages, dan dialog manajemen profile.

**Verifikasi**:
- Klik nomor halaman 2/3/next → data benar-benar berubah dan page tidak auto balik ke 1.

## 9) UI Polish: Datepicker & Spacing

Perubahan:
- Flatpickr (datepicker) dibuat lebih stabil di dalam dialog/scroll container:
  - posisi popup tidak “lompat” ke atas,
  - ukuran dropdown lebih konsisten dengan input.
- Hint switch dipendekkan agar tidak makan ruang.
- Tabel “Riwayat Tunggakan Manual” di detail user diberi spacing yang lebih nyaman.

## 10) Ops: GitHub Actions Cache/Run Cleanup

Konteks:
- Storage cache GitHub Actions bisa membengkak dan memicu limit.

Yang dilakukan:
- Hapus caches via `gh api`.
- Hapus workflow runs lama dan sisakan 2 terbaru.

Catatan:
- Cache bisa muncul lagi setelah ada workflow run baru.

## 11) Update Lanjutan Sesi (Merchant Center + Demo Mode + Deploy)

### 11.1 Perubahan yang sudah diterapkan

- Frontend public merchant center ditambahkan dan dipublikasikan:
  - `/merchant-center`
  - `/merchant-center/privacy`
  - `/merchant-center/terms`
- Konten legal disesuaikan agar realistis terhadap alur pembayaran saat ini (Snap/Core API, status, invoice, dan kanal support).
- Data identitas merchant dipusatkan ke env public + runtime config:
  - `NUXT_PUBLIC_MERCHANT_NAME`
  - `NUXT_PUBLIC_MERCHANT_BUSINESS_TYPE`
  - `NUXT_PUBLIC_MERCHANT_ADDRESS`
  - `NUXT_PUBLIC_MERCHANT_SUPPORT_EMAIL`
  - `NUXT_PUBLIC_MERCHANT_SUPPORT_WHATSAPP`
- Dibuat composable terpusat untuk profil merchant agar seluruh halaman legal memakai sumber data yang sama.
- Normalisasi tampilan nomor WhatsApp merchant:
  - `+62...` / `62...` ditampilkan sebagai `0...` untuk konteks Indonesia.
  - Nomor internasional non-Indonesia tetap ditampilkan dalam format internasional.

### 11.2 Demo mode berbasis ENV (aman untuk produksi)

- Backend menambahkan kontrol demo berbasis env (tanpa hardcode di kode frontend):
  - `DEMO_MODE_ENABLED`
  - `DEMO_ALLOW_ANY_PHONE`
  - `DEMO_ALLOWED_PHONES`
  - `DEMO_BYPASS_OTP_CODE`
  - `DEMO_SHOW_TEST_PACKAGE`
  - `DEMO_PACKAGE_IDS`
- Scope bypass OTP dibatasi pada nomor yang masuk kriteria demo.
- Paket nonaktif dapat ditampilkan/dibeli untuk user demo sesuai env, tanpa membuka akses user reguler.

### 11.3 Error/kendala yang ditemui selama pengerjaan

1. **Cloudflare 1010 saat smoke test eksternal**
   - Gejala: request langsung dari lokal ke endpoint produksi terblokir.
   - Penanganan: validasi dilakukan dari konteks internal server/container.

2. **Mismatch visual dengan acuan `dev/privacy/index-1.html`**
   - Gejala: hasil awal terasa terlalu keras (shadow/border/radius).
   - Penanganan: dilakukan pass kedua untuk melunakkan style agar mendekati acuan.

3. **Issue kalender/datepicker masih belum tuntas sepenuhnya**
   - Gejala: pada kondisi tertentu popup kalender masih bisa terasa tidak konsisten.
   - Status: **known issue (open)**, perlu sesi perbaikan terfokus khusus datepicker.

### 11.4 Validasi yang sudah dijalankan

- Frontend: `pnpm lint` dan `pnpm typecheck`.
- Backend: `python -m ruff check .`.
- Deploy produksi Raspberry Pi dengan `--prune` dan health check `/api/ping` sukses.

### 11.5 Koreksi lanjutan (demo user only) + UI simplification

Perbaikan lanjutan berdasarkan feedback produksi/screenshot:

- **Masalah**: paket `Testing` nonaktif masih terlihat untuk user non-demo pada kondisi tertentu.
- **Akar masalah**: filter eksposur paket demo perlu dipastikan juga di backend berdasarkan requester yang terautentikasi.
- **Perbaikan**:
  - Backend endpoint paket publik menambahkan resolusi user dari token/cookie dan validasi eligibility demo per-user.
  - Paket nonaktif dari daftar demo hanya di-append jika requester adalah user demo yang eligible.
  - Frontend flow demo diselaraskan agar tetap mengunci pembelian non-testing untuk user demo.

Penyempurnaan UX akhir:

- Panel info mode demo yang panjang diganti menjadi badge `Demo` berwarna agar tampilan lebih simpel.
- Label tombol paket yang tidak bisa dibeli dalam mode demo diubah dari `Khusus Demo` menjadi `Disable`.
- Perubahan diterapkan di dua halaman:
  - `frontend/pages/beli/index.vue`
  - `frontend/pages/captive/beli.vue`

Commit terkait lanjutan:

- `8ead0f91` — fix visibilitas paket testing nonaktif untuk non-demo + penyederhanaan label awal.
- `ebd3f314` — simplifikasi info demo menjadi badge + update label disable.

Deploy lanjutan:

- Deploy ulang dengan prune ke production berhasil.
- Health check backend tetap OK (`/api/ping` → pong).
