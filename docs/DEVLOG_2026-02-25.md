# Devlog 2026-02-25 (Stabilisasi Produksi + UX Dialog)

Dokumen ini merangkum pekerjaan berdasarkan **commit history**, feedback produksi, dan langkah troubleshooting: masalah yang muncul, akar masalah, solusi, dan cara verifikasi.

> Catatan keamanan: tidak ada token/secret ditulis di dokumen ini.

## 1) Ringkasan

Fokus hari ini:
- Stabilisasi UX produksi setelah rilis fitur debt + Komandan.
- Perbaikan beberapa error produksi:
  - Admin edit user: saat `Unlimited Time` ON, field tambah masa aktif seharusnya tidak muncul.
  - Dashboard Komandan: chart mingguan/bulanan stuck loading.
  - Browser console spam: `Content-Security-Policy-Report-Only` (script-src 'none').
  - Background request: `POST /api/users/me/devices/bind-current` sering 403.
- Penyempurnaan UI dialog agar **fullscreen + responsif** (mobile & desktop) dan tombol close selalu di atas.
- Deploy ke Raspberry Pi dengan `--prune` dan verifikasi migrate benar-benar sukses.

## 2) Timeline (Commit penting)

- `2298dfe3`
  - Admin edit user: hide `Tambah Masa Aktif (Hari)` saat `Unlimited Time` aktif.
  - Dashboard: chart tidak ikut loading global yang tidak relevan.
  - Endpoint `bind-current`: tambah mode `best_effort` agar tidak 403 untuk background.
  - Nginx: hide header CSP dari upstream untuk mengurangi konflik/report-only spam.

- `c13dd4ff`
  - Dashboard user: card tunggakan hanya muncul jika ada tunggakan.
  - Dashboard user: dialog Kelola Perangkat dibuat fullscreen + toolbar close.
  - Admin: dialog edit user fullscreen + scroll-friendly (desktop & mobile).
  - Admin: dialog detail user dinamis (section tunggakan/histori tampil bila relevan).
  - Komandan: dialog request header pakai toolbar (X selalu di kanan atas).

## 3) Masalah Produksi & Penyelesaian

### 3.1 Admin edit user: `Unlimited Time` tapi masih ada field tambah masa aktif
**Gejala**:
- Saat admin ON `Unlimited Time`, field `Tambah Masa Aktif (Hari)` masih terlihat.

**Solusi**:
- Sembunyikan input `add_days` jika `formData.unlimited_time === true`.

**Verifikasi**:
- Buka Admin → Edit User → aktifkan `Unlimited Time` → field `Tambah Masa Aktif (Hari)` tidak terlihat.

### 3.2 Dashboard Komandan: chart stuck loading
**Gejala**:
- Loading chart mingguan/bulanan tidak selesai (terutama Komandan).

**Akar masalah**:
- Parent chart memakai `isFetching` global yang juga menghitung pending request lain (mis. weekly spending) yang tidak dipakai Komandan.

**Solusi**:
- `isFetching/hasError` mengecualikan weekly spending saat role Komandan.
- Prop `parent-loading` untuk chart dibuat spesifik per request (quota/weekly/monthly), bukan global.

**Verifikasi**:
- Login sebagai Komandan → dashboard chart tampil/keluar dari skeleton setelah request selesai.

### 3.3 CSP report-only spam `script-src 'none'`
**Gejala**:
- Console spam CSP report-only (sering terlihat di mobile).

**Akar masalah (paling umum)**:
- Ada **lebih dari satu layer** yang menyuntikkan CSP (mis. upstream/frontend/backend/edge), sehingga browser menerima CSP yang saling bertabrakan.

**Solusi di stack ini**:
- Di Nginx, hide header CSP yang datang dari upstream:
  - `proxy_hide_header Content-Security-Policy;`
  - `proxy_hide_header Content-Security-Policy-Report-Only;`

**Catatan**:
- Jika masih terjadi, sumbernya bisa dari Cloudflare/edge (di luar container nginx).

### 3.4 `POST /users/me/devices/bind-current` 403 (noise)
**Gejala**:
- Request bind-current sering 403 (terutama saat background attempt di dashboard).

**Akar masalah**:
- Binding device bisa gagal karena konteks IP/MAC tidak resolvable atau policy binding.

**Solusi**:
- Backend: dukung query `?best_effort=1` untuk mode best-effort.
  - Jika gagal binding → tetap `200` dengan `{success:false, bound:false}` (tanpa 403).
  - 403 tetap dipakai untuk kasus akun nonaktif/blocked.
- Frontend dashboard: panggil endpoint dengan `?best_effort=1`.

**Verifikasi**:
- Buka dashboard user → cek Network: bind-current tidak lagi menghasilkan 403 saat gagal binding.

## 4) Penyempurnaan UX Dialog (Fullscreen + Responsif)

Target UX:
- Mobile: dialog fullscreen, konten scroll, tombol close jelas di toolbar (kanan atas), action button lebar (`block`).
- Desktop: tetap lega (fullscreen untuk admin edit, detail), tidak ada konten terpotong.

Perubahan utama:
- Komandan RequestFormDialog: header jadi `VToolbar` agar tombol X tidak “turun” ke bawah.
- Dashboard user: DeviceManager fullscreen + toolbar.
- Admin:
  - UserEditDialog fullscreen + body scroll + actions stack di mobile.
  - UserDetailDialog fullscreen di mobile + section tunggakan/histori tampil hanya bila relevan.

## 5) Deploy Produksi (Pi) + Prune + Migrate

Deploy dilakukan via script:
- `bash ./deploy_pi.sh --host 10.10.83.2 --user abdullah --port 1983 --remote-dir /home/abdullah/sobigidul --prune`

Poin penting:
- `--prune` melakukan safe prune (container/image/network/builder) dan **tidak menghapus volumes**.
- `migrate` berjalan via service `migrate` di `docker-compose.prod.yml` (`flask db upgrade`).

Verifikasi migrate sukses:
- `MIGRATE_EXIT=0` dan `MIGRATE_STATUS=exited` untuk container `hotspot_prod_flask_migrate`.

Verifikasi health:
- Healthcheck dari dalam container nginx: `wget -qO- http://127.0.0.1/api/ping`.

## 6) Checklist (Quick)

Frontend:
- `pnpm run lint`
- `pnpm run typecheck`

Backend:
- `python -m ruff check .`
- `python -m ruff format --check .`
- `python -m pytest -q`

Produksi:
- `docker compose ps` menunjukkan backend/frontend/nginx/cloudflared running.
- `docker inspect` migrate exit code 0.
- `/api/ping` OK.
