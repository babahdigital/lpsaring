# Worklog 2026-02-19

## Ringkasan
Perubahan hari ini fokus ke operasi produksi (Docker di Raspberry Pi), stabilitas transaksi Midtrans, rapihnya data transaksi di admin, dan hardening agar transaksi EXPIRED tidak “spam”.

## Environment Files (Dev vs Prod)
### Dev
- Backend env dev disimpan di folder `backend/`:
  - `backend/.env.public` (non-secret) → gunakan template `backend/.env.public.example`
  - `backend/.env.local` (secret) → gunakan template `backend/.env.local.example`
- Root `.env.public` dipakai untuk frontend/container dev (lihat `.env.public.example`).

### Prod
- Prod memakai file root `lpsaring/.env.prod` (secret) dan `lpsaring/.env.public.prod` (non-secret).
- Template yang tersedia:
  - `.env.prod.example` → salin ke `.env.prod` di server (jangan commit)
  - `.env.public.prod.example` → salin ke `.env.public.prod` di server

## Docker / Deploy (Raspberry Pi)
### Pola deploy aman (tanpa hapus DB)
Prinsip: **jangan pakai `down -v` dan jangan prune volumes** supaya volume DB/Redis aman.

Perintah yang dipakai:
- `docker compose -f docker-compose.prod.yml pull`
- `docker compose -f docker-compose.prod.yml up -d --force-recreate`
- `docker compose -f docker-compose.prod.yml exec -T backend flask db upgrade`
- verifikasi: `docker compose -f docker-compose.prod.yml ps`

### Masalah yang pernah muncul
- Pull image lambat/timeout → solusi: ulang `pull`, kurangi parallelism (compose), jalankan via SSH one-shot, dan cek `docker compose ps` setelahnya.
- DB tidak boleh hilang → solusi: selalu gunakan `up -d --force-recreate` tanpa `-v`.

## Spam transaksi EXPIRED (kadaluarsa)
### Gejala
- Admin transactions penuh baris status **Kadaluarsa/EXPIRED** dan sering berasal dari user yang sama.

### Akar masalah
- Endpoint initiate transaksi bisa terpanggil berkali-kali (klik ulang/refresh) sehingga membuat banyak order baru.
- Order yang tidak dibayar dalam window expiry otomatis ditandai EXPIRED oleh task scheduler.

### Perbaikan pencegahan
1) **Reuse transaksi aktif**
- Jika user + paket sama masih punya transaksi `PENDING/UNKNOWN` yang belum expired dan masih punya `snap_token`/`redirect_url`, backend akan mengembalikan transaksi itu (tidak membuat order baru).

2) **Rate limit initiate**
- Endpoint `/api/transactions/initiate` dibatasi (default `10 per minute`).
- Di prod disarankan lebih ketat, misalnya:
  - `INITIATE_TRANSACTION_RATE_LIMIT=3 per minute`

3) Opsional: sesuaikan expiry
- `MIDTRANS_DEFAULT_EXPIRY_MINUTES` (default 15) bisa disesuaikan kebutuhan.

### Pembersihan data (rapihkan list admin)
Opsi 1 (disarankan): pakai CLI backend
- Dry-run:
  - `docker compose -f docker-compose.prod.yml exec -T backend flask cleanup-transactions --older-than-days 1`
- Apply:
  - `docker compose -f docker-compose.prod.yml exec -T backend flask cleanup-transactions --older-than-days 1 --apply`

Opsi 2 (langsung SQL, hanya jika memang ingin hapus semua terminal status):
- `delete from transactions where status in ('EXPIRED','FAILED','CANCELLED');`

Catatan: pembersihan hanya menyasar status terminal, **tidak menyentuh SUCCESS**.

## Catatan tambahan
- Jika masih terlihat banyak EXPIRED setelah deploy, cek apakah EXPIRED baru masih muncul:
  - `select count(*) from transactions where status='EXPIRED' and created_at >= now() - interval '30 minutes';`
  - Jika 0, berarti spam sudah berhenti dan yang terlihat hanya data lama.
