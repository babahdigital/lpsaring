# Worklog 2026-02-19

## Ringkasan
Perubahan hari ini fokus ke operasi produksi (Docker di Raspberry Pi), stabilitas transaksi Midtrans, rapihnya data transaksi di admin, dan hardening agar transaksi EXPIRED tidak “spam”.

## Environment Files (Dev vs Prod)
### Dev
- Backend env dev disimpan di folder `backend/`:
  - `backend/.env.public` (non-secret) → gunakan template `backend/.env.public.example`
  - `backend/.env.local` (secret) → gunakan template `backend/.env.local.example`
- Root `.env.public` dipakai untuk frontend/container dev (lihat `.env.public.example`).

### Prod
- Prod memakai file root `lpsaring/.env.prod` (secret) dan `lpsaring/.env.public.prod` (non-secret).
- Template yang tersedia:
  - `.env.prod.example` → salin ke `.env.prod` di server (jangan commit)
  - `.env.public.prod.example` → salin ke `.env.public.prod` di server

### Frontend: Tombol “Hubungi Admin” (WhatsApp deep link)
Frontend membentuk link ke WhatsApp (mis. `https://wa.me/<nomor>?text=...`) menggunakan runtime config Nuxt.

Env yang dipakai (di-root `lpsaring/.env.public.prod`):
- `NUXT_PUBLIC_ADMIN_WHATSAPP=+62...` (nomor admin yang akan dituju)
- `NUXT_PUBLIC_WHATSAPP_BASE_URL=https://wa.me`

Catatan:
- Kalau dua env di atas kosong, tombol “Hubungi Admin” akan menghasilkan href kosong dan klik cenderung tidak mengarah ke WhatsApp.
- Halaman yang memakai config ini: status login/captive (`blocked/fup/habis/inactive/expired/blokir`).

## Docker / Deploy (Raspberry Pi)
### Pola deploy aman (tanpa hapus DB)
Prinsip: **jangan pakai `down -v` dan jangan prune volumes** supaya volume DB/Redis aman.

Perintah yang dipakai:
- `docker compose -f docker-compose.prod.yml pull`
- `docker compose -f docker-compose.prod.yml up -d --force-recreate`
- `docker compose -f docker-compose.prod.yml exec -T backend flask db upgrade`
- verifikasi: `docker compose -f docker-compose.prod.yml ps`

### Masalah yang pernah muncul
- Pull image lambat/timeout → solusi: ulang `pull`, kurangi parallelism (compose), jalankan via SSH one-shot, dan cek `docker compose ps` setelahnya.
- DB tidak boleh hilang → solusi: selalu gunakan `up -d --force-recreate` tanpa `-v`.

## Spam transaksi EXPIRED (kadaluarsa)
### Gejala
- Admin transactions penuh baris status **Kadaluarsa/EXPIRED** dan sering berasal dari user yang sama.

### Akar masalah
- Endpoint initiate transaksi bisa terpanggil berkali-kali (klik ulang/refresh) sehingga membuat banyak order baru.
- Order yang tidak dibayar dalam window expiry otomatis ditandai EXPIRED oleh task scheduler.

### Perbaikan pencegahan
1) **Reuse transaksi aktif**
- Jika user + paket sama masih punya transaksi `PENDING/UNKNOWN` yang belum expired dan masih punya `snap_token`/`redirect_url`, backend akan mengembalikan transaksi itu (tidak membuat order baru).

2) **Rate limit initiate**
- Endpoint `/api/transactions/initiate` dibatasi (default `10 per minute`).
- Di prod disarankan lebih ketat, misalnya:
  - `INITIATE_TRANSACTION_RATE_LIMIT=3 per minute`

3) Opsional: sesuaikan expiry
- `MIDTRANS_DEFAULT_EXPIRY_MINUTES` (default 15) bisa disesuaikan kebutuhan.

### Pembersihan data (rapihkan list admin)
Opsi 1 (disarankan): pakai CLI backend
- Dry-run:
  - `docker compose -f docker-compose.prod.yml exec -T backend flask cleanup-transactions --older-than-days 1`
- Apply:
  - `docker compose -f docker-compose.prod.yml exec -T backend flask cleanup-transactions --older-than-days 1 --apply`

Opsi 2 (langsung SQL, hanya jika memang ingin hapus semua terminal status):
- `delete from transactions where status in ('EXPIRED','FAILED','CANCELLED');`

Catatan: pembersihan hanya menyasar status terminal, **tidak menyentuh SUCCESS**.

## Catatan tambahan
- Jika masih terlihat banyak EXPIRED setelah deploy, cek apakah EXPIRED baru masih muncul:
  - `select count(*) from transactions where status='EXPIRED' and created_at >= now() - interval '30 minutes';`
  - Jika 0, berarti spam sudah berhenti dan yang terlihat hanya data lama.

## Sinkron status MikroTik (blocked/fup/active/habis/expired/inactive)

### Gejala
- Ada user yang masuk ke lebih dari satu address-list status sekaligus (contoh: `blocked` dan `fup`).
- Dampak: user bisa “nyangkut” pada rule lama walaupun status DB sudah berubah.

### Akar masalah
- Saat hard-block `quota debt limit`, backend menambah entry `blocked` tapi tidak memastikan entry status lain terhapus dari IP yang sama.

### Perbaikan
- `blocked` diperlakukan sebagai status paling tinggi dan **eksklusif**.
- Saat user diblokir, entry status lain (`active/fup/inactive/expired/habis`) dibersihkan.
- Saat user tidak blocked, list `blocked` ikut dibersihkan otomatis saat sync status.

### Update lanjutan: multi-device / multi-IP
Perilaku baru: sinkronisasi address-list tidak lagi bergantung pada “1 IP saja”. Sistem akan mengumpulkan **semua kandidat IP** user yang valid, misalnya dari:
- DB `user.devices.ip_address` (device yang pernah terlihat)
- `/ip/hotspot/host` berdasarkan MAC device
- `/ip/hotspot/ip-binding` berdasarkan MAC device (comment → uid)

Lalu apply status address-list untuk setiap IP kandidat (dengan tetap menjaga eksklusivitas status per IP).

Catatan implementasi:
- Perubahan utama ada di `backend/app/services/hotspot_sync_service.py` (commit `2f8a47b2`).

Catatan implementasi:
- Perubahan utama ada di `backend/app/services/hotspot_sync_service.py` (commit `327bd209`).

## Logging Celery (worker/beat)
### Gejala
- Log task Celery (mis. “Memulai sinkronisasi…”, “Skip…”, “Selesai…”) tidak konsisten muncul di `docker logs`.

### Akar masalah
- Celery bisa “hijack” root logger dan handler stdout dari aplikasi tidak selalu kepakai.

### Perbaikan
- Konfigurasi logging Celery dibuat konsisten ke stdout.
- Compose produksi menambah `--logfile=/dev/stdout` untuk worker dan beat.

## CI / Editor warnings (WebHint + markdownlint)
### WebHint: TypeScript config
- Error `typescript-config/is-valid` dari Microsoft Edge Tools muncul karena `.nuxt/tsconfig.json` adalah file generate dan validator tidak selalu kompatibel dengan opsi TS terbaru.
- Mitigasi yang dipakai:
  - Tambah `.hintrc` untuk mematikan hint `typescript-config/is-valid` (false-positive).
  - Tambah `.hintignore` untuk mengabaikan folder generate (`frontend/.nuxt`, `.output`, `.nitro`, dll).
  - Override Nuxt tsconfig agar `.nuxt/tsconfig.json` memakai `compilerOptions.module=ESNext` (menghindari value `preserve`).

### markdownlint
- markdownlint sempat melint file non-markdown seperti `.hintignore` (karena komentar `#` terbaca seperti heading).
- Solusi: tambah `.markdownlintignore` untuk mengecualikan `.hintignore` dan folder generate.

## Deploy ke Raspberry Pi (hasil verifikasi)
Deploy dilakukan via `deploy_pi.sh` dengan SSH:
- user: `abdullah`
- host: `10.10.83.2`
- port: `1983`
- remote dir: `/home/abdullah/sobigidul`

Checklist hasil:
- `docker compose pull` sukses dan container utama direcreate.
- Healthcheck sukses dari dalam Nginx container: `wget -qO- http://127.0.0.1/api/ping`.
- Log `celery_beat` menunjukkan logfile `/dev/stdout` dan log JSON sudah terlihat.

Verifikasi tambahan hari ini:
- `.env.public.prod` sudah berisi `NUXT_PUBLIC_ADMIN_WHATSAPP` + `NUXT_PUBLIC_WHATSAPP_BASE_URL`.
- Container `frontend` menerima env tersebut (cek `printenv | grep NUXT_PUBLIC_...`).
- Audit address-list status di MikroTik menunjukkan tidak ada IP yang berada di lebih dari 1 list status.

Commit terkait hari ini:
- `327bd209` Fix blocked address-list exclusivity; improve Celery logging
- `79157bab` Docs: fix markdownlint; suppress tsconfig webhint false-positive
- `9520e4ad` Chore: ignore hintignore for markdownlint
- `fe00ae4e` Frontend: override TS module to ESNext for webhint compatibility
- `2f8a47b2` MikroTik sync: apply address-list status untuk semua kandidat IP user (multi-device)
