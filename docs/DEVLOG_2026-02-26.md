# Devlog 2026-02-26 (Frontend Beli Final Polish + Deploy Berulang + Klarifikasi Operasional Demo User)

Dokumen ini merangkum update lanjutan dari sesi kerja terbaru, mencakup perubahan UI halaman beli, release/deploy produksi dengan prune, serta keputusan operasional terkait user demo.

## 1) Ringkasan Eksekutif

Fokus utama hari ini:
- Final polish UI kartu paket di halaman beli (`/beli` dan `/captive/beli`) agar lebih konsisten dan nyaman.
- Perbaikan UX mobile:
  - card harga dibuat lebih lebar (tidak terlihat sempit),
  - layout mobile dikunci agar tidak bisa scroll horizontal kiri/kanan.
- Commit + push dilakukan bertahap sesuai perubahan UI.
- Deploy produksi dilakukan berulang menggunakan `deploy_pi.sh --prune` dan seluruh health check lulus.
- Klarifikasi perilaku demo user di backend:
  - mode demo adalah kontrol berbasis ENV,
  - namun user demo dapat tersimpan di DB melalui flow bypass OTP,
  - list user dapat dilihat admin/super admin (dengan filter role khusus untuk admin biasa).

## 2) Timeline Commit Terkait

Commit penting yang tercatat pada sesi lanjutan ini:
- `dd97e488` — `feat(frontend): refine beli UI, branding, legal back-nav, and transparent header/footer`
- `e29a25ff` — `refine package card state visuals and selectable badge behavior`
- `bc0cc199` — `style(frontend): adjust beli package card styling`
- `127f5ae8` — `style(frontend): improve mobile package card width and prevent horizontal scroll`

Catatan:
- Beberapa commit awal di batch ini adalah refinemen visual/UX.
- Dua commit terakhir menutup isu mobile card sempit + horizontal overflow.

## 3) Perubahan Frontend yang Diimplementasikan

Area utama:
- `frontend/pages/beli/index.vue`
- `frontend/pages/captive/beli.vue`

Perubahan styling yang sudah diterapkan:
- Penyesuaian spacing komponen (header card, status chip, action area).
- Penguatan visual card detail paket agar lebih kontras dan terbaca.
- Penyelarasan tipografi subtitle hero agar lebih konsisten.
- Perbaikan mobile-specific:
  - `overflow-x: hidden` pada container halaman.
  - `package-grid` tanpa margin negatif di mobile.
  - `package-grid-col` tanpa padding horizontal di mobile.
  - `package-card` menggunakan `max-width: 100%` di mobile.

Dampak UX:
- Card paket tampil lebih penuh (lebih lebar) pada layar kecil.
- Tidak ada lagi geser horizontal yang mengganggu saat interaksi di mobile.

## 4) Klarifikasi Operasional: Demo User

### 4.1 Sumber status demo
Status demo ditentukan oleh konfigurasi ENV (bukan kolom tetap di tabel user), termasuk:
- `DEMO_MODE_ENABLED`
- `DEMO_ALLOW_ANY_PHONE`
- `DEMO_ALLOWED_PHONES`

### 4.2 Persistensi user demo
- Ketika flow OTP bypass demo aktif dan user belum ada, backend dapat membuat record `User` baru (contoh nama fallback: `Demo User XXXX`).
- Konsekuensi: user demo bisa muncul di daftar user admin karena data memang tersimpan di DB.

### 4.3 Jika demo mode dimatikan
- Menonaktifkan demo mode **tidak otomatis menghapus** user yang sudah terbuat sebelumnya.
- User existing tetap ada sampai dilakukan tindakan manual (delete/deactivate melalui alur admin).

### 4.4 Siapa yang bisa melihat daftar user
- Endpoint list user bersifat admin-protected (`admin_required`), jadi bisa diakses admin dan super admin.
- Admin biasa tidak melihat akun super admin karena query list memfilter role `SUPER_ADMIN`.

### 4.5 Perilaku hapus user (otorisasi)
- Super admin: dapat menghapus permanen user (hard delete) sesuai aturan service.
- Admin biasa: aksi delete diproses sebagai nonaktifkan user (bukan hard delete) dan tidak bisa menarget admin lain/super admin.

## 5) Deploy Produksi (dengan Prune)

Deploy dilakukan memakai script:
- `bash ./deploy_pi.sh --host 10.10.83.2 --user abdullah --port 1983 --remote-dir /home/abdullah/sobigidul --prune`

Ringkasan hasil deploy berulang:
- File produksi tersinkron (`docker-compose.prod.yml`, `.env.prod`, `.env.public.prod`, config nginx).
- Prune berhasil menghapus resource Docker yang tidak terpakai (container/image), volume tetap dipertahankan.
- Service penting berhasil running:
  - `frontend`
  - `backend`
  - `celery_worker`
  - `celery_beat`
  - `db`
  - `redis`
  - `nginx`
  - `cloudflared`
- Readiness frontend OK.
- Health check backend OK (`/api/ping` mengembalikan `pong`).

## 6) Validasi yang Tercatat

- Validasi file frontend setelah patch mobile:
  - `frontend/pages/beli/index.vue` → no errors.
  - `frontend/pages/captive/beli.vue` → no errors.
- Repo state setelah commit/push:
  - working tree clean,
  - branch `main` sinkron dengan `origin/main`.

## 7) Risiko, Mitigasi, dan Catatan Lanjutan

Risiko rendah-menengah:
- Perubahan CSS global lokal ke halaman beli berpotensi mempengaruhi spacing elemen tertentu pada breakpoint kecil.

Mitigasi yang sudah dilakukan:
- Scope perubahan dibatasi ke 2 halaman target.
- Verifikasi sintaks dan error editor dilakukan pasca-edit.
- Deploy disertai readiness + health check.

Saran lanjutan:
- Tambahkan screenshot baseline mobile untuk `/beli` dan `/captive/beli` agar regresi visual lebih cepat terdeteksi.
- Jika diperlukan kebijakan pembersihan akun demo, buat SOP cleanup berkala (manual review + delete/deactivate sesuai role).

## 8) Penutup

Batch 2026-02-26 ditutup dengan status:
- UI mobile card beli sudah lebih proporsional dan stabil,
- deploy produksi sukses dengan `--prune`,
- dokumentasi keputusan operasional demo user sudah diperjelas,
- repo dalam kondisi bersih dan sinkron.

---

## Addendum 2026-02-26 (Hardening FE/BE + E2E Sign-off Publish)

Addendum ini melengkapi batch pada hari yang sama untuk pekerjaan hardening arsitektur dan validasi pra-publish.

### A) Refactor/Hardening Backend

- Reconcile transaksi auth/public dipusatkan ke service tunggal:
  - `backend/app/infrastructure/http/transactions/reconcile_service.py`
- `auth_routes.py` didelegasikan ke bounded-context handlers (termasuk verify OTP):
  - `backend/app/infrastructure/http/auth_contexts/verify_otp_handlers.py`
- Helper debt dipisah dari façade transaksi:
  - `backend/app/infrastructure/http/transactions/debt_helpers.py`
- Helper Midtrans/date/QR dipisah agar façade route lebih tipis:
  - `backend/app/infrastructure/http/transactions/midtrans_helpers.py`

### B) Refactor/Hardening Frontend

- Policy guard auth/maintenance dipusatkan:
  - `frontend/utils/authRoutePolicy.ts`
  - `frontend/utils/authGuardDecisions.ts`
- Decomposition `payment/finish.vue` ke komponen presentational:
  - `StatusHeader.vue`
  - `StatusActionButtons.vue`
  - `PendingPaymentInstructions.vue`
  - `PaymentSummaryPanel.vue`

### C) Kualitas Kontrak & Observability

- Contract tests payload semantic ditambahkan:
  - `backend/tests/test_openapi_contract_payload_shapes.py`
- Structured transaction logging diperkuat, termasuk `request_id` pada jalur reconcile.
- Workspace search hygiene diperkuat:
  - `.vscode/settings.json` mengecualikan `.nuxt/.output/.nitro/node_modules/.pnpm-store`.

### D) Validasi Test (Latest)

- Backend focused regression (expanded): **33 passed**.
- Frontend focused regression (expanded): **6 files, 38 tests passed**.

### E) E2E Final Sign-off

- Script existing dijalankan penuh (isolated compose, OTP-only mode):
  - `scripts/simulate_end_to_end.ps1`
- Hasil: mencapai tahap **[17/17]** dan **Done**.
- Tidak perlu patch script E2E tambahan untuk batch ini.

### F) Kesimpulan Publish Readiness

- Batch hardening dinyatakan siap publish.
- Rekomendasi operasional tetap: monitoring 24 jam pertama (auth error rate, payment status transition, webhook success/failure ratio).
