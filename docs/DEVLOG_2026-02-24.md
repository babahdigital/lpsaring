# Devlog 2026-02-24 (Ops + Payment + Debt)

Dokumen ini merangkum pekerjaan end-to-end berdasarkan **history commit** dan **percakapan troubleshooting**: perubahan fitur, bug/insiden yang muncul, analisis akar masalah, dan langkah penyelesaian.

> Catatan keamanan: dokumen ini **tidak** menyertakan credential/token/secret. Jika Anda butuh contoh command, pastikan nilai secret tetap di `.env.prod` dan tidak ditulis di repo.

## 1) Ringkasan

Fokus utama hari ini:
- Memastikan mode pembayaran produksi (Midtrans) konsisten: **Snap** vs **Core API**.
- Menyempurnakan UX pembayaran saat **Core API aktif**:
  - GoPay/ShopeePay bisa **langsung redirect ke deeplink** (jika tersedia).
  - QRIS/VA diarahkan ke halaman status/finish.
- Menyamakan alur **Pelunasan Tunggakan (Lunasi)** dengan alur **Beli**:
  - Popup pilih metode pembayaran saat Core API aktif.
  - Snap mode tetap langsung membuka Snap.
- Perbaikan **estimasi harga hutang kuota** (contoh kasus 25GB harusnya 200k, bukan 250k).
- Perbaikan lint/CI (Ruff) setelah refactor.
- Operasional: deploy dengan `--prune` (aman, tidak hapus volume), serta operasi khusus user (reset quota + set hutang manual + sync MikroTik).

## 2) Timeline Commit (ringkas)

Commit penting pada 2026-02-24:
- `bfe6c100` — fix(debt): correct estimate + core-api debt payment flow
- `1ad26da6` — fix(ruff): remove undefined cheapest_pkg_name
- `328622de` — fix(ui): samakan popup lunasi dengan beli
- `95c2770a` — fix(riwayat): popup metode lunasi per item

Ada beberapa commit lain terkait responsif UI admin/settings dan layout mobile (lihat `git log`).

## 3) Perubahan Frontend (Nuxt 3 + Vuetify)

### 3.1 Core API: redirect deeplink untuk GoPay/ShopeePay
Tujuan:
- Saat Core API aktif, jika backend mengembalikan `redirect_url` untuk metode GoPay/ShopeePay, maka frontend **langsung redirect**.
- Jika `redirect_url` tidak ada/gagal, fallback ke `/payment/status`.

Area terdampak:
- Halaman beli paket:
  - `frontend/pages/beli/index.vue`
  - `frontend/pages/captive/beli.vue`
- Pelunasan tunggakan:
  - `frontend/composables/useDebtSettlementPayment.ts`

### 3.2 Popup metode pembayaran untuk pelunasan (Lunasi)
Tujuan:
- Alur Lunasi dibuat setara dengan Beli:
  - Core API aktif → tampil dialog pilih metode (QRIS/GoPay/ShopeePay/VA + pilihan bank VA).
  - Snap mode → langsung Snap (tanpa dialog).

Area terdampak:
- `frontend/pages/dashboard/index.vue`
- `frontend/pages/riwayat/index.vue`

Penyempurnaan:
- Style dialog disamakan dengan dialog di `/beli` dan `/captive/beli`.
- Riwayat: tombol **Lunasi per item hutang (per tanggal)** juga ikut punya popup saat Core API aktif.

### 3.3 Bug 422 pelunasan: event Vue terkirim ke backend
Gejala:
- Backend mengembalikan 422 pada endpoint pelunasan hutang.

Akar masalah:
- Handler Vue `@click="payDebt"` mengirim `$event` (MouseEvent) sebagai argumen pertama.
- Backend menganggap argumen tersebut adalah `manual_debt_id` dan memvalidasi sebagai UUID → gagal.

Solusi:
- Ubah pemanggilan menjadi `payDebt()` sehingga tidak menerima event.
- Setelah itu, dialog metode pembayaran ditambahkan agar konsisten.

## 4) Perubahan Backend (Flask + SQLAlchemy + Alembic)

### 4.1 Perbaikan estimasi harga hutang kuota
Kasus:
- User punya hutang manual 25GB.
- Estimasi sebelumnya salah (contoh terbaca 250k), padahal paket 25GB (Paket Pintar) adalah 200k.

Akar masalah:
- Estimasi memilih paket referensi berdasarkan **harga termurah**, bukan paket yang sesuai dengan **besar kuota hutang**.

Solusi:
- Ubah pemilihan paket referensi menjadi:
  - pilih paket dengan `data_quota_gb >= debt_gb` yang paling kecil (closest-fit),
  - jika tidak ada yang cukup, fallback ke paket terbesar.
- Terapkan konsisten di beberapa lokasi yang sebelumnya menghitung estimasi.

File terdampak (ringkas):
- `backend/app/infrastructure/http/user/data_routes.py` (response `/me/quota`)
- `backend/app/infrastructure/http/transactions_routes.py`
- `backend/app/services/hotspot_sync_service.py`
- `backend/app/tasks.py`
- `backend/app/infrastructure/http/admin_routes.py`
- `backend/app/infrastructure/http/admin/user_management_routes.py`

### 4.2 Presisi perhitungan auto-debt
Masalah:
- Potensi drift float pada perhitungan MB (penjumlahan/pengurangan bisa menghasilkan angka pecahan yang tidak stabil).

Solusi:
- Gunakan `Decimal(str(value))` dan quantize untuk stabilitas.

File terdampak:
- `backend/app/utils/quota_debt.py`

### 4.3 Hotfix Ruff (CI)
Masalah:
- Ruff gagal dengan `F821 Undefined name cheapest_pkg_name`.

Akar masalah:
- Variabel lama tersisa setelah refactor estimasi hutang.

Solusi:
- Ganti referensi variabel ke nama yang benar (`base_pkg_name` / `est_total.package_name` sesuai konteks).

Commit:
- `1ad26da6`

## 5) Operasional / Deploy / Recovery

### 5.1 Deploy produksi dengan `deploy_pi.sh --prune`
Perilaku penting di `deploy_pi.sh`:
- `--prune` menjalankan safe prune:
  - `docker container/image/network/builder prune`
  - **Tidak** menghapus volume.
- `--clean` menjalankan:
  - `docker compose down -v --remove-orphans`
  - ini **menghapus volume** (termasuk data Postgres), sehingga jangan dipakai kecuali memang ingin reset total.

Contoh (tanpa secret):
- `bash ./deploy_pi.sh --host <PI_HOST> --user <USER> --port <PORT> --remote-dir <DIR> --prune`

Verifikasi:
- Script melakukan healthcheck via container nginx ke `http://127.0.0.1/api/ping`.

### 5.2 Insiden data hilang karena down -v (ringkas)
Gejala:
- Setelah deploy tertentu yang melibatkan `down -v`, volume Postgres hilang → DB kosong.

Penyelesaian (high level):
- Restore dari backup `.sql`/dump.
- Karena ada mismatch versi tooling (backup dari pg_dump lebih baru dibanding Postgres 15), restore dilakukan menggunakan tooling yang kompatibel.
- Jalankan Alembic migration setelah restore.
- Verifikasi row counts dan endpoint backend.

> Rekomendasi: di produksi, jadikan `--clean` sebagai opsi yang jarang dipakai dan diberi warning (sudah ada di `deploy_pi.sh`).

## 6) Operasi Khusus User: reset quota + set hutang + sync MikroTik

Permintaan ops:
- Reset quota user tertentu, lalu set 10GB sebagai hutang (unpaid), dan sync MikroTik.

Yang dilakukan:
- Update `users`:
  - `total_quota_purchased_mb=10240`, `total_quota_used_mb=0`, `manual_debt_mb=10240`, `is_blocked=false`.
- Tambah ledger hutang:
  - insert ke `user_quota_debts` amount 10240, `paid_mb=0`, `is_paid=false`.
- Jalankan `sync_address_list_for_single_user(user)`.

Catatan penting:
- Setelah reset used ke 0, job sync usage dari MikroTik bisa segera mengupdate `total_quota_used_mb` lagi (mis. jadi 104MB). Untuk benar-benar “baseline” dari nol, lakukan reset used lagi **setelah** sync.

## 7) Checklist Verifikasi

Frontend:
- `pnpm run typecheck` (OK)
- Manual check:
  - /beli: Core API GoPay/ShopeePay redirect langsung jika ada `redirect_url`.
  - /dashboard, /riwayat: Lunasi membuka dialog metode saat Core API.
  - /riwayat: Lunasi per item hutang membuka dialog metode saat Core API.

Backend:
- `ruff check` lulus setelah hotfix.
- Endpoint `/api/ping` OK setelah deploy.

Ops:
- Deploy dengan `--prune` sukses, `db` dan `redis` healthy.

## 8) Pelajaran & Rekomendasi

- Hindari `docker compose down -v` di produksi kecuali memang ingin reset total.
- Saat mengikat handler Vue, gunakan `@click="fn()"` bila fungsi tidak mengharapkan parameter; ini mencegah `$event` bocor menjadi argumen.
- Estimasi hutang harus berbasis “best fit by quota”, bukan “cheapest by price”.
- Untuk operasi reset quota, perhatikan proses sync usage yang bisa segera menambah usage dari sumber eksternal.
