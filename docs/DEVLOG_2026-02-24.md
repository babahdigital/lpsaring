# Devlog 2026-02-24 (Ops + Payment + Debt)

Dokumen ini merangkum pekerjaan end-to-end berdasarkan **history commit** dan **percakapan troubleshooting**: perubahan fitur, bug/insiden yang muncul, analisis akar masalah, dan langkah penyelesaian.

> Catatan keamanan: dokumen ini **tidak** menyertakan credential/token/secret. Jika Anda butuh contoh command, pastikan nilai secret tetap di `.env.prod` dan tidak ditulis di repo.

## 1) Ringkasan

Fokus utama hari ini:
- Memastikan mode pembayaran produksi (Midtrans) konsisten: **Snap** vs **Core API**.
- Menyempurnakan UX pembayaran saat **Core API aktif**:
  - GoPay/ShopeePay bisa **langsung redirect ke deeplink** (jika tersedia).
  - QRIS/VA diarahkan ke halaman status/finish.
- Menyamakan alur **Pelunasan Tunggakan (Lunasi)** dengan alur **Beli**:
  - Popup pilih metode pembayaran saat Core API aktif.
  - Snap mode tetap langsung membuka Snap.
- Perbaikan **estimasi harga hutang kuota** (contoh kasus 25GB harusnya 200k, bukan 250k).
- Perbaikan lint/CI (Ruff) setelah refactor.
- Operasional: deploy dengan `--prune` (aman, tidak hapus volume), serta operasi khusus user (reset quota + set hutang manual + sync MikroTik).
- Tambahan: prefix order_id pelunasan tunggakan kini configurable via env `DEBT_ORDER_ID_PREFIX` (kompatibel dengan order lama `DEBT-...`).

## 2) Timeline Commit (ringkas)

Commit penting pada 2026-02-24:
- `bfe6c100` — fix(debt): correct estimate + core-api debt payment flow
- `1ad26da6` — fix(ruff): remove undefined cheapest_pkg_name
- `328622de` — fix(ui): samakan popup lunasi dengan beli
- `95c2770a` — fix(riwayat): popup metode lunasi per item
- `253ae4d8` — feat(payments): configurable debt order_id prefix

Ada beberapa commit lain terkait responsif UI admin/settings dan layout mobile (lihat `git log`).

## 3) Perubahan Frontend (Nuxt 3 + Vuetify)

### 3.1 Core API: redirect deeplink untuk GoPay/ShopeePay
Tujuan:
- Saat Core API aktif, jika backend mengembalikan `redirect_url` untuk metode GoPay/ShopeePay, maka frontend **langsung redirect**.
- Jika `redirect_url` tidak ada/gagal, fallback ke `/payment/status?order_id=...` (dan pertahankan `&t=...` jika tersedia).

Area terdampak:
- Halaman beli paket:
  - `frontend/pages/beli/index.vue`
  - `frontend/pages/captive/beli.vue`
- Pelunasan tunggakan:
  - `frontend/composables/useDebtSettlementPayment.ts`

### 3.2 Popup metode pembayaran untuk pelunasan (Lunasi)
Tujuan:
- Alur Lunasi dibuat setara dengan Beli:
  - Core API aktif → tampil dialog pilih metode (QRIS/GoPay/ShopeePay/VA + pilihan bank VA).
  - Snap mode → langsung Snap (tanpa dialog).

Area terdampak:
- `frontend/pages/dashboard/index.vue`
- `frontend/pages/riwayat/index.vue`

Penyempurnaan:
- Style dialog disamakan dengan dialog di `/beli` dan `/captive/beli`.
- Riwayat: tombol **Lunasi per item hutang (per tanggal)** juga ikut punya popup saat Core API aktif.

### 3.3 Bug 422 pelunasan: event Vue terkirim ke backend
Gejala:
- Backend mengembalikan 422 pada endpoint pelunasan hutang.

Akar masalah:
- Handler Vue `@click="payDebt"` mengirim `$event` (MouseEvent) sebagai argumen pertama.
- Backend menganggap argumen tersebut adalah `manual_debt_id` dan memvalidasi sebagai UUID → gagal.

Solusi:
- Ubah pemanggilan menjadi `payDebt()` sehingga tidak menerima event.
- Setelah itu, dialog metode pembayaran ditambahkan agar konsisten.

## 4) Perubahan Backend (Flask + SQLAlchemy + Alembic)

### 4.1 Perbaikan estimasi harga hutang kuota
Kasus:
- User punya hutang manual 25GB.
- Estimasi sebelumnya salah (contoh terbaca 250k), padahal paket 25GB (Paket Pintar) adalah 200k.

Akar masalah:
- Estimasi memilih paket referensi berdasarkan **harga termurah**, bukan paket yang sesuai dengan **besar kuota hutang**.

Solusi:
- Ubah pemilihan paket referensi menjadi:
  - pilih paket dengan `data_quota_gb >= debt_gb` yang paling kecil (closest-fit),
  - jika tidak ada yang cukup, fallback ke paket terbesar.
- Terapkan konsisten di beberapa lokasi yang sebelumnya menghitung estimasi.

File terdampak (ringkas):
- `backend/app/infrastructure/http/user/data_routes.py` (response `/me/quota`)
- `backend/app/infrastructure/http/transactions_routes.py`
- `backend/app/services/hotspot_sync_service.py`
- `backend/app/tasks.py`
- `backend/app/infrastructure/http/admin_routes.py`
- `backend/app/infrastructure/http/admin/user_management_routes.py`

### 4.2 Presisi perhitungan auto-debt
Masalah:
- Potensi drift float pada perhitungan MB (penjumlahan/pengurangan bisa menghasilkan angka pecahan yang tidak stabil).

Solusi:
- Gunakan `Decimal(str(value))` dan quantize untuk stabilitas.

File terdampak:
- `backend/app/utils/quota_debt.py`

### 4.3 Hotfix Ruff (CI)
Masalah:
- Ruff gagal dengan `F821 Undefined name cheapest_pkg_name`.

Akar masalah:
- Variabel lama tersisa setelah refactor estimasi hutang.

Solusi:
- Ganti referensi variabel ke nama yang benar (`base_pkg_name` / `est_total.package_name` sesuai konteks).

Commit:
- `1ad26da6`

## 5) Operasional / Deploy / Recovery

### 5.1 Deploy produksi dengan `deploy_pi.sh --prune`
Perilaku penting di `deploy_pi.sh`:
- `--prune` menjalankan safe prune:
  - `docker container/image/network/builder prune`
  - **Tidak** menghapus volume.
- `--clean` menjalankan:
  - `docker compose down -v --remove-orphans`
  - ini **menghapus volume** (termasuk data Postgres), sehingga jangan dipakai kecuali memang ingin reset total.

Contoh (tanpa secret):
- `bash ./deploy_pi.sh --host <PI_HOST> --user <USER> --port <PORT> --remote-dir <DIR> --prune`

Verifikasi:
- Script melakukan healthcheck via container nginx ke `http://127.0.0.1/api/ping`.

### 5.2 Insiden data hilang karena down -v (ringkas)
Gejala:
- Setelah deploy tertentu yang melibatkan `down -v`, volume Postgres hilang → DB kosong.

Penyelesaian (high level):
- Restore dari backup `.sql`/dump.
- Karena ada mismatch versi tooling (backup dari pg_dump lebih baru dibanding Postgres 15), restore dilakukan menggunakan tooling yang kompatibel.
- Jalankan Alembic migration setelah restore.
- Verifikasi row counts dan endpoint backend.

> Rekomendasi: di produksi, jadikan `--clean` sebagai opsi yang jarang dipakai dan diberi warning (sudah ada di `deploy_pi.sh`).

## 6) Operasi Khusus User: reset quota + set hutang + sync MikroTik

Permintaan ops:
- Reset quota user tertentu, lalu set 10GB sebagai hutang (unpaid), dan sync MikroTik.

Yang dilakukan:
- Update `users`:
  - `total_quota_purchased_mb=10240`, `total_quota_used_mb=0`, `manual_debt_mb=10240`, `is_blocked=false`.
- Tambah ledger hutang:
  - insert ke `user_quota_debts` amount 10240, `paid_mb=0`, `is_paid=false`.
- Jalankan `sync_address_list_for_single_user(user)`.

Catatan penting:
- Setelah reset used ke 0, job sync usage dari MikroTik bisa segera mengupdate `total_quota_used_mb` lagi (mis. jadi 104MB). Untuk benar-benar “baseline” dari nol, lakukan reset used lagi **setelah** sync.

## 7) Checklist Verifikasi

Frontend:
- `pnpm run typecheck` (OK)
- Manual check:
  - /beli: Core API GoPay/ShopeePay redirect langsung jika ada `redirect_url`.
  - /dashboard, /riwayat: Lunasi membuka dialog metode saat Core API.
  - /riwayat: Lunasi per item hutang membuka dialog metode saat Core API.

Backend:
- `ruff check` lulus setelah hotfix.
- Endpoint `/api/ping` OK setelah deploy.

Ops:
- Deploy dengan `--prune` sukses, `db` dan `redis` healthy.

## 8) Pelajaran & Rekomendasi

- Hindari `docker compose down -v` di produksi kecuali memang ingin reset total.
- Saat mengikat handler Vue, gunakan `@click="fn()"` bila fungsi tidak mengharapkan parameter; ini mencegah `$event` bocor menjadi argumen.
- Estimasi hutang harus berbasis “best fit by quota”, bukan “cheapest by price”.
- Untuk operasi reset quota, perhatikan proses sync usage yang bisa segera menambah usage dari sumber eksternal.

## 9) UI/UX: Admin Settings + Layout Mobile (Admin & User)

Bagian ini merangkum pekerjaan UI yang terjadi di sesi yang sama (iteratif berdasarkan feedback mobile/portrait), dengan prinsip: **tidak mengubah fungsi**, hanya memperbaiki tampilan/layout/responsif.

### 9.1 Admin Settings — responsif, conditional, konsisten wrapper component
Tujuan:
- Layout rapi di desktop & mobile.
- Tidak ada horizontal scroll di portrait.
- Conditional section jelas untuk **Midtrans Snap** vs **Core API**.

Perubahan penting:
- `PAYMENT_PROVIDER_MODE=snap`:
  - Sembunyikan checklist `CORE_API_ENABLED_PAYMENT_METHODS`.
  - Sembunyikan checklist `CORE_API_ENABLED_VA_BANKS`.
- `PAYMENT_PROVIDER_MODE=core_api`:
  - Tampilkan checklist metode pembayaran.
  - Checklist bank VA hanya tampil jika opsi VA aktif.
- Komponen form diseragamkan ke wrapper (mis. `AppSelect`, `AppTextField`, `AppTextarea`) agar label/spacing konsisten.

Commit terkait (ringkas):
- `1eaf27d6` — refactor(admin settings): responsive layout + conditional payment sections
- `73aedccc` — fix(admin settings): restore top tabs and normalize alignment
- `5574c30c` — fix(settings ui): right-align switches and improve mobile spacing
- `c9725a0d` — fix(settings mobile): full-width actions, left switches, no horizontal scroll
- `1a308b49` — fix(mobile layout): align section headers and reduce boxed padding
- `354641c0` — fix(portrait): clickable tabs, aligned header padding, no x-scroll

### 9.2 Layout Mobile — selaraskan “lebar terasa” antara /admin dan halaman user
Gejala (mobile/portrait):
- Ada gap kiri/kanan di navbar/footer (ikon terasa “mepet”).
- Halaman user (dashboard/akun/riwayat) terasa lebih sempit dibanding /admin.

Akar masalah:
- Beberapa halaman user memakai `VContainer fluid` yang memiliki gutter/padding default.
- Layout wrapper juga memberi padding mobile.
- Akibatnya terjadi **double padding** → card/body tampak sempit.

Solusi:
- Pada mobile, layout tetap jadi “source of truth” untuk padding inline konten.
- `VContainer` di dalam `.layout-page-content` di-set `padding-inline: 0` (mobile saja) untuk mencegah padding bertumpuk.
- Navbar/footer diselaraskan padding-inline dengan `.layout-page-content` agar edge konsisten.

Commit terkait (ringkas):
- `c3b451b5` — Fix mobile navbar/footer padding alignment
- `c57c47a1` — Fix mobile double padding for VContainer

### 9.3 Navbar edge spacing (ikon hamburger/ avatar)
Gejala:
- Ikon hamburger tertarik terlalu ke kiri (terlihat “nempel” tepi).

Akar masalah:
- Class `ms-n3` (margin-start negatif) pada tombol toggle nav di mobile.

Solusi:
- Hapus margin negatif tersebut agar ada ruang lega kiri/kanan tanpa mengubah fungsi.

Commit terkait:
- `9611d322` — Fix mobile navbar edge spacing

### 9.4 Dashboard User: hapus judul yang dianggap tidak perlu
Perubahan:
- Teks judul “Dashboard Pengguna” di header dihapus (header tetap rapi).

Commit terkait:
- `d47dc7e3` — Remove user dashboard page title

### 9.5 Verifikasi
- `pnpm run typecheck` (frontend) harus lulus.
- Mobile manual check:
  - Portrait: tidak ada scroll horizontal.
  - Navbar: ikon tidak mepet edge.
  - Lebar card/body: konsisten dengan /admin.

## 10) Deploy: CI guard `--wait-ci` + catatan token

### 10.1 Kenapa perlu `--wait-ci`
Masalah ops yang sering terjadi:
- Deploy dilakukan segera setelah push, tetapi image Docker `:latest` belum ter-publish oleh GitHub Actions.
- Akibatnya `docker compose pull` di Pi masih mengambil digest lama.

Solusi:
- Tambah opsi `--wait-ci` pada `deploy_pi.sh` untuk menunggu checks/Actions hijau sebelum deploy.

Commit terkait:
- `edb2b453` — feat(deploy): add --wait-ci guard before deploy

### 10.2 Syarat `--wait-ci`
- Membutuhkan `GH_TOKEN` atau `GITHUB_TOKEN` di environment (untuk akses GitHub API checks).
- Praktik aman: token hanya di environment lokal/CI, **jangan** ditulis di repo.

Catatan penting (Windows/terminal):
- Token yang di-export di satu terminal tidak otomatis tersedia di terminal/sesi lain.
- Jika menjalankan deploy dari tool/terminal berbeda, pastikan token benar-benar terbaca di sesi yang sama.

## 11) Ops: Cloudflare Tunnel “error” (ringkas diagnosis)

Gejala:
- Browser menunjukkan error Cloudflare/origin.

Diagnosis yang perlu:
- Cek `docker compose ps` semua service Up.
- Cek `cloudflared` log untuk melihat apakah error terjadi di hostname utama atau rule lain.
- Validasi origin via Nginx container:
  - `wget -qO- http://127.0.0.1/` (homepage)
  - `wget -qO- http://127.0.0.1/api/ping` (backend)

Catatan:
- Log `cloudflared` bisa menunjukkan origin down untuk hostname lain (mis. ingress rule berbeda), sementara domain utama tetap OK.
