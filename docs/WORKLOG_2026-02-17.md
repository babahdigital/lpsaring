# Work Log — 2026-02-17

Dokumen ini melanjutkan work log sebelumnya dan merangkum pekerjaan end-to-end pada proyek **lpsaring**: masalah yang ditemui, akar penyebab, solusi, perubahan yang dilakukan, serta cara verifikasinya.

Lampiran wajib:
- [.github/copilot-instructions.md](../.github/copilot-instructions.md)

Work log sebelumnya:
- [WORKLOG_2026-02-16.md](WORKLOG_2026-02-16.md)

## Ringkas

**Target utama yang dikerjakan**
- Audit & perbaikan dukungan nomor telepon **14 digit** dan **internasional** agar konsisten (E.164) dan tidak bisa bypass limiter.
- Menambahkan tooling **opsional** untuk sinkronisasi/normalisasi `users.phone_number` di produksi (report + apply).
- Mengurangi **noise/spam** WhatsApp notifikasi kuota: hilangkan low-quota 20% (duplikat FUP 20%) dan 10%, cukup low-quota 5%.
- Memperbaiki **tooltip ApexCharts** yang redundant (muncul dobel/berulang) di dashboard admin.

## 1) Nomor telepon internasional & 14 digit (E.164)

### Masalah
- Input nomor telepon user bervariasi (`08...`, `+62...`, `00...`, digits-only negara lain).
- Sebelum fix, beberapa komponen anti-abuse masih memakai **nomor mentah** sebagai key:
  - key Redis OTP,
  - cooldown,
  - fail counter,
  - rate-limit key.

Efeknya:
- Potensi mismatch OTP (request/verify pakai format beda → key Redis beda).
- Potensi bypass limiter (ubah format input → key limiter berubah).

### Akar penyebab
- Normalisasi E.164 tidak diterapkan secara konsisten pada seluruh jalur:
  - request OTP,
  - verify OTP,
  - registrasi.
- Keying/lookup tidak selalu menggunakan format kanonik.

### Solusi
- Menetapkan format kanonik **E.164** untuk:
  - penyimpanan DB (`users.phone_number`),
  - key Redis OTP (otp/cooldown/fail),
  - limiter key.

Aturan ringkas normalisasi:
- Indonesia: input `08xxx` diterima (dipetakan ke `+62...`).
- Internasional: gunakan `+` / `00` / atau digits-only dengan country code (sesuai normalizer).
- Input ambigu `0` selain `08...` ditolak (menghindari salah interpretasi).

### Perubahan
- Backend normalisasi E.164 dipertegas dan dipakai pada jalur auth.
- Test ditambahkan untuk kasus nomor 14 digit dan contoh internasional.

### Verifikasi
- Unit test formatters (backend) harus hijau.
- E2E isolated stack berhasil menyimpan nomor `+<countrycode>...` di DB untuk input internasional.

## 2) Tooling produksi: normalisasi nomor telepon existing

### Masalah
- Data legacy `users.phone_number` bisa berisi format campuran (sebelum kebijakan E.164 ketat).
- Diperlukan tooling yang aman untuk:
  - scan seluruh user,
  - report invalid,
  - report duplikat hasil normalisasi,
  - apply hanya bila aman.

### Solusi
- Ditambahkan script:
  - `backend/scripts/normalize_phone_numbers.py`

Fitur:
- Default **dry-run**: hanya report.
- `--apply`: apply update ke DB.
- Deteksi **duplikat** E.164 (refuse apply kecuali override).

### Integrasi deploy
- `deploy_pi.sh` ditambah flag:
  - `--sync-phones` (dry-run report)
  - `--sync-phones-apply` (apply)

### Catatan operasional
- Saat menjalankan script di container, gunakan interpreter venv (`/opt/venv/bin/python`) agar dependency tersedia.
- Gunakan working directory `/app` dan/atau `PYTHONPATH=/app` untuk memastikan `from app import create_app` bisa di-import.

### Verifikasi
- Dry-run report di produksi harus menampilkan summary (total/invalid/duplicates/would change).
- Jika `Would change=0` dan `Duplicates=0`, tidak perlu `--apply`.

## 3) WhatsApp: kurangi noise notifikasi kuota (anti-spam)

### Masalah
Pada kondisi tertentu user menerima notifikasi beruntun yang terasa spam:
- **FUP 20%** (status masuk FUP)
- **Low quota 20%** (redundan dengan FUP 20%)
- Low quota 10%
- Low quota 5%

Target yang disepakati:
- Di 20% cukup 1 notifikasi: **FUP**.
- Low-quota cukup **5%**.

### Akar penyebab
- Low-quota thresholds default masih `[20, 10, 5]`.
- Ada notifikasi status FUP yang terpisah ketika profil MikroTik berubah ke FUP.

### Solusi
1) Backend: ubah default low-quota threshold menjadi `[5]` (dan filter <= 5) agar tidak mengirim 20% dan 10%.
2) Produksi: set setting DB `application_settings`:
   - `QUOTA_NOTIFY_PERCENTAGES = [5]`

Catatan:
- Notifikasi WhatsApp juga sudah punya rate-limit Redis (global & per-target) dan circuit breaker.
- Template notifikasi mendukung spintax (`{opsi1|opsi2}`) untuk teks dinamis.

### Verifikasi
- Cek setting DB:
  - `QUOTA_NOTIFY_PERCENTAGES` harus `[5]`.
- Cek source running container:
  - `_send_quota_notifications` memakai default `[5]` dan filter `<= 5`.

## 4) Frontend: tooltip ApexCharts redundant (Paket Terlaris)

### Masalah
Tooltip donut chart "Paket Terlaris" menampilkan baris yang sama berulang (redundan), sehingga terlihat seperti spam UI.

### Akar penyebab
Di halaman dashboard admin terdapat override CSS:
- `.apexcharts-tooltip-series-group { display: flex !important; }`

Override tersebut memaksa **semua** series group tooltip tampil, padahal ApexCharts menyembunyikan group yang tidak aktif.

### Solusi
Perbaiki CSS supaya:
- hanya `.apexcharts-tooltip-series-group.apexcharts-active` yang tampil,
- non-aktif tetap `display: none`.

### Catatan deploy
Saat deploy image frontend `latest`:
- Jika `docker compose pull` dijalankan **sebelum** workflow publish hijau, host bisa menarik image lama.
- Solusi operasional bila perlu force refresh:
  - stop & remove container,
  - remove image tag `latest`,
  - pull ulang,
  - `up -d`.

### Verifikasi
- Setelah update frontend, tooltip harus menampilkan **satu** baris sesuai slice yang di-hover.

## Checklist akhir (yang dipakai saat sesi ini)

- Produksi sehat: `/api/ping` via container nginx.
- Backend terbaru ter-pull (image digest berubah) dan container restart.
- Frontend terbaru ter-pull (image digest berubah) dan container restart.
- DB setting `QUOTA_NOTIFY_PERCENTAGES=[5]` tersimpan.

---

## 5) Quota-debt cap: hard block saat hutang melewati limit

### Masalah
Dengan kebijakan “kuota habis masih boleh akses banking/pay/WA”, pemakaian bisa terus bertambah dan menghasilkan:
- `used_mb > purchased_mb` → **hutang kuota (debt)**.

Jika tidak dibatasi, debt bisa membesar (transparansi cukup internal, user tidak perlu melihat angka minus).

### Solusi
Ditambahkan kebijakan **hard cap** berbasis env/setting:
- `QUOTA_DEBT_LIMIT_MB`

Perilaku:
- Jika `debt_mb >= QUOTA_DEBT_LIMIT_MB`:
  - enforce MikroTik block (ip-binding type blocked + address-list blocked),
  - set DB `is_blocked=True` + `blocked_reason=quota_debt_limit|...`,
  - kirim WhatsApp ke user + admin subscribed `NotificationType.QUOTA_DEBT_LIMIT_EXCEEDED`,
  - estimasi rupiah dihitung dari paket termurah (price paling kecil) dan dibulatkan ke puluhan ribu (10k).

Pengecualian:
- `is_unlimited_user=True`
- role `KOMANDAN`

### Catatan operasional
- Pastikan `.env.prod` memiliki `QUOTA_DEBT_LIMIT_MB` agar fitur aktif di produksi.

## 6) Admin notification recipients error 500 (enum terlalu panjang)

### Masalah
Endpoint `/api/admin/notification-recipients` sempat error 500 saat menyimpan tipe notifikasi baru.

### Akar penyebab
Kolom DB `notification_recipients.notification_type` terlalu pendek (VARCHAR lama) sehingga value `QUOTA_DEBT_LIMIT_EXCEEDED` tidak muat.

### Solusi
- Hotfix produksi: ubah kolom menjadi `VARCHAR(64)`.
- Fix permanen: update model + migration.

## 7) MikroTik: user “nyangkut blocked” walau DB sudah dibuka

### Akar penyebab yang ditemukan di lapangan
1) **Duplikat ip-binding** untuk MAC yang sama:
  - Ada entry `server=all type=blocked` (legacy/auto-block) yang meng-override entry `server=srv-user type=bypassed`.
2) **Address-list `klient_blocked` stale**:
  - Address-list berbasis IP, sehingga IP lama bisa tertinggal walau user sudah dibuka.

### Solusi permanen
1) Gateway MikroTik `upsert_ip_binding()` melakukan dedupe konflik untuk MAC yang sama (hapus entry `server=all` saat menulis server spesifik, dan bersihkan duplikat).
2) Saat unblock, backend melakukan cleanup tambahan:
  - hapus entry `klient_blocked` berbasis token comment `uid=<uuid>`/`user=<08..>`.
  - jika user online (host table punya IP), set address-list status yang benar (aktif/fup/habis/expired/inactive) segera.

## 8) Admin edit user: “Tambah Kuota + Unblock” harus bisa 1 kali save

### Masalah
Sebelumnya, jika admin mengisi `add_gb=10` lalu klik unblock dalam satu save:
- unblock dieksekusi dulu,
- guard debt-limit membaca kuota lama,
- request gagal dan rollback,
- akibatnya kuota yang diinput juga tidak tersimpan.

### Solusi
Urutan dipastikan menjadi:
1) apply `set unlimited` / inject kuota,
2) baru unblock.

Runbook operasional lengkap: [OPERATIONS_MIKROTIK_SYNC.md](OPERATIONS_MIKROTIK_SYNC.md)
