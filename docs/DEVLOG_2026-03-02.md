# Devlog 2026-03-02 (Layered Gate Finalization, Unauthorized Hardening, Image Optimization, dan Audit Error Log)

Dokumen ini merangkum seluruh histori implementasi pada sesi ini: deploy operasional, hardening unauthorized host, evaluasi image size, refactor flow captive/login, analisa error, serta keputusan arsitektur final berbasis layered gate.

## 1) Ringkasan Eksekutif

Keputusan arsitektur final yang disepakati:
- **Gunakan keduanya secara berurutan (layered gate)**:
  1. Gate identitas: OTP sukses.
  2. Gate akses jaringan: login hotspot MikroTik.
- `host/comment` MikroTik tidak dijadikan sumber utama, hanya sinyal tambahan.
- Sumber kebenaran utama: **DB status user + ip-binding non-blocked + DHCP lease valid**.

Hasil implementasi utama:
- Unauthorized sync diperkuat agar tidak false-positive dan tidak race antar scheduler.
- Stale host dibersihkan untuk entitas trusted (DB-authorized / binding+DHCP trusted).
- Flow frontend disederhanakan: halaman perantara `captive/otorisasi-perangkat` dihapus; otorisasi device dilakukan inline pada flow OTP.
- Deploy + health verification berhasil; audit overlap unauthorized pada entitas trusted menunjukkan **0** pada snapshot verifikasi akhir.

## 2) Timeline Histori Kerja (End-to-End)

1. Baseline posture diketatkan: bypass status hotspot sudah berada pada mode ketat.
2. Redeploy diminta user: stop proses di Pi, deploy dengan prune, lalu verifikasi hijau.
3. Investigasi ukuran image backend/frontend dilakukan hingga level layer.
4. Optimasi image diimplementasikan:
   - backend memakai lock khusus production,
   - frontend runtime dipindah ke distroless + healthcheck.
5. Insiden utama ditangani: unauthorized sering muncul lagi karena sinyal host stale.
6. Hardening unauthorized sync diterapkan (trusted guard + cleanup host + lock Redis).
7. Hotfix runtime di production diterapkan dan diverifikasi melalui audit overlap.
8. Refactor UX dilakukan: hapus route captive otorisasi perantara; inline authorize pada OTP flow.
9. Validasi diagnostics frontend (VS Code errors) untuk file yang diubah: tidak ada error pada file target.

## 3) Analisa Root Cause (Unauthorized Reappearing)

### Gejala
- Entri unauthorized muncul berulang meski pernah dibersihkan manual.
- Device/user yang semestinya trusted kadang terbaca sebagai unauthorized saat scheduler berjalan.

### Akar Masalah
- Data `/ip/hotspot/host` bersifat volatil dan dapat stale; jika dipakai sebagai acuan tunggal akan memicu false-positive.
- Eksekusi periodik task tanpa lock berpotensi overlap (race), memperbesar anomali state.
- Pembersihan entry trusted belum konsisten terhadap kombinasi sinyal DB + binding + DHCP.

### Prinsip Perbaikan
- Jadikan `host` sebagai sinyal observasi, bukan sumber keputusan tunggal.
- Prioritaskan trusted evidence dari DB authorized, ip-binding non-blocked, DHCP lease valid.
- Tambahkan lock eksekusi task agar satu run selesai dulu sebelum run berikutnya.

## 4) Perubahan Kode yang Tercakup

## Backend

### `backend/app/commands/sync_unauthorized_hosts_command.py`
- Tambah guard trusted berbasis:
  - DB authorized IP/MAC,
  - non-blocked ip-binding + DHCP lease valid.
- Tambah cleanup stale hotspot host untuk entitas trusted.
- Tambah alias bypass `MIKROTIK_UNAUTHORIZED_BYPASS_IPS`.
- Tambah metrik/counter operasional baru:
  - `skipped_authorized_device_mac`,
  - `skipped_binding_dhcp_trusted`,
  - `forced_binding_dhcp_remove`,
  - `hotspot_host_cleanup_removed`,
  - `failed_hotspot_host_cleanup`, dll.

### `backend/app/tasks.py`
- Tambah Redis lock pada task `sync_unauthorized_hosts_task`:
  - key: `sync_unauthorized_hosts:lock`,
  - TTL configurable,
  - run baru di-skip jika lock masih aktif,
  - lock dibersihkan di `finally`.

### `backend/config.py`
- Tambah konfigurasi:
  - `MIKROTIK_UNAUTHORIZED_BYPASS_IPS`,
  - `MIKROTIK_UNAUTHORIZED_TRUST_IP_BINDING_DHCP`,
  - `UNAUTHORIZED_SYNC_LOCK_TTL_SECONDS`.

## Frontend

### `frontend/pages/captive/index.vue`
- Saat OTP gagal dengan pesan “Perangkat belum diotorisasi”, flow kini langsung `authorizeDevice()` inline.
- Jika autorisasi sukses, langsung lanjut ke status route/captive connected tanpa halaman perantara.

### `frontend/pages/login/index.vue`
- Pola sama seperti captive: authorize inline ketika error “Perangkat belum diotorisasi”.

### `frontend/pages/captive/otorisasi-perangkat.vue`
- Dihapus karena alurnya sudah dilebur inline.

## Docker / Build

### `backend/Dockerfile-prod`
- Install dependency dari `requirements-prod.lock.txt` (khusus runtime production).

### `backend/requirements-prod.lock.txt`
- Ditambahkan lock dependency produksi.

### `frontend/Dockerfile-prod`
- Runtime image diganti ke `gcr.io/distroless/nodejs18-debian12`.
- Tambah healthcheck endpoint `/login`.

## 5) Analisa Error dan Log (Detail)

### A) Error build frontend lokal (Docker daemon EOF)
- Gejala: build frontend beberapa kali gagal lokal akibat EOF/transport daemon.
- Kategori: **environment/runtime Docker lokal**, bukan error sintaks source.
- Dampak: validasi runtime image frontend tidak bisa ditutup penuh di mesin lokal saat itu.
- Mitigasi: validasi final dipindahkan ke environment CI/publish yang daemon-nya stabil.

### B) Exit code variatif pada command grep/sed log helper
- Terlihat beberapa exit code `1/2/127` pada command inspeksi header cookie.
- Interpretasi:
  - `1`: pola tidak ditemukan (non-fatal untuk grep),
  - `2`: error penggunaan/regex/path input,
  - `127`: command/dependency tidak tersedia pada shell tertentu.
- Dampak: tidak memengaruhi keputusan core implementation; hanya memengaruhi observability command line ad-hoc.

### C) Potensi mismatch deploy mode (image-based compose)
- Temuan penting: edit file pada host tidak otomatis mengubah container runtime jika tidak rebuild/recreate atau copy ke container aktif.
- Mitigasi yang dipakai:
  - hotfix langsung ke runtime container untuk pemulihan cepat,
  - setelah itu perubahan disinkronkan ke source repo.

### D) Sinyal transient ops
- Terdapat kegagalan remove router pada salah satu run (`failed_remove` sempat non-zero).
- Snapshot audit akhir tetap menunjukkan overlap trusted=0, sehingga status akhir dinilai sehat.

## 6) Hasil Verifikasi Operasional

Verifikasi setelah hardening unauthorized:
- `overlap_active_authorized = 0`
- `overlap_ipbinding_nonblocked = 0`
- `overlap_db_authorized = 0`

Interpretasi:
- Entitas trusted tidak lagi terjaring oleh mekanisme unauthorized pada snapshot akhir audit.
- Kombinasi trusted guard + forced cleanup + lock scheduler efektif menutup akar masalah utama.

## 7) Kebijakan Final (Layered Gate)

### Gate 1 — Identitas
- Device belum dikenal wajib OTP sukses lebih dulu.

### Gate 2 — Akses Jaringan
- Setelah OTP sukses, user wajib melewati login hotspot MikroTik jika sesi hotspot belum aktif.

### Skip OTP yang aman
- OTP boleh di-skip hanya jika seluruh syarat trusted terpenuhi:
  - user approved + active di DB,
  - ip-binding non-blocked valid,
  - DHCP lease valid.

### Non-goal
- `host/comment` MikroTik tidak boleh menjadi satu-satunya dasar keputusan.

## 8) Risiko Residual dan Guardrail

Risiko residual:
- Volatilitas data router tetap mungkin terjadi pada momen churn tinggi (ARP/lease flapping).
- Daemon Docker lokal bisa tetap menjadi sumber noise validasi image.

Guardrail yang diterapkan/diusulkan:
- lock Redis untuk task periodik,
- precedence status tegas (`blocked/inactive` selalu menang),
- strict captive context untuk OTP dalam mode hotspot,
- monitoring metrik sync unauthorized per interval.

## 9) Dokumentasi Turunan yang Diperbarui

Dokumen ini menjadi referensi historis utama untuk sesi 2026-03-02 dan dilink ke:
- `CHANGELOG.md`
- `docs/ARCHIVE_HISTORICAL_INDEX.md`
- `docs/RUNBOOK_ACTIVE_INDEX.md`
- `docs/LAYERED_GATE_POLICY_MATRIX.md`

## 10) Next Step yang Direkomendasikan

1. Jalankan validasi build/publish frontend pada CI untuk konfirmasi runtime distroless end-to-end.
2. Pantau 24 jam metrik unauthorized sync (skip/add/remove/failure counters).
3. Terapkan policy matrix ini sebagai checklist wajib pada incident response hotspot/auth berikutnya.
