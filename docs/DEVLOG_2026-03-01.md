# Devlog 2026-03-01 (Auto-login Reactivation + Hotspot-required Redirect for Existing Session)

Dokumen ini merangkum detail error, root cause, implementasi perbaikan, simulasi/test, deploy, dan monitoring untuk kasus user berulang OTP serta user yang sudah punya session/JWT tetapi belum punya sesi hotspot aktif.

## 1) Ringkasan Eksekutif

Masalah yang ditutup:
- Auto-login best-effort tidak konsisten terpanggil di client, sehingga user cenderung kembali request OTP.
- User yang sudah login (cookie/JWT valid) tetapi masih butuh login hotspot belum selalu diarahkan ke halaman `login/hotspot-required` saat mengakses route login.

Hasil akhir:
- Inisialisasi auth client dipastikan selalu mengeksekusi `initializeAuth()` setelah mounted (idempotent, aman).
- Middleware auth menambahkan precheck hotspot untuk user yang sudah login di route guest (`/`, `/login`, `/register`, `/daftar`).
- Jika hotspot masih required dan session hotspot belum aktif, user langsung diarahkan ke `login/hotspot-required` tanpa OTP ulang.
- Simulasi runtime + regression tests hijau, deploy production sukses, service sehat.

## 2) Gejala & Dampak

### Gejala A: User sering meminta OTP berulang
- Dari log produksi sebelumnya tampak dominan `request-otp`/`verify-otp`, sementara hit `auto-login` tidak terlihat.
- Dampak: friction login meningkat, beban OTP tidak perlu, pengalaman user menurun.

### Gejala B: Session/JWT valid tetapi flow hotspot tidak presisi
- Pada kondisi tertentu user yang sudah login bisa tetap melewati alur default guest-route redirect, bukan diarahkan dulu ke `hotspot-required`.
- Dampak: flow hotspot MikroTik tidak sinkron dengan status sesi app.

## 3) Root Cause

### Root Cause A (client auth bootstrap)
- `initializeAuth()` memang memiliki auto-login best-effort, tetapi eksekusi client dapat terlewat jika hook bootstrap tidak dipanggil konsisten saat hydration selesai.

### Root Cause B (middleware decision gap)
- Middleware auth untuk user sudah login belum melakukan precheck `GET /auth/hotspot-session-status` saat user membuka route guest.
- Akibatnya keputusan redirect tidak mempertimbangkan status `hotspot_login_required` + `hotspot_binding_active` (alias legacy: `hotspot_session_active`) pada titik guard global.

## 4) Perubahan Implementasi

### A. Pastikan bootstrap auth client tetap berjalan
File:
- `frontend/plugins/01.auth.ts`

Perubahan:
- Pada sisi client, plugin tetap memanggil `initializeAuth()` di `app:mounted`.
- Catatan penting: fungsi store sudah idempotent sehingga aman dipanggil ulang, tetapi penting untuk mengaktifkan auto-login best-effort.

### B. Tambah hotspot precheck pada middleware auth
File:
- `frontend/middleware/auth.global.ts`

Perubahan:
- Tambah import eksplisit `useNuxtApp`.
- Tambah precheck untuk user login non-admin pada route:
  - `/`
  - `/login`
  - `/register`
  - `/daftar`
- Middleware memanggil:
  - `GET /auth/hotspot-session-status` (dengan passthrough `client_ip`/`client_mac` bila tersedia di query)
- Jika `hotspot_login_required === true` dan `hotspot_binding_active !== true`:
  - redirect ke `/login/hotspot-required` (query identity diteruskan).
- Jika precheck gagal (network/error endpoint):
  - fallback ke flow guard normal (best-effort, tidak hard-fail).

### C. Simulasi runtime middleware diperluas
File:
- `frontend/tests/auth-middleware.runtime.test.ts`

Penambahan skenario:
- redirect ke `hotspot-required` saat hotspot required + session inactive.
- tidak redirect saat hotspot session sudah active.
- fallback normal saat precheck endpoint error.
- admin bypass (tidak menjalankan precheck hotspot).

## 5) Matriks Simulasi/Test

Validasi yang dijalankan:
- `npx vitest run tests/auth-middleware.runtime.test.ts` → **12/12 pass**
- `npm run typecheck` (dengan `NUXT_PUBLIC_APP_BASE_URL`) → **pass**
- Regression redirect related:
  - `tests/hotspot-redirect.test.ts` → pass
  - `tests/auth-guard-decisions.test.ts` → pass
  - `tests/auth-guards.test.ts` → pass

## 6) Deploy & Operasional

Target deploy:
- Host: `10.10.83.2`
- User: `abdullah`
- Port: `1983`
- Key: `~/.ssh/id_raspi_ed25519`
- Remote path: `/home/abdullah/sobigidul`

Eksekusi:
- `./deploy_pi.sh --host 10.10.83.2 --user abdullah --port 1983 --key ~/.ssh/id_raspi_ed25519 --remote-dir /home/abdullah/sobigidul --prune`

Hasil:
- deploy selesai sukses,
- prune docker resources non-volume sukses,
- migration idempotent sukses,
- service core `Up` dan health checks lulus (`/api/ping`, `/login`, `_nuxt asset`).

## 7) Monitoring Pasca Deploy

Snapshot monitoring awal:
- Backend 6 jam terakhir menunjukkan `auth/me` traffic aktif.
- Belum ada hit `auto-login` atau `hotspot-session-status` pada window yang dipantau.

Interpretasi:
- Perbaikan code path sudah aktif dan tervalidasi via test.
- Namun evidence trafik produksi untuk flow baru masih bergantung pada munculnya user scenario yang relevan (session valid di route guest + butuh hotspot required).

Tindak lanjut monitoring:
- Lanjut pantau hit endpoint berikut per interval:
  - `/api/auth/auto-login`
  - `/api/auth/hotspot-session-status`
  - `/api/auth/request-otp`
  - `/api/auth/verify-otp`
- Bandingkan tren rasio OTP vs auto-login minimal 24 jam.

## 8) Lessons Learned

- Guard global perlu menutup gap antara status auth aplikasi dan status hotspot session.
- Auto-login best-effort harus dijaga tetap dieksekusi di client setelah mounted meskipun store memiliki flag initial check.
- Untuk perubahan guard yang sensitif, runtime simulation tests wajib mencakup skenario gagal endpoint dan role admin bypass.

## 9) Artefak Perubahan

Commit terkait:
- `9b2ecb97` — fix bootstrap auth client untuk mengaktifkan auto-login attempt.
- `cbbadf68` — precheck hotspot di middleware + test simulasi lengkap.

## 10) Lanjutan: Self-heal Reset Login + Status Handling Parity

Tujuan lanjutan:
- Menutup parity handling status akses untuk `habis`, `fup`, `expired`, `inactive`.
- Menyediakan self-heal action di sisi user berupa tombol **Reset Login** (dekat menu profil).
- Menjamin alur user setelah `reset-login` dan `logout` diarahkan ke `APP_LINK_MIKROTIK` setelah cleanup server selesai.

Perubahan utama:
- Backend menambahkan endpoint baru `POST /api/auth/reset-login`.
- Guard/decorator auth diperbarui agar path `reset-login`/`logout` tidak memicu re-issue token pada fallback refresh.
- Frontend store auth menambahkan action `resetLogin`.
- Komponen profil user menambahkan tombol **Reset Login** untuk non-admin.
- Redirect pasca sukses `reset-login`/`logout` user diarahkan ke `APP_LINK_MIKROTIK` dengan passthrough `client_ip`/`client_mac` bila tersedia.

## 11) Validasi Teknis Tambahan

Cakupan validasi yang dijalankan:
- Backend:
  - `pytest` (termasuk test baru `test_logout_network_reset.py`)
  - `ruff check`
- Frontend:
  - `npm run lint`
  - `npm run typecheck`
  - `vitest` (termasuk runtime guard tests)

Hasil:
- Seluruh perbaikan inti lulus setelah penyempurnaan minor pada context test Flask, fallback decorator, dan typing test double.

## 12) Deploy Ulang + Verifikasi Operasional

Catatan deploy:
- Deploy script path awal tidak tersedia pada host target, sehingga eksekusi dialihkan ke docker compose di direktori deploy aktif.
- Deploy sukses setelah compose dijalankan dengan `--env-file .env.prod` (wajib untuk interpolasi env seperti token cloudflared).

Verifikasi pasca deploy:
- Service utama berada pada status `Up` (frontend/db/redis healthy, backend/celery running).
- Health API mengembalikan status `ok` dengan check `database`, `redis`, dan `mikrotik` bernilai `true`.
- Variabel `APP_LINK_MIKROTIK` di production terkonfirmasi ke `http://login.local`.

## 13) Audit Log: Production dan Local

### Production
Temuan utama:
- Tidak ditemukan pola error kritis persisten pada backend/nginx untuk window inspeksi.
- Ada event startup transient di frontend (gagal resolve backend di fase awal restart), kemudian recovery normal.
- Ada log intermiten cloudflared seperti `context canceled/stream closed` yang tidak menunjukkan crash berkepanjangan.
- Beberapa `401` pada `/api/auth/me` teramati dan konsisten dengan request tanpa kredensial valid.

Kesimpulan production:
- Sistem operasional stabil untuk flow saat ini, tanpa indikasi kegagalan berkelanjutan pada jalur auth/hotspot.

### Local (safety-first E2E-like)
Validasi skema hotspot-required:
- Log lokal menunjukkan hit pada `/login/hotspot-required` dan endpoint `/api/auth/hotspot-session-status` sesuai skenario guard.
- Runtime tests guard lokal lulus penuh (17/17) untuk skenario terkait.

Kesimpulan local:
- Perilaku hotspot-required sesuai skema yang diharapkan dan aman dijadikan basis verifikasi regresi sebelum uji produksi lanjutan.

## 14) Rekomendasi Lanjutan

- Tetap prioritaskan E2E yang lebih agresif di local/dev dibanding production.
- Pantau 24 jam rasio endpoint auth (`auto-login`, `request-otp`, `verify-otp`, `hotspot-session-status`) untuk konfirmasi dampak UX.
- Jika diperlukan, tambahkan alert ringan untuk lonjakan error startup transient frontend/cloudflared agar deteksi lebih dini.

## 15) Incident Follow-up: False Positive `terhubung` dan Hardening Status Logic

Konteks incident:
- Ditemukan kasus user terlihat `terhubung` padahal sesi hotspot aktif tidak ada, karena adanya `ip-binding` lama (`bypassed`) yang masih tertinggal.
- Requirement operasional menegaskan bahwa sistem **tidak** menggunakan `/ip/hotspot/active` sebagai sumber kebenaran utama; basis verifikasi tetap pada `ip-binding` + korelasi data hotspot host/DHCP lease/ARP.

Perbaikan implementasi:
- File: `backend/app/infrastructure/http/auth_contexts/hotspot_status_handlers.py`
  - `HOTSPOT_SESSION_STATUS_ALLOW_USER_LEVEL_FALLBACK` diubah default ke `False`.
  - Fallback user-level tidak lagi dijalankan otomatis saat check MAC-specific gagal.
  - Fallback hanya boleh dijalankan bila ada `client_ip` dan nilainya cocok dengan hasil `get_hotspot_user_ip` (yang mengambil dari hotspot host/DHCP lease/ARP).
- File: `backend/app/infrastructure/http/auth_routes.py`
  - Menambahkan wiring dependency `get_hotspot_user_ip` ke handler `/api/auth/hotspot-session-status`.

Validasi tambahan:
- File: `backend/tests/test_auth_hotspot_session_status.py`
  - Menambahkan skenario fallback diizinkan saat IP cocok.
  - Menambahkan skenario fallback ditolak saat IP mismatch.
  - Menjaga ekspektasi bahwa `hotspot_session_active` tetap mengikuti keputusan `hotspot_binding_active` berbasis kebijakan di atas.

Catatan penting operasional:
- Hardening ini mencegah pengulangan error yang sama (status `terhubung` terangkat oleh binding stale tanpa bukti korelasi IP).
- Pendekatan ini tetap konsisten dengan arsitektur jaringan saat ini (tanpa bergantung pada `/ip/hotspot/active`).

## 16) Hardening Script E2E/CI yang Tercakup di Sesi Ini

Perubahan script:
- `scripts/run_local_ci.ps1`
  - Menambahkan resolver path compose agar eksekusi stabil untuk jalur absolute/relative/workspace-relative.
- `scripts/simulate_end_to_end.ps1`
  - Menambahkan mode user test terisolasi dan cleanup artefak otomatis.
  - Menambahkan snapshot + restore setting admin agar environment kembali ke baseline setelah run.
  - Menambahkan fallback verifikasi OTP no-context ketika context IP/MAC tidak tervalidasi.
  - Menambahkan verifikasi deterministik untuk `reset-login` → `logout` → `re-login`.

Outcome:
- E2E lebih aman dijalankan berulang pada environment aktif tanpa meninggalkan sampah konfigurasi/user test.
- Risiko drift konfigurasi pasca simulasi menurun signifikan.
