# Devlog 2026-03-01 (Auto-login Reactivation + Hotspot-required Redirect for Existing Session)

Dokumen ini merangkum detail error, root cause, implementasi perbaikan, simulasi/test, deploy, dan monitoring untuk kasus user berulang OTP serta user yang sudah punya session/JWT tetapi belum punya sesi hotspot aktif.

## 1) Ringkasan Eksekutif

Masalah yang ditutup:
- Auto-login best-effort tidak konsisten terpanggil di client, sehingga user cenderung kembali request OTP.
- User yang sudah login (cookie/JWT valid) tetapi masih butuh login hotspot belum selalu diarahkan ke halaman `login/hotspot-required` saat mengakses route login.

Hasil akhir:
- Inisialisasi auth client dipastikan selalu mengeksekusi `initializeAuth()` setelah mounted (idempotent, aman).
- Middleware auth menambahkan precheck hotspot untuk user yang sudah login di route guest (`/`, `/login`, `/register`, `/daftar`).
- Jika hotspot masih required dan session hotspot belum aktif, user langsung diarahkan ke `login/hotspot-required` tanpa OTP ulang.
- Simulasi runtime + regression tests hijau, deploy production sukses, service sehat.

## 2) Gejala & Dampak

### Gejala A: User sering meminta OTP berulang
- Dari log produksi sebelumnya tampak dominan `request-otp`/`verify-otp`, sementara hit `auto-login` tidak terlihat.
- Dampak: friction login meningkat, beban OTP tidak perlu, pengalaman user menurun.

### Gejala B: Session/JWT valid tetapi flow hotspot tidak presisi
- Pada kondisi tertentu user yang sudah login bisa tetap melewati alur default guest-route redirect, bukan diarahkan dulu ke `hotspot-required`.
- Dampak: flow hotspot MikroTik tidak sinkron dengan status sesi app.

## 3) Root Cause

### Root Cause A (client auth bootstrap)
- `initializeAuth()` memang memiliki auto-login best-effort, tetapi eksekusi client dapat terlewat jika hook bootstrap tidak dipanggil konsisten saat hydration selesai.

### Root Cause B (middleware decision gap)
- Middleware auth untuk user sudah login belum melakukan precheck `GET /auth/hotspot-session-status` saat user membuka route guest.
- Akibatnya keputusan redirect tidak mempertimbangkan status `hotspot_login_required` + `hotspot_binding_active` (alias legacy: `hotspot_session_active`) pada titik guard global.

## 4) Perubahan Implementasi

### A. Pastikan bootstrap auth client tetap berjalan
File:
- `frontend/plugins/01.auth.ts`

Perubahan:
- Pada sisi client, plugin tetap memanggil `initializeAuth()` di `app:mounted`.
- Catatan penting: fungsi store sudah idempotent sehingga aman dipanggil ulang, tetapi penting untuk mengaktifkan auto-login best-effort.

### B. Tambah hotspot precheck pada middleware auth
File:
- `frontend/middleware/auth.global.ts`

Perubahan:
- Tambah import eksplisit `useNuxtApp`.
- Tambah precheck untuk user login non-admin pada route:
  - `/`
  - `/login`
  - `/register`
  - `/daftar`
- Middleware memanggil:
  - `GET /auth/hotspot-session-status` (dengan passthrough `client_ip`/`client_mac` bila tersedia di query)
- Jika `hotspot_login_required === true` dan `hotspot_binding_active !== true`:
  - redirect ke `/login/hotspot-required` (query identity diteruskan).
- Jika precheck gagal (network/error endpoint):
  - fallback ke flow guard normal (best-effort, tidak hard-fail).

### C. Simulasi runtime middleware diperluas
File:
- `frontend/tests/auth-middleware.runtime.test.ts`

Penambahan skenario:
- redirect ke `hotspot-required` saat hotspot required + session inactive.
- tidak redirect saat hotspot session sudah active.
- fallback normal saat precheck endpoint error.
- admin bypass (tidak menjalankan precheck hotspot).

## 5) Matriks Simulasi/Test

Validasi yang dijalankan:
- `npx vitest run tests/auth-middleware.runtime.test.ts` → **12/12 pass**
- `npm run typecheck` (dengan `NUXT_PUBLIC_APP_BASE_URL`) → **pass**
- Regression redirect related:
  - `tests/hotspot-redirect.test.ts` → pass
  - `tests/auth-guard-decisions.test.ts` → pass
  - `tests/auth-guards.test.ts` → pass

## 6) Deploy & Operasional

Target deploy:
- Host: `10.10.83.2`
- User: `abdullah`
- Port: `1983`
- Key: `~/.ssh/id_raspi_ed25519`
- Remote path: `/home/abdullah/sobigidul`

Eksekusi:
- `./deploy_pi.sh --host 10.10.83.2 --user abdullah --port 1983 --key ~/.ssh/id_raspi_ed25519 --remote-dir /home/abdullah/sobigidul --prune`

Hasil:
- deploy selesai sukses,
- prune docker resources non-volume sukses,
- migration idempotent sukses,
- service core `Up` dan health checks lulus (`/api/ping`, `/login`, `_nuxt asset`).

## 7) Monitoring Pasca Deploy

Snapshot monitoring awal:
- Backend 6 jam terakhir menunjukkan `auth/me` traffic aktif.
- Belum ada hit `auto-login` atau `hotspot-session-status` pada window yang dipantau.

Interpretasi:
- Perbaikan code path sudah aktif dan tervalidasi via test.
- Namun evidence trafik produksi untuk flow baru masih bergantung pada munculnya user scenario yang relevan (session valid di route guest + butuh hotspot required).

Tindak lanjut monitoring:
- Lanjut pantau hit endpoint berikut per interval:
  - `/api/auth/auto-login`
  - `/api/auth/hotspot-session-status`
  - `/api/auth/request-otp`
  - `/api/auth/verify-otp`
- Bandingkan tren rasio OTP vs auto-login minimal 24 jam.

## 8) Lessons Learned

- Guard global perlu menutup gap antara status auth aplikasi dan status hotspot session.
- Auto-login best-effort harus dijaga tetap dieksekusi di client setelah mounted meskipun store memiliki flag initial check.
- Untuk perubahan guard yang sensitif, runtime simulation tests wajib mencakup skenario gagal endpoint dan role admin bypass.

## 9) Artefak Perubahan

Commit terkait:
- `9b2ecb97` — fix bootstrap auth client untuk mengaktifkan auto-login attempt.
- `cbbadf68` — precheck hotspot di middleware + test simulasi lengkap.
