# PR Draft â€” Sentralisasi Route Policy + Hardening Captive Context + Sinkronisasi Legal Routes

## Suggested PR Title
refactor(frontend): centralize policy/status routes and harden captive context restrictions

## Ringkasan
PR ini merapikan arsitektur route frontend agar lebih terpusat dan aman:
- status page canonical dipusatkan ke `/policy/*`,
- route legacy `/login/*` dan `/captive/*` dipertahankan hanya sebagai redirect kompatibilitas,
- flow captive diperketat agar user captive-context tidak bisa masuk area terbatas non-admin,
- legal docs tersedia juga pada root (`/privacy`, `/terms`),
- dokumentasi sinkron dengan implementasi terbaru.

## Latar Belakang
- Duplikasi route status (`/login/*`, `/captive/*`, `/policy/*`) berisiko drift logic dan membebani maintenance.
- Flow captive masih memungkinkan navigasi ke route yang seharusnya dibatasi dalam konteks captive popup/session.
- Legal docs secara URL terlihat terlalu merchant-center specific, padahal dipakai lintas konteks.

## Perubahan Utama

### 1) Sentralisasi Status Route
- Canonical status route: `/policy/{blocked|inactive|expired|habis|fup}`.
- Hapus page wrappers legacy:
  - `frontend/pages/login/{blocked,inactive,expired,habis,fup}.vue`
  - `frontend/pages/captive/{blokir,inactive,expired,habis,fup}.vue`
- Tambah compatibility redirect melalui `routeRules`:
  - `frontend/nuxt.config.ts`

### 2) Hardening Captive Context
- Tambah util konteks captive:
  - `frontend/utils/captiveContext.ts`
- Middleware auth menandai sesi captive dan membatasi route restricted untuk non-admin:
  - `frontend/middleware/auth.global.ts`
- CTA policy disesuaikan saat captive context aktif agar tidak mengarah ke route restricted:
  - `frontend/components/policy/PolicyStatusView.vue`
- Halaman `captive/terhubung` disederhanakan (single primary action + auto close):
  - `frontend/pages/captive/terhubung.vue`

### 3) Sentralisasi Route Pembelian
- Hapus implementasi khusus `frontend/pages/captive/beli.vue`.
- Pertahankan backward compatibility: `/captive/beli -> /beli` via `routeRules`.
- Bersihkan referensi legacy `/captive/beli` di auth/legal logic:
  - `frontend/store/auth.ts`
  - `frontend/pages/merchant-center/privacy.vue`
  - `frontend/pages/merchant-center/terms.vue`

### 4) Legal Route Alias Root
- Tambah root alias legal docs:
  - `frontend/pages/privacy.vue` -> redirect ke `/merchant-center/privacy`
  - `frontend/pages/terms.vue` -> redirect ke `/merchant-center/terms`

### 5) Test & Guard Cleanup
- Rapikan policy list agar hanya canonical status route:
  - `frontend/utils/authRoutePolicy.ts`
  - `frontend/middleware/status-guard.global.ts`
- Update runtime tests:
  - `frontend/tests/auth-middleware.runtime.test.ts`
  - `frontend/tests/status-guard.runtime.test.ts`

## Dokumentasi yang Diperbarui
- `CHANGELOG.md`
- `docs/ACCESS_STATUS_MATRIX.md`
- `docs/TROUBLESHOOTING_HYDRATION.md`
- `docs/DEVLOG_2026-02-27.md`

## Validasi yang Sudah Dijalankan
- Focused frontend runtime tests:
  - `npx vitest run tests/auth-middleware.runtime.test.ts tests/status-guard.runtime.test.ts`
  - Hasil: **2 files, 10 tests passed**.
- Diagnostics (file-level) pada file yang diubah: **no errors found**.

## Risiko
- Potensi regresi deep-link lama ke route legacy status/captive.
- Potensi perilaku berbeda pada user demo/captive jika ada ketergantungan implisit ke route lama.

## Mitigasi
- Redirect compatibility disediakan di `routeRules`.
- Runtime middleware tests diperbarui untuk skenario policy route dan captive context.
- Dokumentasi matriks route/status diselaraskan dengan implementasi aktual.

## Rollback Plan
1. Revert commit PR ini.
2. Redeploy frontend.
3. Jalankan smoke check:
   - akses `/policy/*`, `/login/*`, `/captive/*` (redirect behavior),
   - flow captive login -> `terhubung`,
   - akses legal `/privacy` dan `/terms`.

## Checklist Reviewer
- Verifikasi route legacy tetap redirect benar ke canonical route.
- Verifikasi captive-context blocking berlaku hanya untuk user non-admin.
- Verifikasi legal docs dapat dibuka dari root dan merchant-center.
- Verifikasi tidak ada 404 pada URL lama yang sebelumnya dipublikasikan.

---

## Copy-ready PR Body (Ringkas)

### Ringkasan
Refactor frontend untuk sentralisasi route status ke `/policy/*`, hardening captive context, sentralisasi pembelian ke `/beli`, dan alias legal docs ke root route.

### Perubahan Kunci
- Hapus page status legacy `/login/*` dan `/captive/*`, ganti redirect kompatibilitas via `routeRules`.
- Tambah `captiveContext` + enforcement di auth middleware.
- Hapus implementasi `captive/beli` dan arahkan ke `/beli`.
- Tambah alias root legal docs: `/privacy`, `/terms`.
- Sinkronisasi docs: changelog, matrix status, hydration troubleshooting, devlog terbaru.

### Validasi
- `npx vitest run tests/auth-middleware.runtime.test.ts tests/status-guard.runtime.test.ts`
- Result: **10/10 tests passed**.
