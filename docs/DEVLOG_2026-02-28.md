# Devlog 2026-02-28 (Hotspot Flow Finalization + CI Incident Closure + Actions Retention Automation)

Dokumen ini merangkum seluruh perubahan penting, error yang terjadi, root cause, dan penyelesaian end-to-end pada fase stabilisasi hotspot flow, CI, dan operasi GitHub Actions.

## 1) Ringkasan Eksekutif

Fokus sesi:
- Menyempurnakan flow login hotspot agar tidak bergantung pada active-only session.
- Menutup false redirect ke hotspot-required pada user yang semestinya lolos.
- Menstabilkan dev/runtime HMR + environment parity.
- Menutup rangkaian kegagalan CI hingga hijau.
- Membersihkan backlog Actions (runs + caches) dan menambahkan housekeeping otomatis.

Hasil akhir:
- Logika hotspot lebih aman dan selaras semantik ip-binding.
- CI kembali hijau setelah beberapa iterasi fix bertahap.
- Housekeeping Actions otomatis aktif dengan default aman.

## 2) Timeline Commit Kunci

- `b4f16f0c` — perbaikan utama flow hotspot, stabilisasi dev HMR, parity gate updates.
- `2dc42739` — refine keputusan redirect hotspot + guard tests.
- `8a1736f0` — fix awal CI env frontend + dependency contract gate.
- `e681fe19` — sinkronisasi generated TypeScript contracts.
- `d31f7bb9` — normalisasi hash kontrak lintas OS + env args Dockerfile frontend.
- `aa04c525` — track `docs/ACCESS_STATUS_MATRIX.md` untuk parity gate CI.
- `c4225da0` — empty commit retrigger workflow setelah cleanup runs/caches.
- `09e9be34` — tambah workflow retention otomatis (`Actions Housekeeping`).
- `cb77fe81` — tuning agresif awal (10/30).
- `d305cbb4` — set baseline aman retention (15/50).

## 3) Perubahan Implementasi Aplikasi

### A. Hotspot session semantics

Masalah awal:
- validasi (historis) terlalu menekankan `/ip/hotspot/active`, berisiko memaksa relogin padahal device sah via ip-binding.

Perubahan:
- `hotspot_binding_active` (alias legacy: `hotspot_session_active`) diturunkan dari kepemilikan ip-binding user (bukan active-only).
- backend menambahkan helper ip-binding ownership dan wiring ke verify-otp flow.
- kontrak API dan schema respons diperbarui untuk field terkait.

Dampak:
- user valid yang sudah memiliki binding tidak terjebak relogin yang tidak perlu.

### B. Frontend redirect guard

Masalah awal:
- redirect ke hotspot-required sempat terlalu broad.

Perubahan:
- redirect saat `hotspot_login_required && hotspot_binding_active !== true` (termasuk state unknown/null).
- dibuat utility terpisah (`hotspotRedirect`) + test truth-table.
- halaman `/login/hotspot-required` menambahkan re-check API `GET /api/auth/hotspot-session-status` sebelum lanjut dashboard.

Dampak:
- false redirect berkurang, behavior lebih deterministik untuk kasus MAC berubah vs binding existing.

### C. Dev/HMR stabilization

Masalah awal:
- websocket HMR dan mismatch URL/HTTPS menyebabkan gangguan dev loop.

Perubahan:
- penyesuaian HMR path/config Nuxt,
- perbaikan precedence sumber URL captive,
- penyesuaian tunnel command yang lebih kompatibel,
- refinement history/replace behavior pasca login.

## 4) CI Incident: Gejala → Root Cause → Fix

### Incident #1: Frontend Docker build gagal (`NUXT_PUBLIC_APP_BASE_URL`)

Gejala:
- job `docker-build (frontend)` gagal pada stage `nuxt prepare`/`build`.

Root cause:
- env production Nuxt wajib belum diteruskan konsisten ke semua jalur build image.

Fix:
- tambah build args/env pada workflow CI dan Docker Publish.
- update `frontend/Dockerfile` dan `frontend/Dockerfile-prod` agar menerima + mengekspor env build.

### Incident #2: Contract gate gagal (`Generated contracts out of date`)

Gejala:
- `scripts/api_quality_gate.py` fail meski perubahan logic sudah benar.

Root cause:
- `contracts.generated.ts` belum sinkron setelah perubahan OpenAPI/workflow.

Fix:
- regenerate contracts via script generator.
- commit hasil generated file.

### Incident #3: False mismatch hash OpenAPI (Windows vs Linux)

Gejala:
- lokal bisa PASS, CI tetap FAIL sinkronisasi hash.

Root cause:
- hashing byte-level sensitif terhadap newline `CRLF` (Windows) vs `LF` (Linux runner).

Fix:
- normalisasi newline sebelum hashing di generator + quality gate.

### Incident #4: Access status parity gate gagal (`FileNotFoundError`)

Gejala:
- CI tidak menemukan `docs/ACCESS_STATUS_MATRIX.md`.

Root cause:
- file docs tersebut ter-ignore oleh aturan `.gitignore` (`*.md`), sehingga tidak ikut tracked.

Fix:
- tambahkan exception unignore di `.gitignore`.
- track file `docs/ACCESS_STATUS_MATRIX.md` ke repo.

## 5) Cleanup Actions (Runs + Caches)

Langkah operasional yang dilakukan:
- hapus workflow runs lama, awalnya sisakan 2 terbaru.
- hapus seluruh Actions caches hingga `total_count=0`.
- atas kebutuhan operasional, 2 run tersisa juga dihapus, lalu retrigger pipeline.

Catatan penting:
- pada empty commit retrigger, job `ci` selain `changes` bisa `skipped` karena `paths-filter`.
- ini behavior normal, bukan kegagalan pipeline.

## 6) Otomasi Retention (Pencegahan Jangka Panjang)

Ditambahkan workflow:
- `.github/workflows/actions-housekeeping.yml`

Fitur:
- schedule harian + manual trigger.
- pembersihan run completed lama + cache lama berbasis batas retensi.

Nilai default akhir (aman):
- `keep_runs=15`
- `keep_caches=50`

Trade-off:
- storage lebih stabil,
- histori sangat lama tidak tersimpan terlalu panjang,
- potensi cache miss kecil tetap ada namun terkontrol.

## 7) Validasi & Status Akhir

- CI retrigger terbaru terverifikasi berjalan sukses sesuai scope trigger.
- Docker Publish dapat dipicu manual saat commit tidak match `paths` trigger.
- Housekeeping workflow berhasil didaftarkan dan dapat dijalankan.

## 8) Lessons Learned

- Untuk contract-gated repo, perubahan OpenAPI harus langsung diikuti regenerate + commit generated contracts.
- Hash quality gate harus netral lintas OS untuk menghindari false-negative CI.
- Dokumen parity yang dibaca CI wajib dipastikan tracked (bukan hanya ada lokal).
- Retention otomatis lebih aman dibanding cleanup manual reaktif saat storage penuh.

## 9) Addendum Hardening Lanjutan (Quota/Debt/Parity)

Tambahan implementasi pada sesi lanjutan tanggal yang sama:

- Penghapusan fallback auto-login by active session IP (`/ip/hotspot/active`) agar ownership tetap berbasis device authorized (current state).
- Penambahan ledger append-only mutasi quota/debt (`quota_mutation_ledger`) + integrasi ke flow utama.
- Penambahan endpoint parity operasional:
	- `GET /api/admin/metrics`
	- `GET /api/admin/metrics/access-parity`
- Penambahan panel parity pada dashboard admin untuk mismatch app-vs-router realtime.
- Penambahan runbook respons mismatch parity (`docs/OPERATIONS_POLICY_PARITY_RESPONSE.md`).
- Pengetatan trust proxy production (`TRUSTED_PROXY_CIDRS`) agar tidak terlalu lebar.
- Penambahan stress tests concurrency (marker `stress`) untuk flow interleaving:
	- sync usage + inject quota + debt settlement,
	- manual debt pressure + set unlimited.

Validasi sesi addendum:
- Targeted backend tests lulus.
- Stress marker tests (`pytest -m stress -q`) lulus.
- Diagnostics Python backend bersih (no errors).
