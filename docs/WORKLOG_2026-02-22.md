# Worklog 2026-02-22

Dokumen ini merangkum pekerjaan end-to-end pada proyek **lpsaring** sampai **2026-02-22**: fitur yang diproduktisasi, masalah/error yang muncul, akar penyebab, solusi yang diterapkan, dan langkah verifikasi (dev & production).

Worklog sebelumnya:
- [WORKLOG_2026-02-19.md](WORKLOG_2026-02-19.md)
- [WORKLOG_2026-02-18.md](WORKLOG_2026-02-18.md)
- [WORKLOG_2026-02-17.md](WORKLOG_2026-02-17.md)
- [WORKLOG_2026-02-16.md](WORKLOG_2026-02-16.md)

## Ringkasan

Tema besar sesi ini:
- “Reset user total agar login ulang” diproduktisasi menjadi **Admin: Reset Login** (hapus refresh token + bersihkan device + best-effort cleanup MikroTik).
- Perbaikan alur **hutang kuota** (agar admin create debt juga menghasilkan credit kuota/purchased quota).
- Pembaruan dashboard user (Tunggakan Kuota) dan peningkatan keterbacaan di mobile.
- Investigasi produksi: **OTP terkirim tapi user tidak bisa masuk** → akar masalah utama ditemukan di frontend (OTP tidak tersubmit karena strict length/input format), lalu diperbaiki.
- Hardening dev experience: HMR di domain HTTPS (hindari Mixed Content `ws://`).
- Housekeeping backend: formatting massal `ruff format`.

## 1) Admin Tool: Reset Login (DB + MikroTik)

### Tujuan
Memaksa user login ulang tanpa mengubah kuota/status user.

### Perilaku
- Hapus sesi/token (refresh tokens) dan reset device binding di DB.
- Best-effort cleanup di MikroTik untuk user terkait (historis: pernah mencakup cookies/active; current state fokus ip-binding/address-list/dhcp/arp).

### Catatan operasional
- Reset login **tidak memperbaiki OTP salah/expired**.
- Reset login juga **tidak akan membantu** jika request `verify-otp` tidak pernah sampai ke backend (lihat bagian OTP di bawah).

Commit terkait:
- `16d544fe` admin: add reset login tool + walled-garden robustness
- `3228ef96` Admin reset-login: clear tokens/devices + Mikrotik cookies (historis); format debt units in templates

## 2) Hutang Kuota: "inject 2x" dan perbaikannya

### Gejala
Admin menambah hutang manual lalu user merasa kuota tidak bertambah (atau terlihat seperti harus “inject dua kali”).

### Akar masalah
Hutang/ledger bisa “memakan” purchased quota yang baru ditambah, sehingga user terlihat belum dapat kuota untuk dipakai.

### Solusi
Saat admin membuat hutang manual, sistem juga menambah credit/purchased quota (sesuai rule bisnis yang dipilih) agar user langsung dapat kuota.

Commit terkait:
- `f024e323` Manual debt credits quota; expose quota debt breakdown; add debt/revenue estimates to reports

## 3) Dashboard User: Tunggakan Kuota (presisi & mobile)

### Perubahan
- Tunggakan Kuota dikembalikan ke **tabel** (bukan donut) karena donut kurang presisi/kurang terbaca di mobile.
- Tabel menampilkan: total hutang (Rp), debt total/auto/manual, kuota terpakai, sisa kuota, terpakai 7 hari.

Commit terkait:
- `e646c753` fix(frontend): otp input sanitize + dashboard debt table

## 4) Insiden Produksi: OTP terkirim tapi tidak bisa masuk

Kasus yang disorot:
- `085259962901`
- `085385471441`

### Temuan utama dari log produksi
- `POST /api/auth/request-otp` sukses (200) dan pengiriman WhatsApp lewat Fonnte dilaporkan **SUCCESS**.
- Namun pada window waktu yang sama, **tidak ada** request `POST /api/auth/verify-otp` yang masuk (atau sangat jarang dan tidak berkorelasi dengan request OTP untuk nomor tersebut).

Kesimpulan: masalahnya sering bukan di backend/device-binding/MikroTik, melainkan **frontend tidak mengirim request verify-otp**.

### Akar masalah (Frontend)
Di halaman `/login` dan `/captive`, tombol submit sebelumnya bergantung pada `otpCode.length === 6`.

Masalah yang terjadi di device tertentu:
- OTP dipaste dalam format seperti `"Kode OTP: 123 456"` / `"123-456"` → ada karakter non-digit.
- `VOtpInput`/binding menghasilkan tipe yang tidak selalu string (mis. number) → `.length` bisa `undefined`.

Akibatnya:
- Tombol tetap disabled, atau handler return sebelum call API.
- `verify-otp` tidak pernah terpanggil → “Reset Login” terasa tidak berpengaruh.

### Solusi
- OTP disanitasi: ambil digit saja, ambil 6 digit terakhir, lalu kirim ke `/auth/verify-otp`.
- Kondisi disabled tombol juga memakai hasil sanitasi digit.

Commit terkait:
- `e646c753` fix(frontend): otp input sanitize + dashboard debt table

### Verifikasi cepat (Production)
Di server (Raspberry Pi), filter log:

```bash
docker logs --since 2h hotspot_prod_flask_backend | egrep -a 'POST /api/auth/(request-otp|verify-otp)'
```

Jika OTP terkirim tapi verify-otp tidak ada, berarti masalah di client/submit.

## 5) Dev: Mixed Content HMR (HTTPS page → ws:// blocked)

### Gejala
Saat membuka dev melalui domain HTTPS, browser menolak HMR karena Vite mencoba konek ke `ws://...`.

### Solusi
- Jangan memaksa default HMR `ws` pada config.
- Biarkan Vite meng-derive protocol dari `window.location` (HTTPS → WSS).
- Untuk skenario remote dev, gunakan env `VITE_HMR_*` untuk override.

Commit terkait:
- `e646c753` (frontend) juga mencakup penyesuaian HMR.

## 6) Backend formatting massal

### Tujuan
Meratakan format kode backend agar konsisten dan mengurangi noise lint.

Commit terkait:
- `92e287e8` style: ruff format backend

## 7) Logging tambahan: OTP/device-binding

### Tujuan
Memperjelas perbedaan:
- OTP invalid/expired (biasanya 401)
- OTP valid tetapi akses ditolak policy device-binding (biasanya 403)

Commit terkait:
- `22b443bf` chore: log otp device-binding denials

## 8) Checklist Deploy/Redeploy (Raspberry Pi)

### Konsep penting
Pada produksi berbasis Docker Hub image `:latest`, perubahan Git baru aktif di Pi **setelah image baru selesai dibuild & dipull**.

### Verifikasi image terbaru
```bash
docker image inspect babahdigital/sobigidul_frontend:latest --format 'id={{.Id}} created={{.Created}}'
docker image inspect babahdigital/sobigidul_backend:latest --format 'id={{.Id}} created={{.Created}}'
```

Jika timestamp masih lama, tunggu workflow publish selesai lalu `pull` ulang.

### Redeploy aman (tanpa hapus DB)
```bash
cd /home/abdullah/sobigidul
docker compose --env-file .env.prod -f docker-compose.prod.yml pull
docker compose --env-file .env.prod -f docker-compose.prod.yml up -d
docker compose -f docker-compose.prod.yml ps
```

Healthcheck (jika port 80 tidak publish ke host):
```bash
docker compose --env-file .env.prod -f docker-compose.prod.yml exec -T nginx wget -qO- http://127.0.0.1/api/ping
```

## Appendix — Commit penting (urut terbaru → lama)

- `e646c753` fix(frontend): otp input sanitize + dashboard debt table
- `92e287e8` style: ruff format backend
- `22b443bf` chore: log otp device-binding denials
- `062ed7d0` Dashboard: use Time Spendings card for debt/quota; add vue-tsc for typecheck
- `56d7c35e` UI: remove access history, add Telegram card; fix dev HMR; add debt Rp estimate
- `f024e323` Manual debt credits quota; expose quota debt breakdown; add debt/revenue estimates to reports
- `3228ef96` Admin reset-login: clear tokens/devices + Mikrotik cookies (historis); format debt units in templates
- `16d544fe` admin: add reset login tool + walled-garden robustness
