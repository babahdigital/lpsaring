name: ci

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      frontend_build: ${{ steps.filter.outputs.frontend_build }}
      docker: ${{ steps.filter.outputs.docker }}
      ci: ${{ steps.filter.outputs.ci }}
      contracts: ${{ steps.filter.outputs.contracts }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            frontend_build:
              - 'frontend/app.vue'
              - 'frontend/nuxt.config.ts'
              - 'frontend/package.json'
              - 'frontend/pnpm-lock.yaml'
              - 'frontend/pages/**'
              - 'frontend/components/**'
              - 'frontend/layouts/**'
              - 'frontend/middleware/**'
              - 'frontend/plugins/**'
              - 'frontend/store/**'
              - 'frontend/composables/**'
              - 'frontend/utils/**'
              - 'frontend/types/**'
              - 'frontend/@core/**'
              - 'frontend/@layouts/**'
            docker:
              - 'docker-compose*.yml'
              - 'backend/Dockerfile*'
              - 'frontend/Dockerfile*'
            ci:
              - '.github/workflows/**'
            contracts:
              - 'contracts/openapi/**'
              - 'frontend/types/api/contracts.ts'
            docs:
              - 'docs/API_DETAIL.md'
              - 'docs/OPENAPI_CONTRACT_WORKFLOW.md'
      - name: Show change summary
        run: |
          echo "backend=${{ steps.filter.outputs.backend }}"
          echo "frontend=${{ steps.filter.outputs.frontend }}"
          echo "frontend_build=${{ steps.filter.outputs.frontend_build }}"
          echo "docker=${{ steps.filter.outputs.docker }}"
          echo "ci=${{ steps.filter.outputs.ci }}"
          echo "contracts=${{ steps.filter.outputs.contracts }}"
          echo "docs=${{ steps.filter.outputs.docs }}"
          {
            echo "### Path Change Summary"
            echo "- backend: ${{ steps.filter.outputs.backend }}"
            echo "- frontend: ${{ steps.filter.outputs.frontend }}"
            echo "- frontend_build: ${{ steps.filter.outputs.frontend_build }}"
            echo "- docker: ${{ steps.filter.outputs.docker }}"
            echo "- ci: ${{ steps.filter.outputs.ci }}"
            echo "- contracts: ${{ steps.filter.outputs.contracts }}"
            echo "- docs: ${{ steps.filter.outputs.docs }}"
          } >> "$GITHUB_STEP_SUMMARY"

  contract-gate:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.contracts == 'true' || needs.changes.outputs.docs == 'true' || needs.changes.outputs.ci == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: API quality gate (OpenAPI integrity + generated sync)
        run: |
          python scripts/api_quality_gate.py
      - name: Access status parity gate (FE/BE/docs)
        run: |
          python scripts/access_status_parity_gate.py
      - name: Contract gate (OpenAPI + typed contract + API detail)
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.before }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          python scripts/contract_gate.py --base "$BASE_SHA" --head "$HEAD_SHA"

  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.ci == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.lock.txt
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.lock.txt
      - name: Dependency hygiene gate
        run: |
          python backend/scripts/refresh_lock_and_validate.py --skip-tests
      - name: Lint backend
        run: |
          python -m ruff check backend
      - name: Run backend tests
        run: |
          python -m pytest backend/tests --ignore=backend/tests/test_whatsapp_send.py

  frontend:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' || needs.changes.outputs.ci == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Enable corepack
        run: corepack enable
      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install
      - name: Prod config hygiene (dev bypass must be empty on release build)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          if [ -n "${NUXT_PUBLIC_DEV_BYPASS_TOKEN:-}" ]; then
            echo "ERROR: NUXT_PUBLIC_DEV_BYPASS_TOKEN terisi pada build release."
            exit 1
          fi
      - name: UI standards gate (no runtime import from Vuexy full-version)
        run: python3 scripts/enforce_ui_standards.py
      - name: Lint frontend
        working-directory: frontend
        run: pnpm run lint
      - name: Typecheck frontend
        working-directory: frontend
        run: pnpm run typecheck
      - name: Publish focused frontend test manifest
        run: |
          TEST_FILES="tests/auth-access.test.ts tests/auth-guards.test.ts tests/access-status-parity.contract.test.ts tests/payment-composables.test.ts tests/payment-status-polling.test.ts"
          echo "FOCUSED_FRONTEND_TESTS=$TEST_FILES" >> "$GITHUB_ENV"
          {
            echo "### Frontend Focused Tests"
            for t in $TEST_FILES; do
              echo "- $t"
            done
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Run focused frontend unit tests (auth + payment)
        working-directory: frontend
        run: pnpm run test -- $FOCUSED_FRONTEND_TESTS
      - name: Build frontend
        if: ${{ github.event_name == 'push' || needs.changes.outputs.frontend_build == 'true' || needs.changes.outputs.ci == 'true' }}
        working-directory: frontend
        run: pnpm run build
      - name: Skip build (PR non-runtime changes)
        if: ${{ github.event_name != 'push' && needs.changes.outputs.frontend_build != 'true' && needs.changes.outputs.ci != 'true' }}
        run: |
          echo "Frontend build skipped: no runtime-critical frontend changes in this PR."
          echo "Build will still run on push to main." >> "$GITHUB_STEP_SUMMARY"

  docker-build:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.docker == 'true' || needs.changes.outputs.ci == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: backend
            context: ./backend
          - name: frontend
            context: ./frontend
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build ${{ matrix.name }} image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: false
          load: false
          tags: local/${{ matrix.name }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
