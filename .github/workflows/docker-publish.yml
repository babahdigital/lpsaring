# Nama workflow yang akan muncul di tab Actions di GitHub
name: Build and Push Multi-arch Docker Images

# Pemicu workflow: dijalankan setiap kali ada push ke branch 'main'
on:
  push:
    branches: [ "main" ]
  # Memungkinkan Anda menjalankan workflow ini secara manual dari tab Actions
  workflow_dispatch:

jobs:
  # Job pertama untuk membangun image backend
  build-backend:
    name: Build and Push Backend Image
    # Menjalankan job di virtual machine Ubuntu terbaru dari GitHub
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout kode dari repositori Anda
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup QEMU untuk emulasi arsitektur (diperlukan untuk build multi-arch)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 3. Setup Docker Buildx, ini adalah builder yang bisa membuat image multi-arch
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Login ke Docker Hub menggunakan kredensial yang disimpan di GitHub Secrets
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Build dan push image backend ke Docker Hub
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend  # Lokasi Dockerfile untuk backend
          platforms: linux/amd64,linux/arm64 # Target arsitektur
          push: true # Mendorong image ke registry setelah build
          tags: babahdigital/sobigidul_backend:latest # Tag untuk image

  # Job kedua untuk membangun image frontend
  build-frontend:
    name: Build and Push Frontend Image
    # Menjalankan job di virtual machine Ubuntu terbaru dari GitHub
    runs-on: ubuntu-latest
    # Job ini berjalan secara paralel dengan job backend
    steps:
      # 1. Checkout kode dari repositori Anda
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup QEMU
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 3. Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Login ke Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Build dan push image frontend ke Docker Hub
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend # Lokasi Dockerfile untuk frontend
          platforms: linux/amd64,linux/arm64 # Target arsitektur
          push: true # Mendorong image ke registry setelah build
          tags: babahdigital/sobigidul_frontend:latest # Tag untuk image