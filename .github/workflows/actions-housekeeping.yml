name: Actions Housekeeping

on:
  schedule:
    - cron: "15 2 * * *"
  workflow_dispatch:
    inputs:
      keep_runs:
        description: "Keep latest completed workflow runs"
        required: false
        default: "20"
      keep_caches:
        description: "Keep latest Actions caches"
        required: false
        default: "80"

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        env:
          KEEP_RUNS: ${{ inputs.keep_runs || '20' }}
        with:
          script: |
            const keepRuns = Math.max(parseInt(process.env.KEEP_RUNS || '20', 10), 1)
            const owner = context.repo.owner
            const repo = context.repo.repo

            const allRuns = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              { owner, repo, per_page: 100 }
            )

            const activeRuns = allRuns.filter(run => run.status !== 'completed')
            const completedRuns = allRuns
              .filter(run => run.status === 'completed')
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))

            const deleteCandidates = completedRuns.slice(keepRuns)
            let deleted = 0
            let failed = 0

            for (const run of deleteCandidates) {
              try {
                await github.rest.actions.deleteWorkflowRun({
                  owner,
                  repo,
                  run_id: run.id,
                })
                deleted += 1
              } catch (error) {
                failed += 1
                core.warning(`Failed deleting run ${run.id}: ${error.message}`)
              }
            }

            core.notice(
              `Runs cleanup: total=${allRuns.length}, active_kept=${activeRuns.length}, completed_kept=${Math.min(completedRuns.length, keepRuns)}, deleted=${deleted}, failed=${failed}`
            )

      - name: Cleanup old Actions caches
        uses: actions/github-script@v7
        env:
          KEEP_CACHES: ${{ inputs.keep_caches || '80' }}
        with:
          script: |
            const keepCaches = Math.max(parseInt(process.env.KEEP_CACHES || '80', 10), 0)
            const owner = context.repo.owner
            const repo = context.repo.repo

            const allCaches = await github.paginate(
              'GET /repos/{owner}/{repo}/actions/caches',
              { owner, repo, per_page: 100 },
              (response) => response.data.actions_caches
            )

            const sortedCaches = allCaches
              .slice()
              .sort((a, b) => new Date(b.last_accessed_at) - new Date(a.last_accessed_at))

            const deleteCandidates = sortedCaches.slice(keepCaches)
            let deleted = 0
            let failed = 0

            for (const cache of deleteCandidates) {
              try {
                await github.request('DELETE /repos/{owner}/{repo}/actions/caches/{cache_id}', {
                  owner,
                  repo,
                  cache_id: cache.id,
                })
                deleted += 1
              } catch (error) {
                failed += 1
                core.warning(`Failed deleting cache ${cache.id}: ${error.message}`)
              }
            }

            core.notice(
              `Cache cleanup: total=${allCaches.length}, kept=${Math.min(allCaches.length, keepCaches)}, deleted=${deleted}, failed=${failed}`
            )
