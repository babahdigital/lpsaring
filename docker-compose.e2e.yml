# E2E compose (standalone): jalankan stack terpisah agar tidak mengganggu container dev.
# Pakai dengan:
#   docker compose -f docker-compose.e2e.yml -p hotspot-portal-e2e up -d
# Akses utama:
#   http://localhost:8089
#
# Catatan port (hindari bentrok dev):
# - Backend:  5011 -> container 5010
# - Frontend: 3011 -> container 3010
# - Nginx:    8089 -> container 80

name: hotspot-portal-e2e

services:
  db:
    image: postgres:15
    container_name: hotspot_postgres_db_e2e
    environment:
      POSTGRES_DB: hotspot_e2e_db
      POSTGRES_USER: hotspot_e2e_user
      POSTGRES_PASSWORD: hotspot_e2e_password
    volumes:
      - postgres_data_e2e:/var/lib/postgresql/data
    networks:
      - hotspot_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-hotspot_e2e_user} -d $${POSTGRES_DB:-hotspot_e2e_db} -q"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: hotspot_redis_cache_e2e
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data_e2e:/data
    networks:
      - hotspot_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hotspot_flask_backend_e2e
    env_file:
      - ./backend/.env.e2e
    environment:
      # E2E lokal: fokus flow/arsitektur, jangan benar-benar kirim WhatsApp
      ENABLE_WHATSAPP_NOTIFICATIONS: "False"
      # Pastikan OTP bypass bisa dipakai oleh script E2E
      OTP_ALLOW_BYPASS: "True"
      OTP_BYPASS_CODE: "000000"
    volumes:
      - ./backend:/app
      - backups_e2e:/app/backups
    ports:
      - "5011:5010"
    command:
      - "gunicorn"
      - "--bind"
      - "0.0.0.0:5010"
      - "run:app"
      - "--reload"
      - "--workers=4"
      - "--timeout=60"
      - "--log-level=info"
      - "--access-logfile"
      - "-"
      - "--error-logfile"
      - "-"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - hotspot_network
    restart: unless-stopped

  migrate:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hotspot_flask_migrate_e2e
    env_file:
      - ./backend/.env.e2e
    volumes:
      - ./backend:/app
    command: python -m flask db upgrade
    depends_on:
      db:
        condition: service_healthy
    networks:
      - hotspot_network
    restart: "no"

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hotspot_celery_worker_e2e
    env_file:
      - ./backend/.env.e2e
    environment:
      ENABLE_WHATSAPP_NOTIFICATIONS: "False"
    volumes:
      - ./backend:/app
    command: celery -A app.extensions.celery_app worker --loglevel=info
    depends_on:
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - hotspot_network
    restart: unless-stopped

  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hotspot_celery_beat_e2e
    env_file:
      - ./backend/.env.e2e
    environment:
      ENABLE_WHATSAPP_NOTIFICATIONS: "False"
    volumes:
      - ./backend:/app
    command: celery -A app.extensions.celery_app beat --loglevel=info
    depends_on:
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - hotspot_network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: hotspot_nuxt_frontend_e2e
    env_file:
      - ./frontend/.env.${APP_ENV:-local}
    environment:
      HOST: "0.0.0.0"
      PORT: 3010
      BROWSERSLIST_IGNORE_OLD_DATA: "1"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.nuxt
    ports:
      - "3011:3010"
    stop_signal: SIGINT
    stop_grace_period: 30s
    command: pnpm run dev
    networks:
      - hotspot_network
    restart: unless-stopped

  nginx:
    image: nginx:stable-alpine
    container_name: hotspot_nginx_proxy_e2e
    ports:
      - "8089:80"
    volumes:
      - ./infrastructure/nginx/conf.d/app.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infrastructure/nginx/logs:/var/log/nginx
    depends_on:
      backend:
        condition: service_started
    networks:
      - hotspot_network
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: hotspot_cloudflared_e2e
    command: tunnel --no-autoupdate --protocol http2 --config /etc/cloudflared/config.yml run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN}
    volumes:
      - ./infrastructure/cloudflared/config.yml:/etc/cloudflared/config.yml:ro
    depends_on:
      nginx:
        condition: service_started
    networks:
      - hotspot_network
    restart: unless-stopped
    profiles:
      - tunnel

volumes:
  postgres_data_e2e:
    driver: local
  redis_data_e2e:
    driver: local
  backups_e2e:
    driver: local

networks:
  hotspot_network:
    name: hotspot_portal_net_e2e
