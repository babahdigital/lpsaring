openapi: 3.0.3
info:
  title: Lpsaring API Contract
  version: 1.0.0
  description: |
    Source of truth kontrak API domain prioritas (Auth, Profile, Devices, Transactions).
    Ruang lingkup ini sengaja fokus untuk mengurangi drift backend-frontend pada flow kritikal.
    Revisi internal 2026-02-26: refactor wiring transaksi/payment tanpa perubahan signature endpoint.
servers:
  - url: /api
    description: Relative API base path

tags:
  - name: Auth
  - name: Profile
  - name: Devices
  - name: Transactions
  - name: AdminUsers
  - name: AdminTransactions
  - name: AdminSettings
  - name: AdminRequests
  - name: AdminMetrics

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register user baru
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRegisterRequest'
      responses:
        '201':
          description: User berhasil dibuat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthRegisterResponse'
        '409':
          $ref: '#/components/responses/ErrorConflict'
        '422':
          $ref: '#/components/responses/ErrorValidation'

  /auth/request-otp:
    post:
      tags: [Auth]
      summary: Request OTP ke WhatsApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequestOtpRequest'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/AuthRequestOtpRequest'
      responses:
        '200':
          description: OTP berhasil dikirim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '429':
          $ref: '#/components/responses/ErrorRateLimit'

  /auth/verify-otp:
    post:
      tags: [Auth]
      summary: Verifikasi OTP dan login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthVerifyOtpRequest'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/AuthVerifyOtpRequest'
      responses:
        '200':
          description: OTP valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthVerifyOtpResponse'
        '400':
          $ref: '#/components/responses/ErrorBadRequest'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /auth/auto-login:
    post:
      tags: [Auth]
      summary: Auto login berbasis context captive (IP/MAC)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthAutoLoginRequest'
      responses:
        '200':
          description: Auto login berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthVerifyOtpResponse'
        '400':
          $ref: '#/components/responses/ErrorBadRequest'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /auth/admin/login:
    post:
      tags: [Auth]
      summary: Login admin via username dan password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Login admin berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthVerifyOtpResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /auth/status-token/verify:
    post:
      tags: [Auth]
      summary: Verifikasi signature status page token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusTokenVerifyRequest'
      responses:
        '200':
          description: Hasil verifikasi token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusTokenVerifyResponse'
        '400':
          $ref: '#/components/responses/ErrorBadRequest'
        '422':
          $ref: '#/components/responses/ErrorValidation'

  /auth/session/consume:
    post:
      tags: [Auth]
      summary: Consume session token (cross-device login handoff)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
      responses:
        '200':
          description: Session token valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthVerifyOtpResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /auth/me:
    get:
      tags: [Auth]
      summary: Profil user login
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserMeResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /auth/hotspot-session-status:
    get:
      tags: [Auth]
      summary: Status sesi hotspot realtime untuk user login
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: Status hotspot saat ini
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthHotspotSessionStatusResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /auth/me/profile:
    put:
      tags: [Auth]
      summary: Update profil user saat ini
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
      responses:
        '200':
          description: Profil terupdate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserMeResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '422':
          $ref: '#/components/responses/ErrorValidation'

  /users/me/profile:
    get:
      tags: [Profile]
      summary: Ambil profil user (namespace /users)
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserMeResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
    put:
      tags: [Profile]
      summary: Update profil user (namespace /users)
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
      responses:
        '200':
          description: Profil terupdate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserMeResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '422':
          $ref: '#/components/responses/ErrorValidation'

  /users/me/quota-debts:
    get:
      tags: [Profile]
      summary: List manual quota debt milik user saat ini
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [open, all]
      responses:
        '200':
          description: List quota debt user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserQuotaDebtListResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /users/me/devices:
    get:
      tags: [Devices]
      summary: List perangkat user
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: Device list
          content:
            application/json:
              schema:
                type: object
                required: [devices]
                properties:
                  devices:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserDevice'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /users/me/devices/bind-current:
    post:
      tags: [Devices]
      summary: Bind perangkat current context
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: query
          name: best_effort
          schema:
            type: boolean
          description: Jika true, kegagalan bind dibalas 200 success=false (bukan 403)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                client_ip:
                  type: string
                client_mac:
                  type: string
      responses:
        '200':
          description: Bind result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceBindResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /users/me/devices/{device_id}/label:
    put:
      tags: [Devices]
      summary: Update label perangkat
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: device_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [label]
              properties:
                label:
                  type: string
      responses:
        '200':
          description: Label updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /users/me/devices/{device_id}:
    delete:
      tags: [Devices]
      summary: Hapus perangkat user
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: device_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Device revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /transactions/initiate:
    post:
      tags: [Transactions]
      summary: Initiate pembelian paket
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionInitiateRequest'
      responses:
        '200':
          description: Initiate success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionInitiateResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '422':
          $ref: '#/components/responses/ErrorValidation'

  /transactions/debt/initiate:
    post:
      tags: [Transactions]
      summary: Initiate pelunasan debt
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionDebtInitiateRequest'
      responses:
        '200':
          description: Debt initiate success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionInitiateResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /transactions/by-order-id/{order_id}:
    get:
      tags: [Transactions]
      summary: Detail transaksi authenticated
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transaction detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetailResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'

  /transactions/public/by-order-id/{order_id}:
    get:
      tags: [Transactions]
      summary: Detail transaksi public (signed token)
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
        - in: query
          name: t
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transaction detail (masked)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetailResponsePublic'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'

  /transactions/{order_id}/cancel:
    post:
      tags: [Transactions]
      summary: Cancel transaksi authenticated
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cancel result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionCancelResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /transactions/public/{order_id}/cancel:
    post:
      tags: [Transactions]
      summary: Cancel transaksi public (signed token)
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
        - in: query
          name: t
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cancel result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionCancelResponse'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /transactions/{order_id}/qr:
    get:
      tags: [Transactions]
      summary: QR proxy authenticated
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
        - in: query
          name: download
          required: false
          schema:
            type: boolean
      responses:
        '200':
          description: QR binary
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/svg+xml:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'

  /transactions/public/{order_id}/qr:
    get:
      tags: [Transactions]
      summary: QR proxy public (signed token)
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
        - in: query
          name: t
          required: true
          schema:
            type: string
        - in: query
          name: download
          required: false
          schema:
            type: boolean
      responses:
        '200':
          description: QR binary
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/svg+xml:
              schema:
                type: string
                format: binary
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /admin/users:
    get:
      tags: [AdminUsers]
      summary: List users (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          required: false
          schema:
            type: integer
        - in: query
          name: per_page
          required: false
          schema:
            type: integer
        - in: query
          name: search
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Paged users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUserListResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
    post:
      tags: [AdminUsers]
      summary: Create user (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminUserCreateRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUserMutationResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '422':
          $ref: '#/components/responses/ErrorValidation'

  /admin/users/{user_id}:
    put:
      tags: [AdminUsers]
      summary: Update user (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: user_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminUserUpdateRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUserMutationResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'

  /admin/settings:
    get:
      tags: [AdminSettings]
      summary: Get settings (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: Settings list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminSettingsListResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
    put:
      tags: [AdminSettings]
      summary: Update settings (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminSettingsUpdateRequest'
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /admin/quota-requests:
    get:
      tags: [AdminRequests]
      summary: List quota requests (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: query
          name: status
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Quota request list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuotaRequestListResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /admin/quota-requests/{request_id}/process:
    post:
      tags: [AdminRequests]
      summary: Process quota request (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: request_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminQuotaRequestProcessRequest'
      responses:
        '200':
          description: Request processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'

  /admin/transactions:
    get:
      tags: [AdminTransactions]
      summary: List transactions (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          required: false
          schema:
            type: integer
        - in: query
          name: per_page
          required: false
          schema:
            type: integer
        - in: query
          name: status
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Paged transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminTransactionListResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /admin/transactions/bill:
    post:
      tags: [AdminTransactions]
      summary: Buat tagihan transaksi untuk user tertentu
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminTransactionBillRequest'
      responses:
        '201':
          description: Tagihan berhasil dibuat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminTransactionBillResponse'
        '400':
          $ref: '#/components/responses/ErrorBadRequest'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'

  /admin/transactions/{order_id}/detail:
    get:
      tags: [AdminTransactions]
      summary: Transaction detail (admin)
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transaction detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetailResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'

  /admin/metrics:
    get:
      tags: [AdminMetrics]
      summary: Ambil metrik reliabilitas admin
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: Ringkasan metrik reliabilitas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminMetricsResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'

  /admin/metrics/access-parity:
    get:
      tags: [AdminMetrics]
      summary: Deteksi mismatch policy app vs MikroTik per device
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: Daftar mismatch parity akses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAccessParityResponse'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '503':
          $ref: '#/components/responses/ErrorBadRequest'

  /admin/metrics/access-parity/fix:
    post:
      tags: [AdminMetrics]
      summary: Paksa sinkronisasi parity untuk satu item mismatch
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminAccessParityFixRequest'
      responses:
        '200':
          description: Eksekusi parity fix berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAccessParityFixResponse'
        '400':
          $ref: '#/components/responses/ErrorBadRequest'
        '401':
          $ref: '#/components/responses/ErrorUnauthorized'
        '403':
          $ref: '#/components/responses/ErrorForbidden'
        '404':
          $ref: '#/components/responses/ErrorNotFound'
        '502':
          $ref: '#/components/responses/ErrorBadRequest'
        '503':
          $ref: '#/components/responses/ErrorBadRequest'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token

  responses:
    ErrorBadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ErrorUnauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ErrorForbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ErrorNotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ErrorConflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ErrorRateLimit:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ErrorValidation:
      description: Validation failed
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/ErrorResponse'
              - type: object
                properties:
                  details:
                    type: array
                    items:
                      $ref: '#/components/schemas/ValidationErrorDetail'

  schemas:
    MessageResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          description: Stable machine-readable error code
          example: AUTH_UNAUTHORIZED
        message:
          type: string
        details:
          type: array
          items:
            $ref: '#/components/schemas/ValidationErrorDetail'
        request_id:
          type: string

    ValidationErrorDetail:
      type: object
      properties:
        loc:
          type: array
          items:
            oneOf:
              - type: string
              - type: integer
        msg:
          type: string
        type:
          type: string

    AuthRegisterRequest:
      type: object
      required: [phone_number, full_name]
      properties:
        phone_number:
          type: string
        full_name:
          type: string
          minLength: 2
        blok:
          type: string
          nullable: true
        kamar:
          type: string
          nullable: true
        is_tamping:
          type: boolean
          default: false
        tamping_type:
          type: string
          nullable: true
        register_as_komandan:
          type: boolean
          default: false

    AuthRegisterResponse:
      type: object
      required: [message, user_id, phone_number]
      properties:
        message:
          type: string
        user_id:
          type: string
          format: uuid
        phone_number:
          type: string

    AuthRequestOtpRequest:
      type: object
      required: [phone_number]
      properties:
        phone_number:
          type: string

    AuthVerifyOtpRequest:
      type: object
      required: [phone_number, otp]
      properties:
        phone_number:
          type: string
        otp:
          type: string
          minLength: 6
          maxLength: 6
        client_ip:
          type: string
          nullable: true
        client_mac:
          type: string
          nullable: true
        hotspot_login_context:
          type: boolean
          nullable: true
        confirm_device_takeover:
          type: boolean
          nullable: true

    AuthAutoLoginRequest:
      type: object
      properties:
        client_ip:
          type: string
          nullable: true
        client_mac:
          type: string
          nullable: true

    StatusTokenVerifyRequest:
      type: object
      required: [status, token]
      properties:
        status:
          type: string
        token:
          type: string

    StatusTokenVerifyResponse:
      type: object
      required: [valid]
      properties:
        valid:
          type: boolean

    AuthVerifyOtpResponse:
      type: object
      required: [access_token, token_type]
      properties:
        access_token:
          type: string
        token_type:
          type: string
        hotspot_login_required:
          type: boolean
          nullable: true
        hotspot_binding_active:
          type: boolean
          nullable: true
        hotspot_session_active:
          type: boolean
          nullable: true
          deprecated: true
        hotspot_username:
          type: string
          nullable: true
        hotspot_password:
          type: string
          nullable: true
        session_token:
          type: string
          nullable: true
        session_url:
          type: string
          nullable: true

    AuthHotspotSessionStatusResponse:
      type: object
      required: [hotspot_login_required]
      properties:
        hotspot_login_required:
          type: boolean
        hotspot_binding_active:
          type: boolean
          nullable: true
        hotspot_session_active:
          type: boolean
          nullable: true
          deprecated: true

    UserMeResponse:
      type: object
      required: [id, phone_number, full_name, role, approval_status, is_active]
      properties:
        id:
          type: string
          format: uuid
        phone_number:
          type: string
        full_name:
          type: string
        blok:
          type: string
          nullable: true
        kamar:
          type: string
          nullable: true
        is_tamping:
          type: boolean
          nullable: true
        tamping_type:
          type: string
          nullable: true
        role:
          type: string
          enum: [USER, KOMANDAN, ADMIN, SUPER_ADMIN]
        approval_status:
          type: string
          enum: [PENDING_APPROVAL, APPROVED, REJECTED]
        is_active:
          type: boolean
        is_unlimited_user:
          type: boolean
          nullable: true
        total_quota_purchased_mb:
          type: number
          nullable: true
        total_quota_used_mb:
          type: number
          nullable: true
        quota_expiry_date:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
        approved_at:
          type: string
          format: date-time
          nullable: true
        last_login_at:
          type: string
          format: date-time
          nullable: true

    UserProfileUpdateRequest:
      type: object
      properties:
        full_name:
          type: string
        blok:
          type: string
          nullable: true
        kamar:
          type: string
          nullable: true
        is_tamping:
          type: boolean
          nullable: true
        tamping_type:
          type: string
          nullable: true

    UserDevice:
      type: object
      required: [id, mac_address, is_authorized]
      properties:
        id:
          type: string
          format: uuid
        mac_address:
          type: string
        ip_address:
          type: string
          nullable: true
        label:
          type: string
          nullable: true
        is_authorized:
          type: boolean
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
        last_seen_at:
          type: string
          format: date-time
          nullable: true

    DeviceBindResponse:
      type: object
      required: [success, message]
      properties:
        success:
          type: boolean
        message:
          type: string
        device:
          $ref: '#/components/schemas/UserDevice'

    UserQuotaDebtItem:
      type: object
      required: [id, amount_mb, paid_mb, remaining_mb, is_paid]
      properties:
        id:
          type: string
          format: uuid
        debt_date:
          type: string
          format: date
          nullable: true
        amount_mb:
          type: integer
        paid_mb:
          type: integer
        remaining_mb:
          type: integer
        is_paid:
          type: boolean
        paid_at:
          type: string
          format: date-time
          nullable: true
        note:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true

    UserQuotaDebtListResponse:
      type: object
      required: [success, items]
      properties:
        success:
          type: boolean
        items:
          type: array
          items:
            $ref: '#/components/schemas/UserQuotaDebtItem'

    TransactionInitiateRequest:
      type: object
      required: [package_id]
      properties:
        package_id:
          type: string
          format: uuid
        payment_method:
          type: string
          enum: [qris, gopay, va, shopeepay]
          nullable: true
        va_bank:
          type: string
          enum: [bca, bni, bri, mandiri, permata, cimb]
          nullable: true

    TransactionDebtInitiateRequest:
      type: object
      properties:
        payment_method:
          type: string
          enum: [qris, gopay, va, shopeepay]
          nullable: true
        va_bank:
          type: string
          enum: [bca, bni, bri, mandiri, permata, cimb]
          nullable: true
        manual_debt_id:
          type: string
          nullable: true

    TransactionInitiateResponse:
      type: object
      required: [order_id, provider_mode]
      properties:
        order_id:
          type: string
        snap_token:
          type: string
          nullable: true
        redirect_url:
          type: string
          nullable: true
        provider_mode:
          type: string
          enum: [snap, core_api]
        status_token:
          type: string
          nullable: true
        status_url:
          type: string
          nullable: true

    TransactionPackageSummary:
      type: object
      nullable: true
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        price:
          type: number
          nullable: true
        data_quota_gb:
          type: number
          nullable: true
        is_unlimited:
          type: boolean
          nullable: true

    TransactionUserSummary:
      type: object
      nullable: true
      properties:
        id:
          type: string
          nullable: true
        phone_number:
          type: string
          nullable: true
        full_name:
          type: string
          nullable: true
        quota_expiry_date:
          type: string
          format: date-time
          nullable: true
        is_unlimited_user:
          type: boolean
          nullable: true

    TransactionDetailResponse:
      type: object
      required: [id, midtrans_order_id, status]
      properties:
        id:
          type: string
          format: uuid
        midtrans_order_id:
          type: string
        midtrans_transaction_id:
          type: string
          nullable: true
        status:
          type: string
          enum: [SUCCESS, PENDING, FAILED, EXPIRED, CANCELLED, ERROR, UNKNOWN]
        purpose:
          type: string
          enum: [purchase, debt]
          nullable: true
        debt_type:
          type: string
          enum: [auto, manual]
          nullable: true
        debt_mb:
          type: integer
          nullable: true
        debt_note:
          type: string
          nullable: true
        amount:
          type: number
          nullable: true
        payment_method:
          type: string
          nullable: true
        snap_token:
          type: string
          nullable: true
        snap_redirect_url:
          type: string
          nullable: true
        deeplink_redirect_url:
          type: string
          nullable: true
        payment_time:
          type: string
          format: date-time
          nullable: true
        expiry_time:
          type: string
          format: date-time
          nullable: true
        va_number:
          type: string
          nullable: true
        payment_code:
          type: string
          nullable: true
        biller_code:
          type: string
          nullable: true
        qr_code_url:
          type: string
          nullable: true
        hotspot_password:
          type: string
          nullable: true
        package:
          $ref: '#/components/schemas/TransactionPackageSummary'
        user:
          $ref: '#/components/schemas/TransactionUserSummary'

    TransactionDetailResponsePublic:
      allOf:
        - $ref: '#/components/schemas/TransactionDetailResponse'
        - type: object
          properties:
            hotspot_password:
              type: string
              nullable: true
              example: null

    TransactionCancelResponse:
      type: object
      required: [success, status]
      properties:
        success:
          type: boolean
        status:
          type: string
        message:
          type: string
          nullable: true

    AdminUserListItem:
      allOf:
        - $ref: '#/components/schemas/UserMeResponse'
        - type: object
          properties:
            profile_name:
              type: string
              nullable: true
            quota_debt_total_mb:
              type: number
              nullable: true

    PaginationMeta:
      type: object
      required: [page, per_page, total]
      properties:
        page:
          type: integer
        per_page:
          type: integer
        total:
          type: integer

    AdminUserListResponse:
      type: object
      required: [items, meta]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminUserListItem'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    AdminUserCreateRequest:
      type: object
      required: [phone_number, full_name]
      properties:
        phone_number:
          type: string
        full_name:
          type: string
        role:
          type: string
          enum: [USER, KOMANDAN, ADMIN, SUPER_ADMIN]
        blok:
          type: string
          nullable: true
        kamar:
          type: string
          nullable: true
        is_tamping:
          type: boolean
          nullable: true
        tamping_type:
          type: string
          nullable: true

    AdminUserUpdateRequest:
      type: object
      properties:
        full_name:
          type: string
        role:
          type: string
          enum: [USER, KOMANDAN, ADMIN, SUPER_ADMIN]
        is_active:
          type: boolean
        approval_status:
          type: string
          enum: [PENDING_APPROVAL, APPROVED, REJECTED]
        is_blocked:
          type: boolean
          nullable: true
        blocked_reason:
          type: string
          nullable: true
        blok:
          type: string
          nullable: true
        kamar:
          type: string
          nullable: true

    AdminUserMutationResponse:
      type: object
      required: [message, user]
      properties:
        message:
          type: string
        user:
          $ref: '#/components/schemas/UserMeResponse'

    SettingItem:
      type: object
      required: [key, value]
      properties:
        key:
          type: string
        value:
          oneOf:
            - type: string
            - type: number
            - type: boolean
          nullable: true
        description:
          type: string
          nullable: true

    AdminSettingsListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/SettingItem'

    AdminSettingsUpdateRequest:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            type: object
            required: [key, value]
            properties:
              key:
                type: string
              value:
                oneOf:
                  - type: string
                  - type: number
                  - type: boolean
                nullable: true

    AdminQuotaRequestItem:
      type: object
      required: [id, user_id, request_type, requested_at, status]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        request_type:
          type: string
          enum: [QUOTA, UNLIMITED]
        requested_mb:
          type: integer
          nullable: true
        requested_days:
          type: integer
          nullable: true
        status:
          type: string
          enum: [PENDING, APPROVED, REJECTED]
        note:
          type: string
          nullable: true
        requested_at:
          type: string
          format: date-time

    AdminQuotaRequestListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminQuotaRequestItem'

    AdminQuotaRequestProcessRequest:
      type: object
      required: [action]
      properties:
        action:
          type: string
          enum: [approve, reject]
        approved_mb:
          type: integer
          nullable: true
        approved_days:
          type: integer
          nullable: true
        note:
          type: string
          nullable: true

    AdminTransactionListResponse:
      type: object
      required: [items, meta]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TransactionDetailResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    AdminTransactionBillRequest:
      type: object
      required: [user_id, package_id]
      properties:
        user_id:
          type: string
          format: uuid
        package_id:
          type: string
          format: uuid
        payment_method:
          type: string
          enum: [qris, gopay, va, shopeepay]
          nullable: true
        va_bank:
          type: string
          enum: [bca, bni, bri, mandiri, permata, cimb]
          nullable: true

    AdminTransactionBillResponse:
      type: object
      required: [message, order_id, status]
      properties:
        message:
          type: string
        order_id:
          type: string
        status:
          type: string
        status_url:
          type: string
          nullable: true
        whatsapp_sent:
          type: boolean
          nullable: true

    AdminMetricsReliabilitySignals:
      type: object
      properties:
        payment_idempotency_degraded:
          type: boolean
        hotspot_sync_lock_degraded:
          type: boolean
        policy_parity_degraded:
          type: boolean

    AdminMetricsResponse:
      type: object
      properties:
        metrics:
          type: object
          additionalProperties:
            type: number
        reliability_signals:
          $ref: '#/components/schemas/AdminMetricsReliabilitySignals'

    AccessParityItem:
      type: object
      required: [user_id, phone_number, mac, app_status, expected_binding_type, address_list_statuses, mismatches]
      properties:
        user_id:
          type: string
          format: uuid
        phone_number:
          type: string
        mac:
          type: string
        ip:
          type: string
          nullable: true
        app_status:
          type: string
        expected_binding_type:
          type: string
        actual_binding_type:
          type: string
          nullable: true
        address_list_statuses:
          type: array
          items:
            type: string
        mismatches:
          type: array
          items:
            type: string

    AccessParitySummary:
      type: object
      required: [users, mismatches]
      properties:
        users:
          type: integer
        mismatches:
          type: integer

    AdminAccessParityResponse:
      type: object
      required: [items, summary]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AccessParityItem'
        summary:
          $ref: '#/components/schemas/AccessParitySummary'

    AdminAccessParityFixRequest:
      type: object
      required: [user_id]
      properties:
        user_id:
          type: string
          format: uuid
        mac:
          type: string
          nullable: true
        ip:
          type: string
          nullable: true

    AdminAccessParityFixResponse:
      type: object
      required: [message, user_id, expected_binding_type, binding_updated, address_list_synced]
      properties:
        message:
          type: string
        user_id:
          type: string
          format: uuid
        mac:
          type: string
          nullable: true
        resolved_ip:
          type: string
          nullable: true
        expected_binding_type:
          type: string
        binding_updated:
          type: boolean
        address_list_synced:
          type: boolean
